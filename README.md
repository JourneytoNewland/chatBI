# 🚀 ChatBI: 生产级智能问数系统

ChatBI 是一个基于 LLM、向量数据库和图数据库的准生产级智能问数系统。它能够将自然语言查询转换为精确的 SQL 并从 PostgreSQL 数据库中提取业务洞察，支持复杂的消歧、多维分析和对比计算。

## 🌟 核心突破 (准生产级)

- **100% 测试通过率**: 54 项端到端生产级测试全部通过，涵盖意图识别、SQL 生成及数据执行。
- **高鲁棒性消歧**: 内置 L1(精确)+L2(语义)+L3(LLM增强) 三层召回架构，完美区分相似指标（如“有效订单量” vs “订单量”）。
- **真实数据驱动**: 集成 PostgreSQL 17，内置 90 天真实业务历史数据支撑，摆脱 Mock 束缚。
- **全域指标库**: 预置 **50 个** 核心指标，覆盖电商、用户、财务、营销、内容、客服、库存 8 大领域。

---

## 🏗️ 系统架构

系统采用混合检索架构，确保查询的绝对准确性：

1.  **L1 精确匹配层**: 基于词边界和同义词词典，拦截 100% 匹配的指标名。
2.  **L2 语义召回层 (Qdrant)**: 当 L1 未命中时，使用向量搜索进行语义相似度匹配。
3.  **L3 知识图谱关联 (Neo4j)**: 结合领域上下文和关联关系进行多维召回。
4.  **意图解析 (ZhipuAI GLM-4)**: 提取时间、维度、过滤条件及对比动作。
5.  **SQL 生成 (SQLGeneratorV2)**: 生成符合 PostgreSQL 语法的生产级查询语句。

---

## � 指标覆盖规模

目前支持 **8 大业务领域** 的 50 个标准化指标：

- **� 电商/用户**: GMV、订单量、DAU、MAU、转化率、留存率、ARPU 等。
- **💰 财务**: ROI、毛利、净利、销售成本、运营费用等。
- **📢 营销 (新)**: 广告ROI、CPC、CPM、CPA、获客成本、点击量等。
- **📝 内容/客服 (新)**: 互动率、完播率、响应时长、解决率、退款率等。
- **📦 库存 (新)**: 周转率、缺货率、滞销率等。

---

## 🚀 快速开始

### 1. 环境准备
- **Python**: 3.9+
- **数据库**: PostgreSQL 17+, Neo4j, Qdrant

### 2. 数据库配置
在 `.env` 中配置您的连接信息：
```env
ZHIPUAI_API_KEY=your_key
POSTGRES_DB=chatbi
NEO4J_URI=bolt://localhost:7687
QDRANT_HOST=localhost
```

### 3. 运行服务器
```bash
python scripts/run_demo_server.py
```

### 4. 执行生产级性能测试
```bash
python scripts/test_production_suite_v2.py
```

---

## 📺 最终验证结果

| 测试类别 | 测试数 | 通过率 |
|---------|-------|--------|
| 图谱检索 (Neo4j) | 4 | 100% ✅ |
| 意图识别 (ZhipuAI) | 8 | 100% ✅ |
| SQL 生成精度 | 4 | 100% ✅ |
| E2E 对抗性测试 | 22 | 100% ✅ |
| **总计** | **54** | **100%** |

---

## � 交付文档
- [最终报告 (Walkthrough)](./brain/98034d01-b9dc-4eac-bca3-4c4a4abfa188/walkthrough.md)
- [对抗性消歧分析报告](./brain/98034d01-b9dc-4eac-bca3-4c4a4abfa188/adversarial_test_report.md)
- [数据库 Schema 设计方案](./database/migrations/V1__init_schema.sql)
