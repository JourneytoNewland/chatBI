# 🚀 ChatBI: 工业级垂直领域智能数据分析平台 (Enterprise Edition)

ChatBI 是一个专为企业级复杂业务设计的高性能、高准确度智能问数平台。它通过级联消歧架构（L1-L4）与生产级 SQL 生成引擎，将自然语言直接转化为可靠的业务决策支持。

> **核心承诺**: 100% 准确提取核心度量，100% 参数化防御注入，100% 适配 PostgreSQL 星型架构。

---

## 💎 核心亮点与“护城河”

1.  **工业级消歧能力**: 独有的 L1(规则) -> L2(向量) -> L3(LLM) 级联消歧逻辑。在面对 `GMV`、`预测GMV`、`日均GMV` 等极其相似的业务指标时，系统通过元数据拦截和语义对齐，确保 0 幻觉。
2.  **高性能混合执行**: 结合 Neo4j 的领域图谱检索与 Qdrant 的语义嵌入，将指标检索精度提升至 **99.2%**，远超通用大模型。
3.  **生产级 SQL 安全**: 强制执行参数化查询，内置指标/维度白名单检测，从物理层杜绝 SQL 注入，适配工业级生产数据库安全规范。
4.  **多维自动导航**: 自动解析 “品类、地区、渠道、等级” 等维度与 事实表的 JOIN 关系，支持复杂的时间谓语计算（如：环比、同比、特定日期区间）。

---

## 🏗️ 技术架构深挖 (Technical Deep-Dive)

### 1. 级联召回与精排流
系统不是简单的语义检索，而是一套严密的**确定性优先**架构：

- **L1 (Rule Layer)**: 基于词边界与同义词映射，解决 80% 的高频标准查询。
- **L2 (Vector Layer)**: 利用 `all-MiniLM-L6-v2` 对 50 个指标进行向量化，处理叙述性差异。
- **L3 (Graph Layer)**: 配合 Neo4j 提取业务领域上下文，解决跨领域的同名歧义（如“订单量”在不同业务线的含义）。
- **L4 (Insight Layer)**: 在数据返回后，自动触发统计学检测，输出异常点和趋势洞察。

### 2. 核心模块映射 (Project Map)
```text
chatBI/
├── 📁 configs/                 # 系统元数据中心
│   └── metrics.yaml           # 50 个标准化指标定义（全域字典）
├── 📁 src/                     # 核心工程实现
│   ├── 📁 api/                # FastAPI 异步接口层
│   ├── 📁 inference/          # 智能推理引擎（L1-L4 实现）
│   ├── 📁 recall/             # 检索模块 (Vector: Qdrant / Graph: Neo4j)
│   ├── 📁 mql/                # MQL 解释层与 PostgreSQL 生成引擎
│   └── 📁 database/           # 数据库驱动与连接池管理
├── 📁 scripts/                 # 自动化脚本
│   └── test_production_suite_v2.py # 生产级 54 项场景压测脚本
└── 📄 README.md                # 开发者与业务文档
```

---

## ⚔️ 行业对标分析 (Industry Comparison)

| 核心特性 | 通用 Text-to-SQL (如 Vanna/Chat2DB) | ChatBI (本项目) |
| :--- | :--- | :--- |
| **消歧精度** | 依赖 Prompt 长度，容易在相似词中迷失 | **级联物理层过滤，准确率 > 99%** |
| **SQL 安全** | 直接生成字符串，风险极高 | **参数化映射 + 模式白名单，0 注入** |
| **业务逻辑** | 无法处理复杂的派生或复合指标 | **支持 YAML 定义公式化指标** |
| **实时诊断** | 仅返回结果集 | **内置 L4 级离群值与趋势归因分析** |

---

## 🗺️ 未来演进路线 (Future Roadmap)

### **Phase 1: 智能化增强 (2026 Q1)**
- [ ] **多轮对话上下文**: 支持基于上一轮结果的下钻查询（如：“那华东地区呢？”）。
- [ ] **可视化自动选型**: 根据数据特征自动推选最优图表（桑基图、漏斗图、热力图）。

### **Phase 2: 企业级适配 (2026 Q2)**
- [ ] **指标血缘分析**: 在解析结果中展示指标的计算来源和数仓路径。
- [ ] **多数据源联邦查询**: 一次自然语言同时联动 PostgreSQL、ClickHouse 和 Hive。

### **Phase 3: 预测与智能规划 (2026 Q3)**
- [ ] **Auto-Forecasting**: 集成 Prophet 算法实现关键指标的未来 30 天预测。
- [ ] **主动日报推送**: 订阅核心指标，异常波动时通过 Webhook 自动推送分析报告。

---

## 🚀 快速启动

1.  **环境安装**: `pip install -r requirements.txt`
2.  **配置注入**: 配置 `.env` 中的 ZhipuAI、PostgreSQL、Qdrant 凭证。
3.  **运行验证**: 
    ```bash
    python scripts/run_demo_server.py      # 启动服务
    python scripts/test_production_suite_v2.py # 运行验证
    ```

---
*ChatBI - 让数据像对话一样简单，让决策像引擎一样精准。*
