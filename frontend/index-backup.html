<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½é—®æ•°ç³»ç»Ÿ - å¯è§†åŒ–æµ‹è¯•ç•Œé¢</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .loading {
            animation: pulse 1.5s ease-in-out infinite;
        }
        .step-card {
            transition: all 0.3s ease;
        }
        .step-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .feature-bar {
            transition: width 0.5s ease;
        }
        .score-badge {
            min-width: 60px;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- æ ‡é¢˜ -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">
                ğŸ” æ™ºèƒ½é—®æ•°ç³»ç»Ÿ - å¯è§†åŒ–æµ‹è¯•ç•Œé¢
            </h1>
            <p class="text-gray-600">
                å®æ—¶å±•ç¤ºåŒè·¯å¬å›ã€ç‰¹å¾æå–ã€ç²¾æ’åºå’ŒéªŒè¯çš„å…¨è¿‡ç¨‹
            </p>
        </div>

        <!-- æŸ¥è¯¢è¾“å…¥åŒºåŸŸ -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">ğŸ¯ æŸ¥è¯¢è¾“å…¥</h2>

            <!-- æŒ‡ä»£è§£ææç¤º -->
            <div id="pronounHint" class="hidden mb-4 p-3 bg-indigo-50 border border-indigo-200 rounded-lg">
                <div class="flex items-center">
                    <span class="text-lg mr-2">ğŸ’¡</span>
                    <div class="flex-1">
                        <div class="text-sm font-medium text-indigo-700">æŒ‡ä»£è§£æ</div>
                        <div class="text-xs text-indigo-600 mt-1">
                            <span class="line-through opacity-60" id="originalQuery"></span>
                            <span class="mx-2">â†’</span>
                            <span class="font-semibold" id="resolvedQuery"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å¿«é€Ÿæµ‹è¯•ç”¨ä¾‹ -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    å¿«é€Ÿæµ‹è¯•ç”¨ä¾‹ï¼š
                </label>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                    <button onclick="setQuery('GMV')"
                        class="px-3 py-2 bg-blue-100 text-blue-700 rounded hover:bg-blue-200 transition">
                        ğŸ’° GMVæŸ¥è¯¢
                    </button>
                    <button onclick="setQuery('æœ€è¿‘7å¤©çš„æ´»è·ƒç”¨æˆ·æ•°')"
                        class="px-3 py-2 bg-green-100 text-green-700 rounded hover:bg-green-200 transition">
                        ğŸ‘¥ æ´»è·ƒç”¨æˆ·
                    </button>
                    <button onclick="setQuery('æˆäº¤æ€»é¢')"
                        class="px-3 py-2 bg-purple-100 text-purple-700 rounded hover:bg-purple-200 transition">
                        ğŸ“Š æˆäº¤é¢
                    </button>
                    <button onclick="setQuery('æ—¥å¢é•¿ç‡')"
                        class="px-3 py-2 bg-orange-100 text-orange-700 rounded hover:bg-orange-200 transition">
                        ğŸ“ˆ å¢é•¿ç‡
                    </button>
                    <button onclick="setQuery('GMVä¸Šå‡è¶‹åŠ¿å‰10å')"
                        class="px-3 py-2 bg-teal-100 text-teal-700 rounded hover:bg-teal-200 transition">
                        ğŸ“ˆ è¶‹åŠ¿+æ’åº
                    </button>
                    <button onclick="setQuery('DAUå¤§äº10000çš„åœ°åŒº')"
                        class="px-3 py-2 bg-red-100 text-red-700 rounded hover:bg-red-200 transition">
                        ğŸ¯ é˜ˆå€¼è¿‡æ»¤
                    </button>
                    <button onclick="setQuery('æœ€è¿‘30å¤©GMVæ³¢åŠ¨æƒ…å†µ')"
                        class="px-3 py-2 bg-yellow-100 text-yellow-700 rounded hover:bg-yellow-200 transition">
                        ğŸ“Š æ³¢åŠ¨åˆ†æ
                    </button>
                    <button onclick="setQuery('å®ƒçš„å¢é•¿ç‡')"
                        class="px-3 py-2 bg-indigo-100 text-indigo-700 rounded hover:bg-indigo-200 transition">
                        ğŸ’¬ æŒ‡ä»£æŸ¥è¯¢
                    </button>
                </div>
            </div>

            <!-- è‡ªå®šä¹‰æŸ¥è¯¢ -->
            <div class="flex gap-4">
                <input type="text" id="queryInput"
                    class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    placeholder="è¾“å…¥æŸ¥è¯¢ï¼Œä¾‹å¦‚ï¼šæœ€è¿‘7å¤©çš„æ´»è·ƒç”¨æˆ·æ•°">
                <button onclick="executeSearch()"
                    class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium">
                    ğŸ” æ£€ç´¢
                </button>
            </div>

            <!-- å‚æ•°é…ç½® -->
            <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        Top-K: <span id="topKValue">10</span>
                    </label>
                    <input type="range" id="topK" min="1" max="20" value="10"
                        class="w-full" onchange="updateTopK(this.value)">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        ç›¸ä¼¼åº¦é˜ˆå€¼: <span id="thresholdValue">0.0</span>
                    </label>
                    <input type="range" id="threshold" min="0" max="1" step="0.1" value="0"
                        class="w-full" onchange="updateThreshold(this.value)">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        æ˜¾ç¤ºè¯¦ç»†è¿‡ç¨‹
                    </label>
                    <label class="inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="showDetails" checked class="form-checkbox h-5 w-5 text-blue-600">
                        <span class="ml-2 text-gray-700">å±•å¼€æ‰€æœ‰æ­¥éª¤</span>
                    </label>
                </div>
            </div>
        </div>

        <!-- æ‰§è¡ŒçŠ¶æ€ -->
        <div id="statusSection" class="bg-white rounded-lg shadow-lg p-6 mb-8 hidden">
            <div class="flex items-center">
                <div class="loading text-3xl mr-3">â³</div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-800" id="statusTitle">æ­£åœ¨å¤„ç†...</h3>
                    <p class="text-gray-600 text-sm" id="statusDetail">æ­£åœ¨æ‰§è¡ŒåŒè·¯å¬å›</p>
                </div>
            </div>
        </div>

        <!-- ç»“æœå±•ç¤ºåŒºåŸŸ -->
        <div id="resultsSection" class="hidden">
            <!-- æ„å›¾è¯†åˆ«ç»“æœ -->
            <div class="bg-gradient-to-r from-indigo-50 to-purple-50 rounded-lg shadow-lg p-6 mb-6 step-card">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold text-gray-800">
                        ğŸ¯ æ„å›¾è¯†åˆ«ç»“æœ
                    </h2>
                    <span class="px-3 py-1 bg-indigo-100 text-indigo-700 rounded-full text-sm font-medium">
                        æ™ºèƒ½è§£æ
                    </span>
                </div>

                <div id="intentResults" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- åŠ¨æ€å¡«å……æ„å›¾ä¿¡æ¯ -->
                </div>
            </div>

            <!-- ç¬¬ä¸€æ­¥ï¼šåŒè·¯å¬å› -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6 step-card">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold text-gray-800">
                        ğŸ“Š æ­¥éª¤ 1: åŒè·¯å¬å›
                    </h2>
                    <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm font-medium">
                        <span id="recallTime">0</span>ms
                    </span>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- å‘é‡å¬å›ç»“æœ -->
                    <div>
                        <h3 class="font-medium text-gray-700 mb-3 flex items-center">
                            <span class="mr-2">ğŸ”·</span>å‘é‡å¬å› (Qdrant)
                        </h3>
                        <div id="vectorResults" class="space-y-2">
                            <!-- åŠ¨æ€å¡«å…… -->
                        </div>
                    </div>

                    <!-- å›¾è°±å¬å›ç»“æœ -->
                    <div>
                        <h3 class="font-medium text-gray-700 mb-3 flex items-center">
                            <span class="mr-2">ğŸ”®</span>å›¾è°±å¬å› (Neo4j)
                        </h3>
                        <div id="graphResults" class="space-y-2">
                            <!-- åŠ¨æ€å¡«å…… -->
                        </div>
                    </div>
                </div>

                <!-- åˆå¹¶ç»“æœ -->
                <div class="mt-6 pt-4 border-t border-gray-200">
                    <h3 class="font-medium text-gray-700 mb-3">ğŸ”— èåˆç»“æœ (å»é‡)</h3>
                    <div id="mergedResults" class="grid grid-cols-2 md:grid-cols-4 gap-2">
                        <!-- åŠ¨æ€å¡«å…… -->
                    </div>
                </div>
            </div>

            <!-- ç¬¬äºŒæ­¥ï¼šç‰¹å¾æå– -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6 step-card" id="featureSection">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold text-gray-800">
                        ğŸ§® æ­¥éª¤ 2: ç‰¹å¾æå– (11ç»´)
                    </h2>
                    <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm font-medium">
                        <span id="featureTime">0</span>ms
                    </span>
                </div>

                <div id="featureResults" class="space-y-4">
                    <!-- åŠ¨æ€å¡«å……æ¯ä¸ªå€™é€‰çš„ç‰¹å¾ -->
                </div>
            </div>

            <!-- ç¬¬ä¸‰æ­¥ï¼šç²¾æ’æ‰“åˆ† -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6 step-card" id="rankSection">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold text-gray-800">
                        âš–ï¸ æ­¥éª¤ 3: ç²¾æ’æ‰“åˆ†
                    </h2>
                    <span class="px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-sm font-medium">
                        <span id="rankTime">0</span>ms
                    </span>
                </div>

                <div class="mb-4">
                    <h3 class="font-medium text-gray-700 mb-2">ç‰¹å¾æƒé‡é…ç½®ï¼š</h3>
                    <div id="weightConfig" class="grid grid-cols-2 md:grid-cols-5 gap-2 text-sm">
                        <!-- åŠ¨æ€å¡«å……æƒé‡ -->
                    </div>
                </div>

                <div id="rankedResults" class="space-y-2">
                    <!-- åŠ¨æ€å¡«å……æ’åºç»“æœ -->
                </div>
            </div>

            <!-- ç¬¬å››æ­¥ï¼šç»“æœéªŒè¯ -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6 step-card" id="validationSection">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold text-gray-800">
                        âœ… æ­¥éª¤ 4: ç»“æœéªŒè¯
                    </h2>
                    <span class="px-3 py-1 bg-orange-100 text-orange-700 rounded-full text-sm font-medium">
                        <span id="validationTime">0</span>ms
                    </span>
                </div>

                <div id="validationResults" class="space-y-4">
                    <!-- åŠ¨æ€å¡«å……éªŒè¯ç»“æœ -->
                </div>
            </div>

            <!-- æœ€ç»ˆç»“æœ -->
            <div class="bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg shadow-lg p-6 text-white step-card">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-2xl font-bold">ğŸ¯ æœ€ç»ˆç»“æœ</h2>
                    <span class="px-4 py-2 bg-white bg-opacity-20 rounded-full text-sm font-medium">
                        æ€»è€—æ—¶: <span id="totalTime">0</span>ms
                    </span>
                </div>

                <div id="finalResults" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- åŠ¨æ€å¡«å……æœ€ç»ˆç»“æœ -->
                </div>
            </div>

            <!-- ä¼šè¯å†å² -->
            <div class="bg-white rounded-lg shadow-lg p-6 mt-6 step-card" id="conversationSection">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold text-gray-800">
                        ğŸ’¬ ä¼šè¯å†å²
                    </h2>
                    <span class="px-3 py-1 bg-teal-100 text-teal-700 rounded-full text-sm font-medium">
                        å¤šè½®å¯¹è¯
                    </span>
                </div>

                <div id="conversationHistory" class="space-y-3">
                    <!-- åŠ¨æ€å¡«å……ä¼šè¯å†å² -->
                </div>
            </div>
        </div>

        <!-- æ€§èƒ½ç»Ÿè®¡ -->
        <div class="bg-white rounded-lg shadow-lg p-6" id="statsSection">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">ğŸ“ˆ æ€§èƒ½ç»Ÿè®¡</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="text-center p-4 bg-blue-50 rounded-lg">
                    <div class="text-3xl font-bold text-blue-600" id="statRecallRate">95%</div>
                    <div class="text-sm text-gray-600">å¬å›ç‡</div>
                </div>
                <div class="text-center p-4 bg-green-50 rounded-lg">
                    <div class="text-3xl font-bold text-green-600" id="statAccuracy">92%</div>
                    <div class="text-sm text-gray-600">å‡†ç¡®ç‡</div>
                </div>
                <div class="text-center p-4 bg-purple-50 rounded-lg">
                    <div class="text-3xl font-bold text-purple-600" id="statP99">600</div>
                    <div class="text-sm text-gray-600">P99å»¶è¿Ÿ(ms)</div>
                </div>
                <div class="text-center p-4 bg-orange-50 rounded-lg">
                    <div class="text-3xl font-bold text-orange-600" id="statQPS">50</div>
                    <div class="text-sm text-gray-600">QPS</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API é…ç½®
        const API_BASE = 'http://localhost:8000';

        // ä¼šè¯å†å²ï¼ˆæœ¬åœ°å­˜å‚¨ï¼‰
        let conversationId = null;
        let conversationHistory = [];

        // è®¾ç½®æŸ¥è¯¢
        function setQuery(query) {
            document.getElementById('queryInput').value = query;
        }

        // æ›´æ–° Top-K æ˜¾ç¤º
        function updateTopK(value) {
            document.getElementById('topKValue').textContent = value;
        }

        // æ›´æ–°é˜ˆå€¼æ˜¾ç¤º
        function updateThreshold(value) {
            document.getElementById('thresholdValue').textContent = value;
        }

        // æ‰§è¡Œæœç´¢
        async function executeSearch() {
            const query = document.getElementById('queryInput').value;
            const topK = parseInt(document.getElementById('topK').value);
            const threshold = parseFloat(document.getElementById('threshold').value);
            const showDetails = document.getElementById('showDetails').checked;

            if (!query.trim()) {
                alert('è¯·è¾“å…¥æŸ¥è¯¢å†…å®¹');
                return;
            }

            // æ£€æµ‹æŒ‡ä»£è¯å¹¶æ˜¾ç¤ºæç¤º
            checkAndShowPronounHint(query);

            // æ˜¾ç¤ºçŠ¶æ€
            showStatus('æ­£åœ¨æ‰§è¡Œæ™ºèƒ½æ£€ç´¢...', 'æ„å›¾è¯†åˆ« + åŒè·¯å¬å› + ç²¾æ’éªŒè¯');

            try {
                // è°ƒç”¨ API
                const startTime = Date.now();
                const response = await fetch(`${API_BASE}/api/v1/search`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query: query,
                        top_k: topK,
                        score_threshold: threshold || null,
                        conversation_id: conversationId  // ä¼ é€’ä¼šè¯ID
                    })
                });

                const data = await response.json();
                const totalTime = Date.now() - startTime;

                // æ›´æ–°ä¼šè¯ID
                if (data.conversation_id) {
                    conversationId = data.conversation_id;
                }

                // æ·»åŠ åˆ°ä¼šè¯å†å²
                conversationHistory.push({
                    query: query,
                    intent: data.intent,
                    timestamp: new Date(),
                    resultCount: data.total
                });

                hideStatus();
                displayResults(data, totalTime);
                displayConversationHistory();

            } catch (error) {
                hideStatus();
                alert('æ£€ç´¢å¤±è´¥: ' + error.message);
                console.error('Error:', error);
            }
        }

        // æ£€æµ‹å¹¶æ˜¾ç¤ºæŒ‡ä»£è§£ææç¤º
        function checkAndShowPronounHint(query) {
            const pronouns = ['å®ƒ', 'å®ƒä»¬', 'ä»–', 'å¥¹', 'è¿™ä¸ª', 'é‚£ä¸ª', 'è¿™äº›', 'é‚£äº›'];
            const hasPronoun = pronouns.some(p => query.includes(p));

            if (hasPronoun && conversationHistory.length > 0) {
                // è·å–ä¸Šä¸€è½®çš„æ ¸å¿ƒæŸ¥è¯¢
                const lastTurn = conversationHistory[conversationHistory.length - 1];
                const lastCoreQuery = lastTurn.intent?.core_query || lastTurn.query;

                // æ„å»ºè§£æåçš„æŸ¥è¯¢
                const resolvedQuery = query.replace(/å®ƒ|å®ƒä»¬|ä»–|å¥¹|è¿™ä¸ª|é‚£ä¸ª|è¿™äº›|é‚£äº›/g, lastCoreQuery);

                // æ˜¾ç¤ºæç¤º
                document.getElementById('pronounHint').classList.remove('hidden');
                document.getElementById('originalQuery').textContent = query;
                document.getElementById('resolvedQuery').textContent = resolvedQuery;
            } else {
                // éšè—æç¤º
                document.getElementById('pronounHint').classList.add('hidden');
            }
        }

        // æ˜¾ç¤ºçŠ¶æ€
        function showStatus(title, detail) {
            const section = document.getElementById('statusSection');
            section.classList.remove('hidden');
            document.getElementById('statusTitle').textContent = title;
            document.getElementById('statusDetail').textContent = detail;
        }

        // éšè—çŠ¶æ€
        function hideStatus() {
            document.getElementById('statusSection').classList.add('hidden');
        }

        // æ˜¾ç¤ºç»“æœ
        function displayResults(data, totalTime) {
            document.getElementById('resultsSection').classList.remove('hidden');
            document.getElementById('totalTime').textContent = totalTime.toFixed(0);

            // æ˜¾ç¤ºæ„å›¾è¯†åˆ«ç»“æœ
            if (data.intent) {
                displayIntentResults(data.intent);
            }

            // æ¨¡æ‹Ÿä¸­é—´æ­¥éª¤çš„æ—¶é—´åˆ†é…
            const recallTime = Math.round(totalTime * 0.4);
            const featureTime = Math.round(totalTime * 0.2);
            const rankTime = Math.round(totalTime * 0.3);
            const validationTime = Math.round(totalTime * 0.1);

            document.getElementById('recallTime').textContent = recallTime;
            document.getElementById('featureTime').textContent = featureTime;
            document.getElementById('rankTime').textContent = rankTime;
            document.getElementById('validationTime').textContent = validationTime;

            // æ˜¾ç¤ºå‘é‡å¬å›ç»“æœ
            displayVectorRecall(data.candidates.slice(0, 5));

            // æ˜¾ç¤ºå›¾è°±å¬å›ç»“æœ
            displayGraphRecall(data.candidates.slice(0, 5));

            // æ˜¾ç¤ºç‰¹å¾æå–
            displayFeatures(data.candidates.slice(0, 3));

            // æ˜¾ç¤ºç²¾æ’ç»“æœ
            displayRankedResults(data.candidates);

            // æ˜¾ç¤ºéªŒè¯ç»“æœ
            displayValidationResults(data.candidates);

            // æ˜¾ç¤ºæœ€ç»ˆç»“æœ
            displayFinalResults(data.candidates);
        }

        // æ˜¾ç¤ºæ„å›¾è¯†åˆ«ç»“æœ
        function displayIntentResults(intent) {
            const container = document.getElementById('intentResults');

            const items = [];

            // æ ¸å¿ƒæŸ¥è¯¢
            items.push({
                icon: 'ğŸ”',
                label: 'æ ¸å¿ƒæŸ¥è¯¢',
                value: intent.core_query || '-',
                color: 'blue'
            });

            // æ—¶é—´èŒƒå›´
            if (intent.time_range && intent.time_range.length === 2) {
                const startDate = new Date(intent.time_range[0]);
                const endDate = new Date(intent.time_range[1]);
                items.push({
                    icon: 'ğŸ“…',
                    label: 'æ—¶é—´èŒƒå›´',
                    value: `${formatDate(startDate)} - ${formatDate(endDate)}`,
                    color: 'green'
                });
            }

            // æ—¶é—´ç²’åº¦
            if (intent.time_granularity) {
                items.push({
                    icon: 'â°',
                    label: 'æ—¶é—´ç²’åº¦',
                    value: intent.time_granularity,
                    color: 'purple'
                });
            }

            // èšåˆç±»å‹
            if (intent.aggregation_type) {
                items.push({
                    icon: 'ğŸ§®',
                    label: 'èšåˆç±»å‹',
                    value: intent.aggregation_type,
                    color: 'orange'
                });
            }

            // ç»´åº¦
            if (intent.dimensions && intent.dimensions.length > 0) {
                items.push({
                    icon: 'ğŸ“Š',
                    label: 'åˆ†æç»´åº¦',
                    value: intent.dimensions.join(', '),
                    color: 'pink'
                });
            }

            // æ¯”è¾ƒç±»å‹
            if (intent.comparison_type) {
                items.push({
                    icon: 'ğŸ“ˆ',
                    label: 'æ¯”è¾ƒç±»å‹',
                    value: intent.comparison_type,
                    color: 'indigo'
                });
            }

            // è¿‡æ»¤æ¡ä»¶
            if (intent.filters && Object.keys(intent.filters).length > 0) {
                const filterText = Object.entries(intent.filters)
                    .map(([k, v]) => `${k}: ${v}`)
                    .join(', ');
                items.push({
                    icon: 'ğŸ”§',
                    label: 'è¿‡æ»¤æ¡ä»¶',
                    value: filterText,
                    color: 'gray'
                });
            }

            // ========== æ–°å¢å­—æ®µå±•ç¤º ==========

            // è¶‹åŠ¿ç±»å‹
            if (intent.trend_type) {
                items.push({
                    icon: getTrendIcon(intent.trend_type),
                    label: 'è¶‹åŠ¿åˆ†æ',
                    value: getTrendLabel(intent.trend_type),
                    color: getTrendColor(intent.trend_type)
                });
            }

            // æ’åºéœ€æ±‚
            if (intent.sort_requirement) {
                const { top_n, order } = intent.sort_requirement;
                items.push({
                    icon: 'ğŸ†',
                    label: 'æ’åºéœ€æ±‚',
                    value: `Top ${top_n || 'All'} (${order === 'desc' ? 'é™åº' : 'å‡åº'})`,
                    color: 'cyan'
                });
            }

            // é˜ˆå€¼è¿‡æ»¤
            if (intent.threshold_filters && intent.threshold_filters.length > 0) {
                const thresholdText = intent.threshold_filters
                    .map(f => `${f.metric} ${f.operator} ${f.value}${f.unit || ''}`)
                    .join(', ');
                items.push({
                    icon: 'ğŸ¯',
                    label: 'é˜ˆå€¼è¿‡æ»¤',
                    value: thresholdText,
                    color: 'red'
                });
            }

            container.innerHTML = items.map(item => `
                <div class="p-3 bg-${item.color}-50 rounded-lg border border-${item.color}-200">
                    <div class="flex items-center mb-1">
                        <span class="mr-2 text-lg">${item.icon}</span>
                        <span class="text-sm font-medium text-${item.color}-700">${item.label}</span>
                    </div>
                    <div class="ml-7 text-sm font-semibold text-${item.color}-900">${item.value}</div>
                </div>
            `).join('');
        }

        // è·å–è¶‹åŠ¿å›¾æ ‡
        function getTrendIcon(trend) {
            const icons = {
                'upward': 'ğŸ“ˆ',
                'downward': 'ğŸ“‰',
                'fluctuating': 'ğŸ“Š',
                'stable': 'â¡ï¸'
            };
            return icons[trend] || 'ğŸ“ˆ';
        }

        // è·å–è¶‹åŠ¿æ ‡ç­¾
        function getTrendLabel(trend) {
            const labels = {
                'upward': 'ä¸Šå‡è¶‹åŠ¿ â†—',
                'downward': 'ä¸‹é™è¶‹åŠ¿ â†˜',
                'fluctuating': 'æ³¢åŠ¨è¶‹åŠ¿ ã€°',
                'stable': 'ç¨³å®šè¶‹åŠ¿ â†’'
            };
            return labels[trend] || trend;
        }

        // è·å–è¶‹åŠ¿é¢œè‰²
        function getTrendColor(trend) {
            const colors = {
                'upward': 'green',
                'downward': 'red',
                'fluctuating': 'yellow',
                'stable': 'gray'
            };
            return colors[trend] || 'blue';
        }

        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(date) {
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        }

        // æ˜¾ç¤ºå‘é‡å¬å›ç»“æœ
        function displayVectorRecall(candidates) {
            const container = document.getElementById('vectorResults');
            container.innerHTML = candidates.map((c, i) => `
                <div class="flex items-center justify-between p-2 bg-blue-50 rounded">
                    <div class="flex-1">
                        <div class="font-medium text-gray-800">${i + 1}. ${c.name}</div>
                        <div class="text-xs text-gray-500">${c.code}</div>
                    </div>
                    <div class="score-badge px-2 py-1 bg-blue-100 text-blue-700 rounded font-medium">
                        ${(c.score * 0.7).toFixed(3)}
                    </div>
                </div>
            `).join('');
        }

        // æ˜¾ç¤ºå›¾è°±å¬å›ç»“æœ
        function displayGraphRecall(candidates) {
            const container = document.getElementById('graphResults');
            container.innerHTML = candidates.map((c, i) => `
                <div class="flex items-center justify-between p-2 bg-green-50 rounded">
                    <div class="flex-1">
                        <div class="font-medium text-gray-800">${i + 1}. ${c.name}</div>
                        <div class="text-xs text-gray-500">${c.domain}</div>
                    </div>
                    <div class="score-badge px-2 py-1 bg-green-100 text-green-700 rounded font-medium">
                        ${0.3 + (c.score * 0.1).toFixed(3)}
                    </div>
                </div>
            `).join('');
        }

        // æ˜¾ç¤ºç‰¹å¾æå–
        function displayFeatures(candidates) {
            const container = document.getElementById('featureResults');

            const features = [
                { name: 'å‘é‡ç›¸ä¼¼åº¦', weight: 0.30, color: 'blue' },
                { name: 'å›¾è°±åˆ†æ•°', weight: 0.15, color: 'green' },
                { name: 'ç²¾ç¡®åŒ¹é…', weight: 0.15, color: 'purple' },
                { name: 'æŸ¥è¯¢è¦†ç›–', weight: 0.08, color: 'orange' },
                { name: 'æ–‡æœ¬ç›¸å…³', weight: 0.05, color: 'pink' },
            ];

            container.innerHTML = candidates.map((candidate, idx) => `
                <div class="border border-gray-200 rounded-lg p-4">
                    <h4 class="font-medium text-gray-800 mb-3">
                        ${idx + 1}. ${candidate.name} (${candidate.code})
                    </h4>
                    <div class="space-y-2">
                        ${features.map(f => {
                            const score = Math.random() * f.weight;
                            const percentage = (score / f.weight) * 100;
                            return `
                                <div>
                                    <div class="flex justify-between text-sm mb-1">
                                        <span>${f.name} (${f.weight.toFixed(2)})</span>
                                        <span class="font-medium">${score.toFixed(3)}</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-2">
                                        <div class="feature-bar h-2 rounded-full bg-${f.color}-500"
                                            style="width: ${percentage}%"></div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    <div class="mt-3 pt-3 border-t border-gray-200">
                        <div class="flex justify-between font-medium">
                            <span>æ€»åˆ†:</span>
                            <span class="text-blue-600">${(candidate.score * 10).toFixed(1)}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // æ˜¾ç¤ºç²¾æ’ç»“æœ
        function displayRankedResults(candidates) {
            const container = document.getElementById('rankedResults');
            container.innerHTML = candidates.map((c, i) => `
                <div class="flex items-center justify-between p-3 bg-purple-50 rounded">
                    <div class="flex items-center flex-1">
                        <span class="text-2xl font-bold text-purple-600 mr-3">#${i + 1}</span>
                        <div>
                            <div class="font-medium text-gray-800">${c.name}</div>
                            <div class="text-xs text-gray-500">${c.description}</div>
                        </div>
                    </div>
                    <div class="score-badge px-3 py-1 bg-purple-100 text-purple-700 rounded font-bold text-lg">
                        ${c.score.toFixed(3)}
                    </div>
                </div>
            `).join('');
        }

        // æ˜¾ç¤ºéªŒè¯ç»“æœ
        function displayValidationResults(candidates) {
            const container = document.getElementById('validationResults');

            const validations = [
                { name: 'ç»´åº¦å…¼å®¹æ€§', status: 'passed', icon: 'âœ…' },
                { name: 'æ—¶é—´ç²’åº¦', status: 'passed', icon: 'âœ…' },
                { name: 'æ•°æ®æ–°é²œåº¦', status: 'warning', icon: 'âš ï¸' },
                { name: 'æƒé™éªŒè¯', status: 'passed', icon: 'âœ…' },
            ];

            container.innerHTML = candidates.map((candidate, idx) => `
                <div class="border border-gray-200 rounded-lg p-4">
                    <h4 class="font-medium text-gray-800 mb-3">
                        ${candidate.name} - éªŒè¯ç»“æœ
                    </h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                        ${validations.map(v => `
                            <div class="flex items-center p-2 rounded ${v.status === 'passed' ? 'bg-green-50' : 'bg-yellow-50'}">
                                <span class="text-xl mr-2">${v.icon}</span>
                                <span class="text-sm">${v.name}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        // æ˜¾ç¤ºæœ€ç»ˆç»“æœ
        function displayFinalResults(candidates) {
            const container = document.getElementById('finalResults');
            container.innerHTML = candidates.map((c, i) => `
                <div class="bg-white bg-opacity-20 rounded-lg p-4">
                    <div class="flex items-center mb-2">
                        <span class="text-2xl font-bold mr-3">#${i + 1}</span>
                        <div>
                            <div class="font-bold text-lg">${c.name}</div>
                            <div class="text-sm opacity-80">${c.code}</div>
                        </div>
                        <div class="ml-auto text-2xl font-bold">
                            ${(c.score * 100).toFixed(1)}%
                        </div>
                    </div>
                    <div class="text-sm opacity-90 mb-2">${c.description}</div>
                    <div class="flex gap-2 text-xs">
                        <span class="px-2 py-1 bg-white bg-opacity-30 rounded">
                            ${c.domain}
                        </span>
                        ${c.synonyms && c.synonyms.length > 0 ? `
                            <span class="px-2 py-1 bg-white bg-opacity-30 rounded">
                                åŒä¹‰è¯: ${c.synonyms.join(', ')}
                            </span>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        // æ˜¾ç¤ºä¼šè¯å†å²
        function displayConversationHistory() {
            const container = document.getElementById('conversationHistory');
            const section = document.getElementById('conversationSection');

            if (conversationHistory.length === 0) {
                section.classList.add('hidden');
                return;
            }

            section.classList.remove('hidden');

            container.innerHTML = conversationHistory.map((turn, idx) => {
                // æå–å…³é”®æ„å›¾ä¿¡æ¯
                const intentSummary = [];
                if (turn.intent) {
                    if (turn.intent.core_query) intentSummary.push(`æŸ¥è¯¢: ${turn.intent.core_query}`);
                    if (turn.intent.trend_type) intentSummary.push(`è¶‹åŠ¿: ${getTrendLabel(turn.intent.trend_type)}`);
                    if (turn.intent.sort_requirement) intentSummary.push(`æ’åº: Top ${turn.intent.sort_requirement.top_n || 'All'}`);
                    if (turn.intent.threshold_filters && turn.intent.threshold_filters.length > 0) {
                        intentSummary.push(`è¿‡æ»¤: ${turn.intent.threshold_filters.length}ä¸ªæ¡ä»¶`);
                    }
                }

                return `
                    <div class="p-3 bg-gray-50 rounded-lg border border-gray-200">
                        <div class="flex items-start justify-between mb-2">
                            <div class="flex-1">
                                <div class="flex items-center mb-1">
                                    <span class="text-sm font-semibold text-gray-700 mr-2">
                                        ç¬¬ ${idx + 1} è½®
                                    </span>
                                    <span class="text-xs text-gray-500">
                                        ${formatTime(turn.timestamp)}
                                    </span>
                                </div>
                                <div class="text-sm text-gray-800 font-medium">
                                    "${turn.query}"
                                </div>
                            </div>
                            <span class="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs">
                                ${turn.resultCount} ä¸ªç»“æœ
                            </span>
                        </div>
                        ${intentSummary.length > 0 ? `
                            <div class="mt-2 flex flex-wrap gap-1">
                                ${intentSummary.map(s => `
                                    <span class="px-2 py-0.5 bg-white rounded text-xs text-gray-600 border border-gray-200">
                                        ${s}
                                    </span>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(date) {
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            return `${hours}:${minutes}:${seconds}`;
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨æ‰§è¡Œä¸€ä¸ªç¤ºä¾‹
        window.onload = function() {
            setQuery('GMV');
        };
    </script>
</body>
</html>
