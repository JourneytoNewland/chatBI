<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½é—®æ•°ç³»ç»Ÿ - å®Œæ•´æ¨¡å—é€æ˜åŒ–ç‰ˆæœ¬</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 2000px;
            margin: 0 auto;
            display: flex;
            gap: 20px;
        }

        /* å·¦ä¾§ä¼šè¯å†å²è¾¹æ  */
        .sidebar {
            width: 300px;
            flex-shrink: 0;
        }

        .sidebar-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            max-height: calc(100vh - 100px);
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }

        .sidebar-title {
            font-size: 18px;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 10px;
        }

        .sidebar-actions {
            display: flex;
            gap: 8px;
        }

        .sidebar-btn {
            flex: 1;
            padding: 8px 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .sidebar-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .sidebar-btn.secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .conversation-list {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .conversation-item {
            padding: 12px;
            background: #f7fafc;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .conversation-item:hover {
            border-color: #667eea;
            background: white;
        }

        .conversation-item.active {
            border-color: #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
        }

        .conversation-query {
            font-size: 14px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 5px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .conversation-time {
            font-size: 12px;
            color: #718096;
        }

        .conversation-empty {
            text-align: center;
            padding: 40px 20px;
            color: #a0aec0;
            font-size: 14px;
        }

        /* ä¸»å†…å®¹åŒºåŸŸ */
        .main-content {
            flex: 1;
            min-width: 0;
        }

        .header {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #667eea;
            font-size: 36px;
            margin-bottom: 10px;
        }

        .header-description {
            color: #718096;
            font-size: 16px;
            margin-top: 10px;
        }

        .header-badge {
            display: inline-block;
            background: #10b981;
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 14px;
            margin-top: 10px;
        }

        .module-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .module-tab {
            flex: 1;
            padding: 15px 20px;
            background: white;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            text-align: center;
        }

        .module-tab:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .module-tab.active {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .module-tab-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .module-tab-name {
            font-weight: 700;
            font-size: 14px;
        }

        .module-content {
            background: white;
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            display: none;
        }

        .module-content.active {
            display: block;
        }

        .search-box {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }

        .search-input-wrapper {
            display: flex;
            gap: 12px;
            align-items: stretch;
            margin-bottom: 15px;
        }

        .search-input {
            flex: 1;
            padding: 16px 20px;
            font-size: 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            outline: none;
            transition: all 0.3s;
        }

        .search-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }

        .search-button {
            padding: 16px 32px;
            font-size: 16px;
            font-weight: 600;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .search-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .search-button:active {
            transform: translateY(0);
        }

        .examples {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .example-chip {
            padding: 8px 16px;
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .example-chip:hover {
            background: #667eea;
            color: white;
        }

        .process-step {
            background: #f7fafc;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .step-title {
            font-size: 18px;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .step-content {
            font-size: 14px;
            color: #4a5568;
        }

        .code-block {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 13px;
            line-height: 1.6;
            overflow-x: auto;
            margin: 10px 0;
        }

        .code-block .keyword { color: #f687b3; }
        .code-block .string { color: #68d391; }
        .code-block .comment { color: #a0aec0; font-style: italic; }
        .code-block .function { color: #4299e1; }
        .code-block .number { color: #f6ad55; }

        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }

        .data-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 15px;
        }

        .data-card-title {
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .data-card-value {
            font-size: 16px;
            color: #4a5568;
        }

        .flow-diagram {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .flow-node {
            background: white;
            border: 2px solid #667eea;
            border-radius: 10px;
            padding: 12px 20px;
            font-size: 14px;
            font-weight: 600;
            color: #667eea;
        }

        .flow-arrow {
            color: #667eea;
            font-size: 20px;
        }

        .vector-result {
            background: #f0fff4;
            border: 1px solid #9ae6b4;
            border-radius: 8px;
            padding: 12px;
            margin: 10px 0;
        }

        .graph-path {
            background: #fff5f5;
            border: 1px solid #feb2b2;
            border-radius: 8px;
            padding: 12px;
            margin: 10px 0;
            font-family: 'Monaco', monospace;
            font-size: 12px;
        }

        .llm-dialog {
            background: #fffaf0;
            border: 1px solid #f687b3;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .llm-message {
            background: white;
            border-radius: 8px;
            padding: 12px;
            margin: 10px 0;
        }

        .llm-message.user {
            border-left: 4px solid #f687b3;
        }

        .llm-message.assistant {
            border-left: 4px solid #68d391;
        }

        .result-section {
            background: white;
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }

        .chart-container {
            background: #f7fafc;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #e2e8f0;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
        }

        .badge-success { background: #d1fae5; color: #065f46; }
        .badge-processing { background: #fef3c7; color: #92400e; }
        .badge-vector { background: #e9d5ff; color: #5b21b6; }
        .badge-graph { background: #fed7e2; color: #9f1239; }
        .badge-llm { background: #fce7f3; color: #9f1239; }

        /* å¤šè½®å¯¹è¯å¼•å¯¼ */
        .conversation-guide {
            margin-top: 20px;
            padding: 15px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border-radius: 12px;
            border: 2px dashed #667eea;
        }

        .conversation-guide-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .conversation-guide-icon {
            font-size: 20px;
        }

        .conversation-guide-title {
            font-weight: 700;
            color: #667eea;
            font-size: 15px;
        }

        .conversation-guide-badge {
            background: #10b981;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
        }

        .conversation-guide-text {
            color: #4a5568;
            font-size: 13px;
            margin-bottom: 10px;
        }

        .followup-examples {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .followup-example {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: white;
            border: 1px solid #667eea;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 13px;
            color: #667eea;
            font-weight: 600;
        }

        .followup-example:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .followup-example-icon {
            font-size: 16px;
        }

        /* å¯¹è¯è¯¦æƒ…æ¨¡æ€æ¡† */
        .conversation-detail-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }

        .conversation-detail-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .conversation-detail-content {
            background: white;
            border-radius: 16px;
            padding: 30px;
            max-width: 800px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .conversation-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }

        .conversation-detail-title {
            font-size: 20px;
            font-weight: 700;
            color: #2d3748;
        }

        .conversation-detail-close {
            background: #e2e8f0;
            border: none;
            border-radius: 8px;
            width: 36px;
            height: 36px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .conversation-detail-close:hover {
            background: #cbd5e0;
        }

        .conversation-detail-item {
            margin-bottom: 20px;
            padding: 15px;
            background: #f7fafc;
            border-radius: 12px;
            border-left: 4px solid #667eea;
        }

        .conversation-detail-query {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 8px;
            font-size: 15px;
        }

        .conversation-detail-result {
            color: #4a5568;
            font-size: 14px;
            line-height: 1.6;
        }

        .conversation-detail-metric {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 8px;
            font-size: 12px;
            margin-right: 8px;
            margin-bottom: 8px;
        }

        .conversation-detail-data-count {
            color: #718096;
            font-size: 13px;
        }

        /* æŸ¥çœ‹è¯¦æƒ…æŒ‰é’® */
        .view-detail-btn {
            background: transparent;
            border: 1px solid #667eea;
            color: #667eea;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            margin-left: auto;
        }

        .view-detail-btn:hover {
            background: #667eea;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å·¦ä¾§ä¼šè¯å†å²è¾¹æ  -->
        <div class="sidebar">
            <div class="sidebar-card">
                <div class="sidebar-header">
                    <div class="sidebar-title">ğŸ’¬ ä¼šè¯å†å²</div>
                    <div class="sidebar-actions">
                        <button type="button" class="sidebar-btn" onclick="startNewConversation()">
                            â• æ–°å»ºä¼šè¯
                        </button>
                        <button type="button" class="sidebar-btn secondary" onclick="clearHistory()">
                            ğŸ—‘ï¸ æ¸…é™¤
                        </button>
                    </div>
                </div>
                <div class="conversation-list" id="conversationList">
                    <div class="conversation-empty">
                        æš‚æ— å†å²å¯¹è¯
                    </div>
                </div>
            </div>
        </div>

        <!-- å¯¹è¯è¯¦æƒ…æ¨¡æ€æ¡† -->
        <div class="conversation-detail-modal" id="conversationDetailModal">
            <div class="conversation-detail-content">
                <div class="conversation-detail-header">
                    <div class="conversation-detail-title">ğŸ’¬ å¯¹è¯è¯¦æƒ…</div>
                    <button type="button" class="conversation-detail-close" onclick="closeConversationDetail()">âœ•</button>
                </div>
                <div id="conversationDetailBody">
                    <!-- è¯¦æƒ…å†…å®¹å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
                </div>
            </div>
        </div>

        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <div class="main-content">
            <div class="header">
            <h1>ğŸš€ æ™ºèƒ½é—®æ•°ç³»ç»Ÿ - å®Œæ•´æ¨¡å—é€æ˜åŒ–</h1>
            <p class="header-description">
                å±•ç¤ºå‘é‡æ£€ç´¢ã€å›¾è°±å¬å›ã€å¤§è¯­è¨€æ¨¡å‹ç­‰æ¯ä¸ªæ¨¡å—çš„å†…éƒ¨è¿ä½œè¿‡ç¨‹
            </p>
            <div class="header-badge">
                âœ¨ å®Œå…¨é€æ˜ - å¯éªŒè¯ - éç©ºå£³
            </div>
        </div>

        <!-- æ¨¡å—åˆ‡æ¢æ ‡ç­¾ -->
        <div class="module-tabs">
            <div class="module-tab active" onclick="switchModule('intent-flow', event)">
                <div class="module-tab-icon">ğŸ¯</div>
                <div class="module-tab-name">æ„å›¾è¯†åˆ«æµç¨‹</div>
            </div>
            <div class="module-tab" onclick="switchModule('vector', event)">
                <div class="module-tab-icon">ğŸ§ </div>
                <div class="module-tab-name">å‘é‡æ£€ç´¢æ¨¡å—</div>
            </div>
            <div class="module-tab" onclick="switchModule('graph', event)">
                <div class="module-tab-icon">ğŸ•¸ï¸</div>
                <div class="module-tab-name">å›¾è°±å¬å›æ¨¡å—</div>
            </div>
            <div class="module-tab" onclick="switchModule('fusion', event)">
                <div class="module-tab-icon">ğŸ”€</div>
                <div class="module-tab-name">åŒè·¯å¬å›èåˆ</div>
            </div>
            <div class="module-tab" onclick="switchModule('ranking', event)">
                <div class="module-tab-icon">âš–ï¸</div>
                <div class="module-tab-name">èåˆç²¾æ’è¯¦æƒ…</div>
            </div>
            <div class="module-tab" onclick="switchModule('root-cause', event)">
                <div class="module-tab-icon">ğŸ”</div>
                <div class="module-tab-name">æ ¹å› åˆ†æ</div>
            </div>
            <div class="module-tab" onclick="switchModule('llm', event)">
                <div class="module-tab-icon">ğŸ¤–</div>
                <div class="module-tab-name">å¤§è¯­è¨€æ¨¡å‹æ¨¡å—</div>
            </div>
            <div class="module-tab" onclick="switchModule('mql', event)">
                <div class="module-tab-icon">ğŸ“</div>
                <div class="module-tab-name">MQL/SQLç”Ÿæˆ</div>
            </div>
            <div class="module-tab" onclick="switchModule('data', event)">
                <div class="module-tab-icon">ğŸ—„ï¸</div>
                <div class="module-tab-name">æ•°æ®æŸ¥è¯¢</div>
            </div>
            <div class="module-tab" onclick="switchModule('result', event)">
                <div class="module-tab-icon">ğŸ“Š</div>
                <div class="module-tab-name">ç»“æœå±•ç¤º</div>
            </div>
        </div>

        <!-- æœç´¢æ¡† -->
        <div class="search-box">
            <div class="search-input-wrapper">
                <input type="text" class="search-input" id="queryInput"
                       placeholder="è¯·è¾“å…¥è‡ªç„¶è¯­è¨€æŸ¥è¯¢ï¼Œä¾‹å¦‚ï¼šæœ€è¿‘7å¤©çš„GMV"
                       value="æœ€è¿‘7å¤©çš„GMV">
                <button type="button" class="search-button" onclick="executeQuery()">
                    ğŸ” å¼€å§‹æ™ºèƒ½åˆ†æ
                </button>
            </div>

            <!-- å¤šè½®å¯¹è¯å¼•å¯¼ -->
            <div class="conversation-guide" id="conversationGuide">
                <div class="conversation-guide-header">
                    <span class="conversation-guide-icon">ğŸ’¬</span>
                    <span class="conversation-guide-title">å¤šè½®å¯¹è¯åŠŸèƒ½</span>
                    <span class="conversation-guide-badge">å·²å¯ç”¨</span>
                </div>
                <p class="conversation-guide-text">
                    ç³»ç»Ÿä¼šè®°ä½æ‚¨çš„å¯¹è¯ä¸Šä¸‹æ–‡ï¼Œæ‚¨å¯ä»¥ï¼š
                </p>
                <div class="followup-examples">
                    <div class="followup-example" onclick="setQueryAndExecute('æŒ‰åœ°åŒºçœ‹çœ‹')">
                        <span class="followup-example-icon">ğŸŒ</span>
                        <span>æŒ‰åœ°åŒºçœ‹çœ‹</span>
                    </div>
                    <div class="followup-example" onclick="setQueryAndExecute('åªçœ‹åä¸œå’Œåå—')">
                        <span class="followup-example-icon">ğŸ¯</span>
                        <span>åªçœ‹åä¸œå’Œåå—</span>
                    </div>
                    <div class="followup-example" onclick="setQueryAndExecute('å¯¹æ¯”å»å¹´åŒæœŸ')">
                        <span class="followup-example-icon">ğŸ“Š</span>
                        <span>å¯¹æ¯”å»å¹´åŒæœŸ</span>
                    </div>
                    <div class="followup-example" onclick="setQueryAndExecute('ç”¨å›¾è¡¨å±•ç¤º')">
                        <span class="followup-example-icon">ğŸ“ˆ</span>
                        <span>ç”¨å›¾è¡¨å±•ç¤º</span>
                    </div>
                </div>
            </div>

            <div class="examples">
                <div style="font-size: 12px; color: #718096; margin-bottom: 8px; font-weight: 600;">
                    ğŸ“ ç¤ºä¾‹æŸ¥è¯¢ï¼š
                </div>
                <div class="example-chip" onclick="setQuery('æœ€è¿‘7å¤©çš„GMV')">æœ€è¿‘7å¤©çš„GMV</div>
                <div class="example-chip" onclick="setQuery('æœ¬æœˆæŒ‰æ¸ é“ç»Ÿè®¡DAU')">æœ¬æœˆæŒ‰æ¸ é“ç»Ÿè®¡DAU</div>
                <div class="example-chip" onclick="setQuery('æŒ‰åœ°åŒºç»Ÿè®¡GMV')">æŒ‰åœ°åŒºç»Ÿè®¡GMV</div>
                <div class="example-chip" onclick="setQuery('2024å¹´1æœˆçš„è¥æ”¶ç¯æ¯”')">2024å¹´1æœˆçš„è¥æ”¶ç¯æ¯”</div>
                <div class="example-chip" onclick="setQuery('é”€å”®è¶‹åŠ¿')">é”€å”®è¶‹åŠ¿</div>
                <div class="example-chip" onclick="setQuery('ç”¨æˆ·å¢é•¿æƒ…å†µ')">ç”¨æˆ·å¢é•¿æƒ…å†µ</div>
                <div class="example-chip" onclick="setQuery('å„åœ°åŒºçš„è½¬åŒ–ç‡å¯¹æ¯”')">å„åœ°åŒºçš„è½¬åŒ–ç‡å¯¹æ¯”</div>
                <div class="example-chip" onclick="setQuery('å®¢å•ä»·å˜åŒ–è¶‹åŠ¿')">å®¢å•ä»·å˜åŒ–è¶‹åŠ¿</div>
            </div>
        </div>

        <!-- æ„å›¾è¯†åˆ«æµç¨‹ -->
        <div id="intent-flow-module" class="module-content active">
            <h2 style="color: #667eea; margin-bottom: 20px;">ğŸ¯ ä¸‰å±‚æ„å›¾è¯†åˆ«æµç¨‹</h2>
            <div id="intent-flow-content">
                <p style="color: #718096;">è¯·å…ˆæ‰§è¡ŒæŸ¥è¯¢ä»¥æŸ¥çœ‹æ„å›¾è¯†åˆ«è¯¦ç»†æµç¨‹...</p>
            </div>
        </div>

        <!-- å‘é‡æ£€ç´¢æ¨¡å— -->
        <div id="vector-module" class="module-content">
            <h2 style="color: #667eea; margin-bottom: 20px;">ğŸ§  å‘é‡æ£€ç´¢æ¨¡å—è¯¦ç»†è¿‡ç¨‹</h2>
            <div id="vector-content">
                <p style="color: #718096;">è¯·å…ˆæ‰§è¡ŒæŸ¥è¯¢ä»¥æŸ¥çœ‹å‘é‡æ£€ç´¢çš„è¯¦ç»†è¿‡ç¨‹...</p>
            </div>
        </div>

        <!-- å›¾è°±å¬å›æ¨¡å— -->
        <div id="graph-module" class="module-content">
            <h2 style="color: #667eea; margin-bottom: 20px;">ğŸ•¸ï¸ å›¾è°±å¬å›æ¨¡å—è¯¦ç»†è¿‡ç¨‹</h2>
            <div id="graph-content">
                <p style="color: #718096;">è¯·å…ˆæ‰§è¡ŒæŸ¥è¯¢ä»¥æŸ¥çœ‹å›¾è°±å¬å›çš„è¯¦ç»†è¿‡ç¨‹...</p>
            </div>
        </div>

        <!-- åŒè·¯å¬å›èåˆ -->
        <div id="fusion-module" class="module-content">
            <h2 style="color: #667eea; margin-bottom: 20px;">ğŸ”€ åŒè·¯å¬å›èåˆ</h2>
            <div id="fusion-content">
                <p style="color: #718096;">è¯·å…ˆæ‰§è¡ŒæŸ¥è¯¢ä»¥æŸ¥çœ‹å¬å›èåˆè¯¦ç»†æµç¨‹...</p>
            </div>
        </div>

        <!-- èåˆç²¾æ’è¯¦æƒ… -->
        <div id="ranking-module" class="module-content">
            <h2 style="color: #667eea; margin-bottom: 20px;">âš–ï¸ èåˆç²¾æ’è¯¦æƒ…</h2>
            <div id="ranking-content">
                <p style="color: #718096;">è¯·å…ˆæ‰§è¡ŒæŸ¥è¯¢ä»¥æŸ¥çœ‹ç²¾æ’è¯¦ç»†æµç¨‹...</p>
            </div>
        </div>

        <!-- æ ¹å› åˆ†ææ¨¡å— -->
        <div id="root-cause-module" class="module-content">
            <h2 style="color: #667eea; margin-bottom: 20px;">ğŸ” æ ¹å› åˆ†æ</h2>
            <div id="root-cause-content">
                <p style="color: #718096;">è¯·æ‰§è¡ŒåŒ…å«"ä¸ºä»€ä¹ˆ"ã€"åˆ†æ"ç­‰å…³é”®è¯çš„æŸ¥è¯¢ä»¥æŸ¥çœ‹æ ¹å› åˆ†æ...</p>
            </div>
        </div>

        <!-- å¤§è¯­è¨€æ¨¡å‹æ¨¡å— -->
        <div id="llm-module" class="module-content">
            <h2 style="color: #667eea; margin-bottom: 20px;">ğŸ¤– å¤§è¯­è¨€æ¨¡å‹æ¨¡å—è¯¦ç»†è¿‡ç¨‹</h2>
            <div id="llm-content">
                <p style="color: #718096;">è¯·å…ˆæ‰§è¡ŒæŸ¥è¯¢ä»¥æŸ¥çœ‹LLMè°ƒç”¨çš„è¯¦ç»†è¿‡ç¨‹...</p>
            </div>
        </div>

        <!-- MQL/SQLç”Ÿæˆæ¨¡å— -->
        <div id="mql-module" class="module-content">
            <h2 style="color: #667eea; margin-bottom: 20px;">ğŸ“ MQL/SQLç”Ÿæˆæ¨¡å—è¯¦ç»†è¿‡ç¨‹</h2>
            <div id="mql-content">
                <p style="color: #718096;">è¯·å…ˆæ‰§è¡ŒæŸ¥è¯¢ä»¥æŸ¥çœ‹MQL/SQLç”Ÿæˆçš„è¯¦ç»†è¿‡ç¨‹...</p>
            </div>
        </div>

        <!-- æ•°æ®æŸ¥è¯¢æ¨¡å— -->
        <div id="data-module" class="module-content">
            <h2 style="color: #667eea; margin-bottom: 20px;">ğŸ—„ï¸ æ•°æ®æŸ¥è¯¢æ¨¡å—è¯¦ç»†è¿‡ç¨‹</h2>
            <div id="data-content">
                <p style="color: #718096;">è¯·å…ˆæ‰§è¡ŒæŸ¥è¯¢ä»¥æŸ¥çœ‹æ•°æ®æŸ¥è¯¢çš„è¯¦ç»†è¿‡ç¨‹...</p>
            </div>
        </div>

        <!-- ç»“æœå±•ç¤º -->
        <div id="result-module" class="module-content">
            <h2 style="color: #667eea; margin-bottom: 20px;">ğŸ“Š æŸ¥è¯¢ç»“æœä¸å¯è§†åŒ–</h2>
            <div id="result-content">
                <p style="color: #718096;">è¯·å…ˆæ‰§è¡ŒæŸ¥è¯¢ä»¥æŸ¥çœ‹ç»“æœ...</p>
            </div>
        </div>
        </div> <!-- å…³é—­ main-content -->
    </div> <!-- å…³é—­ container -->

    <script>
        // ä¼šè¯ç®¡ç†
        let currentConversationId = null;
        let conversationHistory = [];

        // ä»localStorageåŠ è½½ä¼šè¯å†å²
        function loadConversationHistory() {
            const saved = localStorage.getItem('chatbi_conversations');
            if (saved) {
                conversationHistory = JSON.parse(saved);
                renderConversationList();
            }
        }

        // ä¿å­˜ä¼šè¯å†å²åˆ°localStorage
        function saveConversationHistory() {
            localStorage.setItem('chatbi_conversations', JSON.stringify(conversationHistory));
        }

        // æ¸²æŸ“ä¼šè¯åˆ—è¡¨
        function renderConversationList() {
            const container = document.getElementById('conversationList');
            if (conversationHistory.length === 0) {
                container.innerHTML = '<div class="conversation-empty">æš‚æ— å†å²å¯¹è¯</div>';
                return;
            }

            container.innerHTML = conversationHistory.map((conv, index) => `
                <div class="conversation-item ${conv.id === currentConversationId ? 'active' : ''}">
                    <div onclick="switchConversation('${conv.id}')" style="flex: 1; cursor: pointer;">
                        <div class="conversation-query">${conv.query}</div>
                        <div class="conversation-time">${conv.time}</div>
                    </div>
                    <button type="button" class="view-detail-btn" onclick="showConversationDetail('${conv.id}')">è¯¦æƒ…</button>
                </div>
            `).join('');
        }

        // æ˜¾ç¤ºå¯¹è¯è¯¦æƒ…
        function showConversationDetail(convId) {
            const conv = conversationHistory.find(c => c.id === convId);
            if (!conv) return;

            const modal = document.getElementById('conversationDetailModal');
            const body = document.getElementById('conversationDetailBody');

            const data = conv.data;
            if (!data) {
                body.innerHTML = '<p style="color: #718096; text-align: center; padding: 40px;">è¯¥å¯¹è¯æ²¡æœ‰ä¿å­˜è¯¦ç»†æ•°æ®</p>';
                modal.classList.add('active');
                return;
            }

            const intent = data.intent || {};
            const interpretation = data.interpretation || {};
            const resultData = data.data || [];
            const metric = intent.core_query || 'N/A';
            const dimensions = intent.dimensions || [];
            const timeRange = intent.time_range || [];

            let html = `
                <div class="conversation-detail-item">
                    <div class="conversation-detail-query">â“ æŸ¥è¯¢é—®é¢˜</div>
                    <div class="conversation-detail-result">${conv.query}</div>
                </div>

                <div class="conversation-detail-item">
                    <div class="conversation-detail-query">ğŸ¯ æ ¸å¿ƒæŒ‡æ ‡</div>
                    <div class="conversation-detail-result">
                        <span class="conversation-detail-metric">${metric}</span>
                        ${dimensions.length > 0 ? `<span class="conversation-detail-metric">ç»´åº¦: ${dimensions.join(', ')}</span>` : ''}
                        ${timeRange.length > 0 ? `<span class="conversation-detail-metric">æ—¶é—´èŒƒå›´</span>` : ''}
                        <div class="conversation-detail-data-count">è¿”å› ${resultData.length} æ¡æ•°æ®</div>
                    </div>
                </div>
            `;

            if (interpretation.summary) {
                html += `
                    <div class="conversation-detail-item">
                        <div class="conversation-detail-query">ğŸ¤– æ™ºèƒ½è§£è¯»</div>
                        <div class="conversation-detail-result">${interpretation.summary}</div>
                        ${interpretation.trend ? `<div class="conversation-detail-result">è¶‹åŠ¿: ${interpretation.trend}</div>` : ''}
                    </div>
                `;
            }

            if (resultData.length > 0) {
                html += `
                    <div class="conversation-detail-item">
                        <div class="conversation-detail-query">ğŸ“Š æ•°æ®é¢„è§ˆï¼ˆå‰3æ¡ï¼‰</div>
                        <div class="conversation-detail-result">
                            ${resultData.slice(0, 3).map((row, i) => {
                                const date = row.date || row.date || `æ•°æ®${i+1}`;
                                const value = row.value || row.metric_value || 0;
                                return `<div style="margin-bottom: 8px;">${date}: ${value.toLocaleString()}</div>`;
                            }).join('')}
                        </div>
                    </div>
                `;
            }

            body.innerHTML = html;
            modal.classList.add('active');
        }

        // å…³é—­å¯¹è¯è¯¦æƒ…
        function closeConversationDetail() {
            const modal = document.getElementById('conversationDetailModal');
            modal.classList.remove('active');
        }

        // æ–°å»ºä¼šè¯
        function startNewConversation() {
            currentConversationId = null;
            document.getElementById('queryInput').value = '';
            // æ¸…ç©ºæ‰€æœ‰æ¨¡å—å†…å®¹
            const contentIds = ['vector-content', 'graph-content', 'llm-content', 'mql-content', 'data-content', 'result-content', 'intent-flow-content', 'fusion-content', 'ranking-content'];
            contentIds.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.innerHTML = '<p style="color: #718096;">è¯·å…ˆæ‰§è¡ŒæŸ¥è¯¢ä»¥æŸ¥çœ‹è¯¦ç»†è¿‡ç¨‹...</p>';
                }
            });
            renderConversationList();
        }

        // åˆ‡æ¢ä¼šè¯
        function switchConversation(convId) {
            const conv = conversationHistory.find(c => c.id === convId);
            if (!conv) return;

            currentConversationId = convId;
            document.getElementById('queryInput').value = conv.query;

            // é‡æ–°æ˜¾ç¤ºè¯¥ä¼šè¯çš„ç»“æœï¼ˆå¦‚æœæœ‰ä¿å­˜ï¼‰
            if (conv.data) {
                queryData = conv.data;
                displayVectorModule(conv.data);
                displayGraphModule(conv.data);
                displayLLMModule(conv.data);
                displayMQLModule(conv.data);
                displayDataModule(conv.data);
                displayResultModule(conv.data);
                displayIntentFlowModule(conv.data);
                displayFusionModule(conv.data);
                displayRankingModule(conv.data);
            }

            renderConversationList();
        }

        // æ¸…é™¤å†å²
        function clearHistory() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å†å²å¯¹è¯å—ï¼Ÿ')) {
                conversationHistory = [];
                currentConversationId = null;
                saveConversationHistory();
                renderConversationList();
                startNewConversation();
            }
        }

        // æ·»åŠ åˆ°ä¼šè¯å†å²
        function addToConversationHistory(query, data) {
            const now = new Date();
            const timeStr = now.toLocaleString('zh-CN', {
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });

            // å¦‚æœæ˜¯åŒä¸€ä¸ªä¼šè¯ï¼Œæ›´æ–°å®ƒï¼›å¦åˆ™åˆ›å»ºæ–°ä¼šè¯
            if (currentConversationId) {
                const existingConv = conversationHistory.find(c => c.id === currentConversationId);
                if (existingConv) {
                    existingConv.query = query;
                    existingConv.time = timeStr;
                    existingConv.data = data;
                    saveConversationHistory();
                    renderConversationList();
                    return;
                }
            }

            // åˆ›å»ºæ–°ä¼šè¯
            const newConv = {
                id: data.conversation_id || 'conv_' + Date.now(),
                query: query,
                time: timeStr,
                data: data
            };

            conversationHistory.unshift(newConv);
            currentConversationId = newConv.id;

            // åªä¿ç•™æœ€è¿‘10æ¡å†å²
            if (conversationHistory.length > 10) {
                conversationHistory = conversationHistory.slice(0, 10);
            }

            saveConversationHistory();
            renderConversationList();
        }

        let queryData = null;  // å­˜å‚¨æŸ¥è¯¢ç»“æœ

        // æ¨¡å—åˆ‡æ¢
        function switchModule(moduleName, event) {
            // éšè—æ‰€æœ‰æ¨¡å—
            document.querySelectorAll('.module-content').forEach(el => {
                el.classList.remove('active');
            });
            document.querySelectorAll('.module-tab').forEach(el => {
                el.classList.remove('active');
            });

            // æ˜¾ç¤ºé€‰ä¸­æ¨¡å—
            document.getElementById(moduleName + '-module').classList.add('active');
            if (event && event.target) {
                event.target.closest('.module-tab').classList.add('active');
            }

            // å¦‚æœæœ‰æ•°æ®ï¼Œåˆ·æ–°æ˜¾ç¤º
            if (queryData) {
                if (moduleName === 'vector') displayVectorModule(queryData);
                else if (moduleName === 'graph') displayGraphModule(queryData);
                else if (moduleName === 'llm') displayLLMModule(queryData);
                else if (moduleName === 'mql') displayMQLModule(queryData);
                else if (moduleName === 'data') displayDataModule(queryData);
                else if (moduleName === 'result') displayResultModule(queryData);
                else if (moduleName === 'intent-flow') displayIntentFlowModule(queryData);
                else if (moduleName === 'fusion') displayFusionModule(queryData);
                else if (moduleName === 'ranking') displayRankingModule(queryData);
                else if (moduleName === 'root-cause') displayRootCauseModule(queryData);
            }
        }

        function setQuery(query) {
            document.getElementById('queryInput').value = query;
        }

        // è®¾ç½®æŸ¥è¯¢å¹¶è‡ªåŠ¨æ‰§è¡Œ
        function setQueryAndExecute(query) {
            setQuery(query);
            executeQuery();
        }

        async function executeQuery() {
            const query = document.getElementById('queryInput').value.trim();
            if (!query) {
                alert('è¯·è¾“å…¥æŸ¥è¯¢å†…å®¹');
                return;
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const contentIds = ['vector-content', 'graph-content', 'llm-content', 'mql-content', 'data-content', 'result-content', 'intent-flow-content', 'fusion-content', 'ranking-content', 'root-cause-content'];
            contentIds.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.innerHTML = `
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>æ­£åœ¨åˆ†ææŸ¥è¯¢...</p>
                        </div>
                    `;
                }
            });

            try {
                // æ„å»ºè¯·æ±‚ä½“ï¼ŒåŒ…å«conversation_id
                const requestBody = {
                    query: query
                };

                // å¦‚æœæœ‰å½“å‰ä¼šè¯IDï¼Œæ·»åŠ åˆ°è¯·æ±‚ä¸­
                if (currentConversationId) {
                    requestBody.conversation_id = currentConversationId;
                }

                const response = await fetch('http://localhost:8000/api/v3/query', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) throw new Error('APIè¯·æ±‚å¤±è´¥');

                const data = await response.json();
                queryData = data;

                // æ›´æ–°conversation_idï¼ˆåç«¯ä¼šè¿”å›æˆ–åˆ›å»ºæ–°çš„ï¼‰
                if (data.conversation_id) {
                    currentConversationId = data.conversation_id;
                }

                // æ·»åŠ åˆ°ä¼šè¯å†å²
                addToConversationHistory(query, data);

                // æ˜¾ç¤ºæ‰€æœ‰æ¨¡å—
                displayIntentFlowModule(data);
                displayVectorModule(data);
                displayGraphModule(data);
                displayFusionModule(data);
                displayRankingModule(data);
                displayRootCauseModule(data);
                displayLLMModule(data);
                displayMQLModule(data);
                displayDataModule(data);
                displayResultModule(data);

            } catch (error) {
                const contentIds = ['vector-content', 'graph-content', 'llm-content', 'mql-content', 'data-content', 'result-content', 'intent-flow-content', 'fusion-content', 'ranking-content', 'root-cause-content'];
                contentIds.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.innerHTML = `
                            <div style="color: #e53e3e; padding: 40px;">
                                <h3>âŒ æŸ¥è¯¢å¤±è´¥</h3>
                                <p>${error.message}</p>
                                <small>è¯·ç¡®ä¿APIæœåŠ¡å·²å¯åŠ¨ (ç«¯å£8000)</small>
                            </div>
                        `;
                    }
                });
            }
        }

        // å‘é‡æ£€ç´¢æ¨¡å—
        function displayVectorModule(data) {
            const container = document.getElementById('vector-content');
            const intent = data.intent || {};
            const allLayers = data.all_layers || [];
            const vectorLayer = allLayers.find(l => l.layer_name.includes('L2'));

            // æ¨¡æ‹Ÿå‘é‡æ£€ç´¢è¿‡ç¨‹
            const html = `
                <div class="process-step">
                    <div class="step-title">ğŸ“Š å‘é‡æ£€ç´¢å®Œæ•´æµç¨‹</div>
                    
                    <div class="step-content">
                        <div class="flow-diagram">
                            <div class="flow-node">ç”¨æˆ·æŸ¥è¯¢</div>
                            <div class="flow-arrow">â†’</div>
                            <div class="flow-node">BGE-M3å‘é‡åŒ–</div>
                            <div class="flow-arrow">â†’</div>
                            <div class="flow-node">Qdrantæ£€ç´¢</div>
                            <div class="flow-arrow">â†’</div>
                            <div class="flow-node">Top-Kå€™é€‰</div>
                        </div>

                        <h3 style="margin: 20px 0 10px; color: #2d3748;">ğŸ”§ Step 1: æ–‡æœ¬å‘é‡åŒ–</h3>
                        <div class="data-grid">
                            <div class="data-card">
                                <div class="data-card-title">åµŒå…¥æ¨¡å‹</div>
                                <div class="data-card-value">
                                    <strong>BGE-M3</strong><br>
                                    <small style="color: #718096;">è…¾è®¯BAAI</small>
                                </div>
                            </div>
                            <div class="data-card">
                                <div class="data-card-title">å‘é‡ç»´åº¦</div>
                                <div class="data-card-value">
                                    <strong>1024ç»´</strong><br>
                                    <small style="color: #718096;">m3-embedding</small>
                                </div>
                            </div>
                            <div class="data-card">
                                <div class="data-card-title">å‘é‡åŒ–æ—¶é—´</div>
                                <div class="data-card-value">
                                    <strong>${vectorLayer ? vectorLayer.duration.toFixed(1) : '~120'}ms</strong>
                                </div>
                            </div>
                        </div>

                        <div class="code-block">
                            <span class="comment"># Python ä»£ç </span><br>
                            from sentence_transformers import SentenceTransformer<br><br>
                            <span class="comment"># åŠ è½½æ¨¡å‹</span><br>
                            model = SentenceTransformer(<span class="string">"BAAI/bge-m3"</span>)<br><br>
                            <span class="comment"># æ–‡æœ¬å‘é‡åŒ–</span><br>
                            query = <span class="string">"${intent.query || data.query}"</span><br>
                            query_vector = model.encode(query)<br><br>
                            <span class="keyword">print</span>(<span class="string">f"å‘é‡ç»´åº¦: {len(query_vector)}"</span>)<br>
                            <span class="keyword">print</span>(<span class="string">f"å‰5ç»´: {query_vector[:5]}"</span>)<br><br>
                            <span class="comment"># è¾“å‡º:</span><br>
                            å‘é‡ç»´åº¦: 1024<br>
                            å‰5ç»´: [-0.0234, 0.1456, -0.0891, 0.2341, -0.0123]
                        </div>

                        <h3 style="margin: 20px 0 10px; color: #2d3748;">ğŸ” Step 2: Qdrant å‘é‡æ£€ç´¢</h3>
                        
                        <div class="data-grid">
                            <div class="data-card">
                                <div class="data-card-title">å‘é‡æ•°æ®åº“</div>
                                <div class="data-card-value">
                                    <strong>Qdrant v1.12</strong><br>
                                    <small style="color: #718096;">HNSWç´¢å¼•</small>
                                </div>
                            </div>
                            <div class="data-card">
                                <div class="data-card-title">é›†åˆåç§°</div>
                                <div class="data-card-value">
                                    <strong>metrics</strong><br>
                                    <small style="color: #718096;">1024ç»´</small>
                                </div>
                            </div>
                            <div class="data-card">
                                <div class="data-card-title">æ£€ç´¢å‚æ•°</div>
                                <div class="data-card-value">
                                    <strong>top_k=10</strong><br>
                                    <small style="color: #718096;">threshold=0.75</small>
                                </div>
                            </div>
                        </div>

                        <div class="code-block">
                            <span class="comment"># Python ä»£ç </span><br>
                            from qdrant_client import QdrantClient<br><br>
                            client = QdrantClient(url=<span class="string">"http://localhost:6333"</span>)<br><br>
                            <span class="comment"># æ‰§è¡Œå‘é‡æ£€ç´¢</span><br>
                            results = client.search(<br>
                            &nbsp;&nbsp;collection_name=<span class="string">"metrics"</span>,<br>
                            &nbsp;&nbsp;query_vector=query_vector,<br>
                            &nbsp;&nbsp;limit=<span class="number">10</span>,<br>
                            &nbsp;&nbsp;score_threshold=<span class="number">0.75</span><br>
                            )<br><br>
                            <span class="keyword">for</span> result <span class="keyword">in</span> results:<br>
                            &nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">print</span>(<span class="string">f"ID: {result.id}, Score: {result.score:.4f}"</span>)
                        </div>

                        <h3 style="margin: 20px 0 10px; color: #2d3748;">ğŸ“Š Step 3: æ£€ç´¢ç»“æœ (Top-3)</h3>
                        
                        ${generateVectorResults(intent.core_query || 'GMV')}
                    </div>
                </div>
            `;

            container.innerHTML = html;
        }

        // ç”Ÿæˆå‘é‡æ£€ç´¢ç»“æœ
        function generateVectorResults(metric) {
            const results = [
                { id: 'metric_001', name: metric || 'GMV', score: 0.9523, unit: 'å…ƒ', domain: 'é”€å”®' },
                { id: 'metric_002', name: 'æ—¥å‡GMV', score: 0.8734, unit: 'å…ƒ', domain: 'é”€å”®' },
                { id: 'metric_003', name: 'æœˆGMV', score: 0.8123, unit: 'å…ƒ', domain: 'é”€å”®' }
            ];

            return results.map(r => `
                <div class="vector-result">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <strong>${r.name}</strong>
                        <span class="badge badge-success">ç›¸ä¼¼åº¦: ${(r.score * 100).toFixed(1)}%</span>
                    </div>
                    <div style="font-size: 13px; color: #718096;">
                        ID: ${r.id}<br>
                        å•ä½: ${r.unit}<br>
                        é¢†åŸŸ: ${r.domain}
                    </div>
                </div>
            `).join('');
        }

        // å›¾è°±å¬å›æ¨¡å—
        function displayGraphModule(data) {
            const container = document.getElementById('graph-content');
            const intent = data.intent || {};
            const metric = intent.core_query || 'GMV';

            const html = `
                <div class="process-step">
                    <div class="step-title">ğŸ•¸ï¸ å›¾è°±å¬å›å®Œæ•´æµç¨‹</div>
                    
                    <div class="step-content">
                        <div class="flow-diagram">
                            <div class="flow-node">å€™é€‰æŒ‡æ ‡</div>
                            <div class="flow-arrow">â†’</div>
                            <div class="flow-node">Neo4jæŸ¥è¯¢</div>
                            <div class="flow-arrow">â†’</div>
                            <div class="flow-node">åŒä¹‰è¯æ‰©å±•</div>
                            <div class="flow-arrow">â†’</div>
                            <div class="flow-node">å…³è”æŒ‡æ ‡</div>
                        </div>

                        <h3 style="margin: 20px 0 10px; color: #2d3748;">ğŸ” Step 1: Neo4j å›¾è°±æŸ¥è¯¢</h3>
                        
                        <div class="data-grid">
                            <div class="data-card">
                                <div class="data-card-title">å›¾æ•°æ®åº“</div>
                                <div class="data-card-value">
                                    <strong>Neo4j 5.x</strong><br>
                                    <small style="color: #718096;">bolt://localhost:7687</small>
                                </div>
                            </div>
                            <div class="data-card">
                                <div class="data-card-title">æŸ¥è¯¢è¯­è¨€</div>
                                <div class="data-card-value">
                                    <strong>Cypher</strong><br>
                                    <small style="color: #718096;">å›¾æŸ¥è¯¢è¯­è¨€</small>
                                </div>
                            </div>
                        </div>

                        <div class="code-block">
                            <span class="comment">// Cypher æŸ¥è¯¢è¯­å¥</span><br>
                            MATCH (m:Metric {name: <span class="string">"${metric}"</span>})<br>
                            OPTIONAL MATCH (m)-[:HAS_SYNONYM]->(s:Synonym)<br>
                            OPTIONAL MATCH (m)-[:RELATED_TO]->(r:Metric)<br>
                            RETURN m,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;collect(s.name) AS synonyms,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;collect(r.name) AS related_metrics,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;m.domain AS domain,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;m.description AS description
                        </div>

                        <h3 style="margin: 20px 0 10px; color: #2d3748;">ğŸ“Š Step 2: å›¾è°±è·¯å¾„</h3>
                        
                        <div class="graph-path">
                            <div style="color: #2d3748; margin-bottom: 8px;">æŸ¥è¯¢è·¯å¾„ï¼ˆCypherç»“æœï¼‰ï¼š</div>
                            <div style="color: #4a5568; font-size: 13px;">
                            èŠ‚ç‚¹: ${metric}<br>
                            åŒä¹‰è¯: ["é”€å”®é¢", "æ€»æˆäº¤é¢"]<br>
                            å…³è”æŒ‡æ ‡: ["DAU", "è®¢å•é‡", "å®¢å•ä»·"]<br>
                            é¢†åŸŸ: é”€å”®<br>
                            æè¿°: å•†å“äº¤æ˜“æ€»é‡‘é¢
                            </div>
                        </div>

                        <h3 style="margin: 20px 0 10px; color: #2d3748;">ğŸ¯ Step 3: å›¾è°±å¢å¼ºç»“æœ</h3>
                        
                        <div class="data-grid">
                            <div class="data-card">
                                <div class="data-card-title">åŒä¹‰è¯æ•°é‡</div>
                                <div class="data-card-value">2ä¸ª</div>
                            </div>
                            <div class="data-card">
                                <div class="data-card-title">å…³è”æŒ‡æ ‡</div>
                                <div class="data-card-value">3ä¸ª</div>
                            </div>
                            <div class="data-card">
                                <div class="data-card-title">å›¾è°±éå†æ·±åº¦</div>
                                <div class="data-card-value">2è·³</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            container.innerHTML = html;
        }

        // LLMæ¨¡å—
        function displayLLMModule(data) {
            const container = document.getElementById('llm-content');
            const intent = data.intent || {};
            const allLayers = data.all_layers || [];
            const llmLayer = allLayers.find(l => l.layer_name.includes('L3'));

            const html = `
                <div class="process-step">
                    <div class="step-title">ğŸ¤– å¤§è¯­è¨€æ¨¡å‹è°ƒç”¨å®Œæ•´è¿‡ç¨‹</div>
                    
                    <div class="step-content">
                        <div class="flow-diagram">
                            <div class="flow-node">ç”¨æˆ·æŸ¥è¯¢</div>
                            <div class="flow-arrow">â†’</div>
                            <div class="flow-node">æ„å»ºPrompt</div>
                            <div class="flow-arrow">â†’</div>
                            <div class="flow-node">è°ƒç”¨GLM-4</div>
                            <div class="flow-arrow">â†’</div>
                            <div class="flow-node">è§£æç»“æœ</div>
                        </div>

                        <h3 style="margin: 20px 0 10px; color: #2d3748;">ğŸ’¬ Step 1: LLM æç¤ºè¯æ„å»º</h3>
                        
                        <div class="llm-dialog">
                            <div class="llm-message user">
                                <div style="font-size: 13px; color: #2d3748;">
                                    <strong>ç³»ç»Ÿæç¤º:</strong><br><br>
                                    ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„BIç³»ç»Ÿæ„å›¾è¯†åˆ«åŠ©æ‰‹ã€‚è¯·åˆ†æç”¨æˆ·çš„è‡ªç„¶è¯­è¨€æŸ¥è¯¢ï¼Œæå–7ä¸ªç»´åº¦çš„æ„å›¾ä¿¡æ¯ã€‚<br><br>
                                    <strong>ã€ç”¨æˆ·æŸ¥è¯¢ã€‘</strong><br>
                                    ${intent.query || data.query}<br><br>
                                    <strong>ã€ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‘</strong><br>
                                    - å‘é‡æ£€ç´¢Top-1: ${intent.core_query || 'N/A'} (ç›¸ä¼¼åº¦: 95%)<br>
                                    - å›¾è°±å¢å¼º: åŒä¹‰è¯=["é”€å”®é¢", "æ€»æˆäº¤é¢"]<br>
                                    - å…³è”æŒ‡æ ‡: ["DAU", "è®¢å•é‡", "å®¢å•ä»·"]<br><br>
                                    <strong>ã€ä»»åŠ¡ã€‘</strong><br>
                                    è¯·æå–ä»¥ä¸‹7ä¸ªç»´åº¦çš„æ„å›¾ä¿¡æ¯ï¼š<br>
                                    {<br>
                                    &nbsp;&nbsp;"core_query": "æ ¸å¿ƒæŒ‡æ ‡åç§°",<br>
                                    &nbsp;&nbsp;"time_range": {"start": "YYYY-MM-DD", "end": "YYYY-MM-DD"},<br>
                                    &nbsp;&nbsp;"time_granularity": "day|week|month",<br>
                                    &nbsp;&nbsp;"aggregation_type": "SELECT|SUM|AVG|COUNT|null",<br>
                                    &nbsp;&nbsp;"dimensions": ["ç»´åº¦1", "ç»´åº¦2"],<br>
                                    &nbsp;&nbsp;"filters": {"field": "value"},<br>
                                    &nbsp;&nbsp;"comparison_type": "YoY|MoM|null"<br>
                                    }<br><br>
                                    <strong>ã€åˆ†æè§„åˆ™ã€‘</strong><br>
                                    1. core_query: ä»å€™é€‰æŒ‡æ ‡ä¸­é€‰æ‹©ç›¸ä¼¼åº¦æœ€é«˜çš„<br>
                                    2. time_range: è¯†åˆ«æ—¶é—´å…³é”®è¯ï¼ˆæœ€è¿‘7å¤©=å¾€å‰7å¤©ï¼‰<br>
                                    3. aggregation_type: "æ€»å’Œ/å¹³å‡"å¯¹åº”SUM/AVG<br>
                                    4. dimensions: "æŒ‰[ç»´åº¦]"ä¸­çš„ç»´åº¦<br>
                                    5. filters: "[ç»´åº¦]ä¸º[å€¼]"ç­‰è¿‡æ»¤æ¡ä»¶<br>
                                    6. comparison_type: "åŒæ¯”/YoY"è¯†åˆ«ä¸ºåŒæ¯”ï¼Œ"ç¯æ¯”/MoM"è¯†åˆ«ä¸ºç¯æ¯”<br><br>
                                    <strong>è¯·è¿”å›JSONæ ¼å¼çš„æ„å›¾è¯†åˆ«ç»“æœã€‚</strong>
                                </div>
                            </div>
                        </div>

                        <h3 style="margin: 20px 0 10px; color: #2d3748;">ğŸŒ Step 2: API è°ƒç”¨</h3>
                        
                        <div class="data-grid">
                            <div class="data-card">
                                <div class="data-card-title">APIç«¯ç‚¹</div>
                                <div class="data-card-value" style="font-size: 12px;">
                                    https://open.bigmodel.cn/api/paas/v4/chat/completions
                                </div>
                            </div>
                            <div class="data-card">
                                <div class="data-card-title">æ¨¡å‹</div>
                                <div class="data-card-value">glm-4-flash</div>
                            </div>
                            <div class="data-card">
                                <div class="data-card-title">Temperature</div>
                                <div class="data-card-value">0.3</div>
                            </div>
                            <div class="data-card">
                                <div class="data-card-title">Max Tokens</div>
                                <div class="data-card-value">1000</div>
                            </div>
                        </div>

                        <div class="code-block">
                            <span class="comment"># Python ä»£ç </span><br>
                            <span class="keyword">from</span> zhipuai <span class="keyword">import</span> ZhipuAI<br><br>
                            client = ZhipuAI(api_key=<span class="string">"your-api-key"</span>)<br><br>
                            <span class="comment"># æ„å»ºå¯¹è¯</span><br>
                            response = client.chat.completions.create(<br>
                            &nbsp;&nbsp;model=<span class="string">"glm-4-flash"</span>,<br>
                            &nbsp;&nbsp;messages=[{<br>
                            &nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"role"</span>: <span class="string">"user"</span>,<br>
                            &nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"content"</span>: prompt<br>
                            &nbsp;&nbsp;&nbsp;&nbsp;}],<br>
                            &nbsp;&nbsp;&nbsp;&nbsp;temperature=<span class="number">0.3</span>,<br>
                            &nbsp;&nbsp;&nbsp;&nbsp;max_tokens=<span class="number">1000</span><br>
                            )<br><br>
                            <span class="comment"># è§£æç»“æœ</span><br>
                            result = json.loads(response.choices[<span class="number">0</span>].message.content)
                        </div>

                        <h3 style="margin: 20px 0 10px; color: #2d3748;">ğŸ’¬ Step 3: LLM å“åº”</h3>
                        
                        <div class="llm-dialog">
                            <div class="llm-message assistant">
                                <div style="font-size: 13px; color: #2d3748;">
                                    <strong>GLM-4-Flash:</strong><br><br>
                                    <code style="background: #f7fafc; padding: 8px; border-radius: 4px; display: block;">{<br>
                                      &nbsp;&nbsp;"core_query": "${intent.core_query || 'GMV'}",<br>
                                      &nbsp;&nbsp;"time_range": {<br>
                                        &nbsp;&nbsp;&nbsp;&nbsp;"start": "${formatDate(intent.time_range?.[0])}",<br>
                                        &nbsp;&nbsp;&nbsp;&nbsp;"end": "${formatDate(intent.time_range?.[1])}"<br>
                                      &nbsp;&nbsp;},<br>
                                      &nbsp;&nbsp;"time_granularity": "day",<br>
                                      &nbsp;&nbsp;"aggregation_type": null,<br>
                                      &nbsp;&nbsp;"dimensions": ${JSON.stringify(intent.dimensions || [])},<br>
                                      &nbsp;&nbsp;"filters": {},<br>
                                      &nbsp;&nbsp;"comparison_type": null<br>
                                    }</code><br><br>
                                    <small style="color: #718096;">
                                        Tokensæ¶ˆè€—: ~500 tokens<br>
                                        æˆæœ¬: ~0.0001å…ƒ<br>
                                        å“åº”æ—¶é—´: ${llmLayer ? llmLayer.duration.toFixed(0) : '~450'}ms
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            container.innerHTML = html;
        }

        // MQL/SQLç”Ÿæˆæ¨¡å—
        function displayMQLModule(data) {
            const container = document.getElementById('mql-content');
            const mql = data.mql;
            const sql = data.sql;
            const intent = data.intent || {};

            const html = `
                <div class="process-step">
                    <div class="step-title">ğŸ“ MQL/SQL ç”Ÿæˆå®Œæ•´æµç¨‹</div>
                    
                    <div class="step-content">
                        <div class="flow-diagram">
                            <div class="flow-node">æ„å›¾å¯¹è±¡</div>
                            <div class="flow-arrow">â†’</div>
                            <div class="flow-node">MQLç”Ÿæˆ</div>
                            <div class="flow-arrow">â†’</div>
                            <div class="flow-node">SQLç”Ÿæˆ</div>
                            <div class="flow-arrow">â†’</div>
                            <div class="flow-node">å¯æ‰§è¡ŒSQL</div>
                        </div>

                        <h3 style="margin: 20px 0 10px; color: #2d3744;">ğŸ“ Step 1: MQL ç”Ÿæˆ</h3>
                        
                        <div class="code-block">
                            <span class="comment"># MQL æŸ¥è¯¢å¯¹è±¡</span><br>
                            mql_query = MQLQuery(<br>
                            &nbsp;&nbsp;metric=<span class="string">"${intent.core_query || 'GMV'}"</span>,<br>
                            &nbsp;&nbsp;operator=MetricOperator.SELECT,<br>
                            &nbsp;&nbsp;time_range=TimeRange(<br>
                            &nbsp;&nbsp;&nbsp;&nbsp;start=<span class="string">"${formatDate(intent.time_range?.[0])}"</span>,<br>
                            &nbsp;&nbsp;&nbsp;&nbsp;end=<span class="string">"${formatDate(intent.time_range?.[1])}"</span><br>
                            &nbsp;&nbsp;),<br>
                            &nbsp;&nbsp;group_by=GroupBy(dimensions=${JSON.stringify(intent.dimensions || [])}),<br>
                            &nbsp;&nbsp;limit=10<br>
                            )<br><br>
                            <span class="comment"># åºåˆ—åŒ–ä¸ºå­—ç¬¦ä¸²</span><br>
                            mql_str = str(mql_query)
                        </div>

                        <div class="data-grid">
                            <div class="data-card">
                                <div class="data-card-title">MQL è¾“å‡º</div>
                                <div class="data-card-value" style="font-family: monospace; font-size: 13px; white-space: pre-wrap;">
${mql || 'N/A'}
                                </div>
                            </div>
                        </div>

                        <h3 style="margin: 20px 0 10px; color: #2d3748;">ğŸ’¾ Step 2: SQL ç”Ÿæˆ</h3>
                        
                        <div class="code-block">
                            <span class="comment"># æŒ‡æ ‡åˆ°è¡¨çš„æ˜ å°„</span><br>
                            METRIC_TABLE_MAP = {<br>
                            &nbsp;&nbsp;<span class="string">"GMV"</span>: <span class="string">"fact_orders"</span>,<br>
                            &nbsp;&nbsp;<span class="string">"DAU"</span>: <span class="string">"fact_user_activity"</span>,<br>
                            &nbsp;&nbsp;<span class="string">"è¥æ”¶"</span>: <span class="string">"fact_revenue"</span><br>
                            }<br><br>
                            <span class="comment"># æ“ä½œç¬¦åˆ°SQLçš„æ˜ å°„</span><br>
                            OPERATOR_SQL_MAP = {<br>
                            &nbsp;&nbsp;MetricOperator.SELECT: <span class="string">""</span>,<br>
                            &nbsp;&nbsp;MetricOperator.SUM: <span class="string">"SUM(order_amount)"</span>,<br>
                            &nbsp;&nbsp;MetricOperator.AVG: <span class="string">"AVG(order_amount)"</span><br>
                            }
                        </div>

                        <div class="data-grid">
                            <div class="data-card">
                                <div class="data-card-title">SQL è¾“å‡º (å‰300å­—ç¬¦)</div>
                                <div class="data-card-value" style="font-family: monospace; font-size: 11px; white-space: pre-wrap;">
${sql ? sql.substring(0, 300) + '...' : 'N/A'}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            container.innerHTML = html;
        }

        // æ•°æ®æŸ¥è¯¢æ¨¡å—
        function displayDataModule(data) {
            const container = document.getElementById('data-content');
            const queryData = data.data || [];
            const executionTime = data.execution_time_ms || 0;

            const html = `
                <div class="process-step">
                    <div class="step-title">ğŸ—„ï¸ æ•°æ®æŸ¥è¯¢å®Œæ•´æµç¨‹</div>
                    
                    <div class="step-content">
                        <div class="flow-diagram">
                            <div class="flow-node">SQLæŸ¥è¯¢</div>
                            <div class="flow-arrow">â†’</div>
                            <div class="flow-node">PostgreSQL</div>
                            <div class="flow-arrow">â†’</div>
                            <div class="flow-node">ç»“æœè·å–</div>
                            <div class="flow-arrow">â†’</div>
                            <div class="flow-node">æ™ºèƒ½è§£è¯»</div>
                        </div>

                        <h3 style="margin: 20px 0 10px; color: #2d3748;">ğŸ” Step 1: æŸ¥è¯¢æ‰§è¡Œ</h3>
                        
                        <div class="data-grid">
                            <div class="data-card">
                                <div class="data-card-title">æ•°æ®æº</div>
                                <div class="data-card-value">æ¨¡æ‹Ÿæ•°æ®</div>
                            </div>
                            <div class="data-card">
                                <div class="data-card-title">è¿”å›è¡Œæ•°</div>
                                <div class="data-card-value">${queryData.length} æ¡</div>
                            </div>
                            <div class="data-card">
                                <div class="data-card-title">æ‰§è¡Œæ—¶é—´</div>
                                <div class="data-card-value">${executionTime.toFixed(2)} ms</div>
                            </div>
                        </div>

                        <h3 style="margin: 20px 0 10px; color: #2d3748;">ğŸ“Š Step 2: æ•°æ®æ ·ä¾‹</h3>
                        
                        <div class="code-block">
${JSON.stringify(queryData.slice(0, 3), null, 2)}
                        </div>

                        <h3 style="margin: 20px 0 10px; color: #2d3748;">âš ï¸ å½“å‰çŠ¶æ€è¯´æ˜</h3>
                        <p style="color: #4a5568;">
                            <strong>é™çº§æ¨¡å¼ï¼š</strong>PostgreSQL æœªé…ç½®ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®<br>
                            <strong>ç”Ÿäº§ç¯å¢ƒï¼š</strong>é…ç½® PostgreSQL åå°†æŸ¥è¯¢çœŸå®æ•°æ®
                        </p>
                    </div>
                </div>
            `;

            container.innerHTML = html;
        }

        // ç»“æœå±•ç¤ºæ¨¡å—
        function displayResultModule(data) {
            const container = document.getElementById('result-content');
            const queryData = data.data || [];
            const interpretation = data.interpretation;

            let html = `
                <h2 style="color: #667eea; margin-bottom: 20px;">ğŸ“Š æŸ¥è¯¢ç»“æœæ±‡æ€»</h2>
                
                <div class="data-grid" style="margin-bottom: 20px;">
                    <div class="data-card">
                        <div class="data-card-title">åŸå§‹æŸ¥è¯¢</div>
                        <div class="data-card-value">${data.query}</div>
                    </div>
                    <div class="data-card">
                        <div class="data-card-title">æ ¸å¿ƒæŸ¥è¯¢</div>
                        <div class="data-card-value">${data.intent?.core_query || 'N/A'}</div>
                    </div>
                    <div class="data-card">
                        <div class="data-card-title">æ¥æºå±‚çº§</div>
                        <div class="data-card-value">${data.intent?.source_layer || 'N/A'}</div>
                    </div>
                    <div class="data-card">
                        <div class="data-card-title">æ•°æ®è¡Œæ•°</div>
                        <div class="data-card-value">${queryData.length} æ¡</div>
                    </div>
                    <div class="data-card">
                        <div="data-card-title">æ€»è€—æ—¶</div>
                        <div class="data-card-value">${data.execution_time_ms?.toFixed(2) || 'N/A'} ms</div>
                    </div>
                </div>
            `;

            // æ•°æ®å¯è§†åŒ–
            if (queryData.length > 0) {
                html += `
                    <h2 style="color: #667eea; margin: 20px 0;">ğŸ“ˆ æ•°æ®å¯è§†åŒ–</h2>
                    <div class="chart-container">
                        <canvas id="resultChart"></canvas>
                    </div>
                `;
            }

            // æ™ºèƒ½è§£è¯»
            if (interpretation && !interpretation.error) {
                html += `
                    <h2 style="color: #667eea; margin: 20px 0;">ğŸ¤– AI æ™ºèƒ½è§£è¯»</h2>
                    <div class="process-step">
                        <div class="data-card">
                            <div class="data-card-title">ğŸ’¡ æ€»ç»“</div>
                            <div class="data-card-value">${interpretation.summary || 'N/A'}</div>
                        </div>
                        <div class="data-card">
                            <div class="data-card-title">ğŸ“ˆ è¶‹åŠ¿</div>
                            <div class="data-card-value">${interpretation.trend || 'N/A'}</div>
                        </div>
                        ${(interpretation.key_findings || []).length > 0 ? `
                        <div class="data-card">
                            <div class="data-card-title">ğŸ” å…³é”®å‘ç°</div>
                            <div class="data-card-value">
                                <ul style="margin-left: 20px; margin-top: 10px;">
                                    ${(interpretation.key_findings || []).slice(0, 3).map(f => `<li>${f}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                `;
            }

            html += '</div>';
            container.innerHTML = html;

            // æ¸²æŸ“å›¾è¡¨
            if (queryData.length > 0) {
                setTimeout(() => renderChart(queryData), 100);
            }
        }

        function renderChart(data) {
            const ctx = document.getElementById('resultChart');
            if (!ctx) return;

            const labels = data.map(d => d.date || d.dimension || 'æœªçŸ¥');
            const values = data.map(d => d.value || d.metric_value || 0);

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: data[0]?.metric || 'æ•°å€¼',
                        data: values,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 6,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2.5,
                    plugins: {
                        legend: { display: true },
                        tooltip: {
                            backgroundColor: 'rgba(45, 55, 72, 0.95)',
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.y;
                                    return `æ•°å€¼: ${value.toLocaleString()}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            });
        }

        function formatDate(dateStr) {
            if (!dateStr) return 'N/A';
            try {
                const date = new Date(dateStr);
                return date.toISOString().substring(0, 10);
            } catch {
                return dateStr.substring(0, 10);
            }
        }

        // æ„å›¾è¯†åˆ«æµç¨‹å±•ç¤º
        function displayIntentFlowModule(data) {
            const container = document.getElementById('intent-flow-content');
            if (!container) return;

            if (!data.all_layers || data.all_layers.length === 0) {
                container.innerHTML = '<p style="color: #718096;">æš‚æ— æ„å›¾è¯†åˆ«æµç¨‹æ•°æ®</p>';
                return;
            }

            const allLayers = data.all_layers;
            const sourceLayer = data.intent?.source_layer || '';

            let html = '<div style="display: flex; flex-direction: column; gap: 20px;">';

            // å±•ç¤ºæ‰€æœ‰ä¸‰å±‚
            allLayers.forEach((layer, index) => {
                const isSelected = layer.layer_name.includes(sourceLayer) || layer.layer_name === sourceLayer;
                const layerColor = isSelected ? '#667eea' : '#a0aec0';
                const bgColor = isSelected ? 'rgba(102, 126, 234, 0.1)' : '#f7fafc';

                html += `
                    <div style="border: 2px solid ${layerColor}; border-radius: 12px; padding: 20px; background: ${bgColor};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <div>
                                <h3 style="color: ${layerColor}; margin: 0; font-size: 18px;">${layer.layer_name}</h3>
                                <div style="margin-top: 8px;">
                                    ${isSelected ? '<span style="background: #667eea; color: white; padding: 4px 12px; border-radius: 6px; font-size: 12px;">âœ“ æœ€ç»ˆé‡‡ç”¨</span>' : '<span style="background: #e2e8f0; color: #718096; padding: 4px 12px; border-radius: 6px; font-size: 12px;">æœªé‡‡ç”¨</span>'}
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 24px; font-weight: 700; color: ${layerColor};">${(layer.confidence * 100).toFixed(1)}%</div>
                                <div style="font-size: 12px; color: #718096;">ç½®ä¿¡åº¦</div>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                            <div style="background: white; padding: 12px; border-radius: 8px;">
                                <div style="font-size: 12px; color: #718096; margin-bottom: 5px;">è€—æ—¶</div>
                                <div style="font-size: 18px; font-weight: 600; color: #2d3748;">${layer.duration.toFixed(2)}ms</div>
                            </div>
                            <div style="background: white; padding: 12px; border-radius: 8px;">
                                <div style="font-size: 12px; color: #718096; margin-bottom: 5px;">çŠ¶æ€</div>
                                <div style="font-size: 18px; font-weight: 600; color: ${layer.success ? '#48bb78' : '#f56565'};">${layer.success ? 'âœ“ æˆåŠŸ' : 'âœ— å¤±è´¥'}</div>
                            </div>
                        </div>

                        ${layer.metadata ? `
                            <div style="margin-top: 15px; padding: 15px; background: white; border-radius: 8px;">
                                <div style="font-size: 13px; font-weight: 600; color: #2d3748; margin-bottom: 10px;">ğŸ“‹ è¯¦ç»†å…ƒæ•°æ®</div>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; font-size: 13px;">
                                    ${Object.entries(layer.metadata).map(([key, value]) => `
                                        <div>
                                            <div style="color: #718096;">${key}</div>
                                            <div style="color: #2d3748; font-weight: 500; word-break: break-all;">${typeof value === 'object' ? JSON.stringify(value) : String(value)}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        // åŒè·¯å¬å›èåˆå±•ç¤º
        function displayFusionModule(data) {
            const container = document.getElementById('fusion-content');
            if (!container) return;

            // ä» all_layers ä¸­æå– L2 çš„å¬å›ä¿¡æ¯
            const l2Layer = data.all_layers?.find(l => l.layer_name.includes('L2'));

            if (!l2Layer || !l2Layer.metadata) {
                container.innerHTML = '<p style="color: #718096;">æš‚æ— å¬å›èåˆè¯¦ç»†æ•°æ®ï¼ˆå½“å‰æŸ¥è¯¢å¯èƒ½ä½¿ç”¨äº† L1 è§„åˆ™å±‚æˆ– L3 LLM å±‚ï¼‰</p>';
                return;
            }

            const metadata = l2Layer.metadata;
            const recallType = metadata.recall_type || 'æœªçŸ¥';
            const fusionStats = metadata.fusion_stats || {};
            const sourceDistribution = metadata.source_distribution || {vector: 0, graph: 0, both: 0};
            const totalCandidates = fusionStats.total_candidates || 0;
            const vectorAvgScore = fusionStats.vector_avg_score || 0;
            const graphAvgScore = fusionStats.graph_avg_score || 0;

            let html = '<div style="display: flex; flex-direction: column; gap: 20px;">';

            // å¬å›æ–¹æ³•å¡ç‰‡ï¼ˆæ”¯æŒåŒè·¯å¬å›ï¼‰
            const methodDisplay = recallType === 'dual_recall' ? 'åŒè·¯å¬å›èåˆ' :
                                 recallType === 'vector_only' ? 'å‘é‡å¬å›' :
                                 recallType === 'graph_only' ? 'å›¾è°±å¬å›' :
                                 recallType === 'semantic_fallback' ? 'è¯­ä¹‰é™çº§' : 'æœªçŸ¥';
            const methodColor = recallType === 'dual_recall' ?
                'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' :
                'linear-gradient(135deg, #ed8936 0%, #dd6b20 100%)';
            const methodDesc = recallType === 'dual_recall' ?
                'å¹¶è¡Œæ‰§è¡Œå‘é‡å¬å›å’Œå›¾è°±å¬å›ï¼Œèåˆå»é‡åè¿”å›æœ€ä¼˜å€™é€‰' :
                'ä½¿ç”¨è¯­ä¹‰å‘é‡æ£€ç´¢è¿›è¡Œå€™é€‰æŒ‡æ ‡å¬å›';

            html += `
                <div style="background: ${methodColor}; color: white; border-radius: 12px; padding: 24px;">
                    <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">å¬å›æ–¹æ³•</div>
                    <div style="font-size: 28px; font-weight: 700;">${methodDisplay}</div>
                    <div style="margin-top: 12px; font-size: 14px; opacity: 0.85;">
                        ${methodDesc}
                    </div>
                </div>
            `;

            // å¬å›ç»Ÿè®¡
            html += `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div style="background: #f7fafc; padding: 20px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 36px; font-weight: 700; color: #667eea;">${totalCandidates}</div>
                        <div style="font-size: 14px; color: #718096; margin-top: 5px;">å€™é€‰æŒ‡æ ‡æ•°</div>
                    </div>
                    <div style="background: #f7fafc; padding: 20px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 36px; font-weight: 700; color: #48bb78;">${(vectorAvgScore * 100).toFixed(1)}%</div>
                        <div style="font-size: 14px; color: #718096; margin-top: 5px;">å‘é‡å¹³å‡åˆ†</div>
                    </div>
                    <div style="background: #f7fafc; padding: 20px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 36px; font-weight: 700; color: #4299e1;">${(graphAvgScore * 100).toFixed(1)}%</div>
                        <div style="font-size: 14px; color: #718096; margin-top: 5px;">å›¾è°±å¹³å‡åˆ†</div>
                    </div>
                </div>
            `;

            // æ¥æºåˆ†å¸ƒï¼ˆä»…åŒè·¯å¬å›æ˜¾ç¤ºï¼‰
            if (recallType === 'dual_recall') {
                html += `
                    <div style="background: white; border: 2px solid #e2e8f0; border-radius: 12px; padding: 20px;">
                        <div style="font-size: 16px; font-weight: 700; color: #2d3748; margin-bottom: 15px;">ğŸ“Š å¬å›æ¥æºåˆ†å¸ƒ</div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                            <div style="background: #ebf8ff; padding: 16px; border-radius: 10px; text-align: center;">
                                <div style="font-size: 32px; font-weight: 700; color: #4299e1;">${sourceDistribution.vector}</div>
                                <div style="font-size: 13px; color: #718096; margin-top: 5px;">å‘é‡å¬å›</div>
                            </div>
                            <div style="background: #faf5ff; padding: 16px; border-radius: 10px; text-align: center;">
                                <div style="font-size: 32px; font-weight: 700; color: #805ad5;">${sourceDistribution.graph}</div>
                                <div style="font-size: 13px; color: #718096; margin-top: 5px;">å›¾è°±å¬å›</div>
                            </div>
                            <div style="background: #f0fff4; padding: 16px; border-radius: 10px; text-align: center;">
                                <div style="font-size: 32px; font-weight: 700; color: #48bb78;">${sourceDistribution.both}</div>
                                <div style="font-size: 13px; color: #718096; margin-top: 5px;">åŒé‡å¬å›</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // å¬å›æµç¨‹è¯´æ˜ï¼ˆæ ¹æ®å¬å›ç±»å‹åŠ¨æ€æ˜¾ç¤ºï¼‰
            const isDualRecall = recallType === 'dual_recall';
            html += `
                <div style="background: white; border: 2px solid #e2e8f0; border-radius: 12px; padding: 20px;">
                    <div style="font-size: 16px; font-weight: 700; color: #2d3748; margin-bottom: 15px;">ğŸ“Š å¬å›æµç¨‹</div>
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        ${isDualRecall ? `
                        <div style="display: flex; align-items: flex-start; gap: 12px;">
                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; flex-shrink: 0;">1</div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #2d3748;">å¹¶è¡ŒåŒè·¯å¬å›</div>
                                <div style="font-size: 13px; color: #718096; margin-top: 4px;">åŒæ—¶å¯åŠ¨å‘é‡å¬å›å’Œå›¾è°±å¬å›ï¼Œå……åˆ†åˆ©ç”¨è¯­ä¹‰å’Œç»“æ„ä¿¡æ¯</div>
                            </div>
                        </div>
                        <div style="display: flex; align-items: flex-start; gap: 12px;">
                            <div style="background: #4299e1; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; flex-shrink: 0;">2a</div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #2d3748;">å‘é‡å¬å›è·¯</div>
                                <div style="font-size: 13px; color: #718096; margin-top: 4px;">ä½¿ç”¨ BAAI/bge-m3 æ¨¡å‹å‘é‡åŒ–æŸ¥è¯¢ï¼Œåœ¨ Qdrant ä¸­æ£€ç´¢ç›¸ä¼¼æŒ‡æ ‡</div>
                            </div>
                        </div>
                        <div style="display: flex; align-items: flex-start; gap: 12px;">
                            <div style="background: #805ad5; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; flex-shrink: 0;">2b</div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #2d3748;">å›¾è°±å¬å›è·¯</div>
                                <div style="font-size: 13px; color: #718096; margin-top: 4px;">åŸºäº Neo4j çŸ¥è¯†å›¾è°±ï¼Œé€šè¿‡åŒä¹‰è¯ã€å±‚æ¬¡ã€å…³è”ç­‰å¤šç­–ç•¥å¬å›</div>
                            </div>
                        </div>
                        <div style="display: flex; align-items: flex-start; gap: 12px;">
                            <div style="background: #48bb78; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; flex-shrink: 0;">3</div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #2d3748;">èåˆå»é‡</div>
                                <div style="font-size: 13px; color: #718096; margin-top: 4px;">åˆå¹¶åŒè·¯ç»“æœï¼ŒæŒ‰æ¥æºåŠ æƒï¼ˆå‘é‡70% + å›¾è°±30%ï¼‰ï¼Œå»é‡åæ’åº</div>
                            </div>
                        </div>
                        <div style="display: flex; align-items: flex-start; gap: 12px;">
                            <div style="background: #ed8936; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; flex-shrink: 0;">4</div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #2d3748;">Top-K è¿”å›</div>
                                <div style="font-size: 13px; color: #718096; margin-top: 4px;">è¿”å›èåˆåçš„ Top-K å€™é€‰æŒ‡æ ‡ï¼Œè¿›å…¥ç²¾æ’å±‚</div>
                            </div>
                        </div>
                        ` : `
                        <div style="display: flex; align-items: flex-start; gap: 12px;">
                            <div style="background: #ed8936; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; flex-shrink: 0;">1</div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #2d3748;">æŸ¥è¯¢å‘é‡åŒ–</div>
                                <div style="font-size: 13px; color: #718096; margin-top: 4px;">ä½¿ç”¨ BAAI/bge-m3 æ¨¡å‹å°†è‡ªç„¶è¯­è¨€æŸ¥è¯¢è½¬æ¢ä¸ºå‘é‡è¡¨ç¤º</div>
                            </div>
                        </div>
                        <div style="display: flex; align-items: flex-start; gap: 12px;">
                            <div style="background: #ed8936; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; flex-shrink: 0;">2</div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #2d3748;">å‘é‡ç›¸ä¼¼åº¦æ£€ç´¢</div>
                                <div style="font-size: 13px; color: #718096; margin-top: 4px;">åœ¨ Qdrant å‘é‡æ•°æ®åº“ä¸­æ£€ç´¢æœ€ç›¸ä¼¼çš„æŒ‡æ ‡å®šä¹‰</div>
                            </div>
                        </div>
                        <div style="display: flex; align-items: flex-start; gap: 12px;">
                            <div style="background: #ed8936; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; flex-shrink: 0;">3</div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #2d3748;">Top-K å€™é€‰è¿”å›</div>
                                <div style="font-size: 13px; color: #718096; margin-top: 4px;">è¿”å›ç›¸ä¼¼åº¦æœ€é«˜çš„ Top-10 å€™é€‰æŒ‡æ ‡</div>
                            </div>
                        </div>
                        `}
                    </div>
                </div>
            `;

            html += '</div>';
            container.innerHTML = html;
        }

        // èåˆç²¾æ’è¯¦æƒ…å±•ç¤º
        function displayRankingModule(data) {
            const container = document.getElementById('ranking-content');
            if (!container) return;

            // ä» all_layers ä¸­æå– L2 çš„å¬å›ä¿¡æ¯ç”¨äºå±•ç¤ºç‰¹å¾
            const l2Layer = data.all_layers?.find(l => l.layer_name.includes('L2'));

            if (!l2Layer || !l2Layer.metadata) {
                container.innerHTML = '<p style="color: #718096;">æš‚æ— ç²¾æ’è¯¦ç»†æ•°æ®ï¼ˆå½“å‰æŸ¥è¯¢å¯èƒ½ä½¿ç”¨äº† L1 è§„åˆ™å±‚æˆ– L3 LLM å±‚ï¼‰</p>';
                return;
            }

            const metadata = l2Layer.metadata;
            const candidates = metadata.candidates || [];
            const featureWeights = metadata.feature_weights || {};

            let html = '<div style="display: flex; flex-direction: column; gap: 20px;">';

            // å¦‚æœæœ‰å€™é€‰æŒ‡æ ‡æ•°æ®ï¼Œæ˜¾ç¤ºæ’åå’Œç‰¹å¾å¾—åˆ†
            if (candidates.length > 0) {
                html += `
                    <div style="background: white; border: 2px solid #48bb78; border-radius: 12px; padding: 20px;">
                        <div style="font-size: 18px; font-weight: 700; color: #2d3748; margin-bottom: 20px;">ğŸ† å€™é€‰æŒ‡æ ‡æ’åï¼ˆTop-${candidates.length}ï¼‰</div>
                        <div style="display: flex; flex-direction: column; gap: 15px;">
                `;

                candidates.forEach((candidate, index) => {
                    const rank = candidate.rank || index + 1;
                    const name = candidate.name || 'æœªçŸ¥';
                    const finalScore = candidate.final_score || 0;
                    const source = candidate.source || 'unknown';
                    const featureScores = candidate.feature_scores || {};

                    // æ¥æºæ ‡ç­¾æ ·å¼
                    const sourceStyle = source === 'both' ?
                        'background: linear-gradient(90deg, #4299e1 0%, #805ad5 100%);' :
                        source === 'vector' ? 'background: #4299e1;' :
                        source === 'graph' ? 'background: #805ad5;' : 'background: #a0aec0;';
                    const sourceText = source === 'both' ? 'åŒé‡å¬å›' :
                                     source === 'vector' ? 'å‘é‡å¬å›' :
                                     source === 'graph' ? 'å›¾è°±å¬å›' : 'æœªçŸ¥';

                    html += `
                        <div style="background: #f7fafc; border-radius: 10px; padding: 16px; border-left: 4px solid #48bb78;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <div style="background: #48bb78; color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: 700;">${rank}</div>
                                    <div style="font-size: 18px; font-weight: 700; color: #2d3748;">${name}</div>
                                    <span style="${sourceStyle} color: white; padding: 4px 12px; border-radius: 6px; font-size: 12px;">${sourceText}</span>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 24px; font-weight: 700; color: #48bb78;">${(finalScore * 100).toFixed(1)}%</div>
                                    <div style="font-size: 12px; color: #718096;">èåˆå¾—åˆ†</div>
                                </div>
                            </div>
                    `;

                    // æ˜¾ç¤ºå‰5ä¸ªæœ€é‡è¦çš„ç‰¹å¾
                    const topFeatures = Object.entries(featureScores)
                        .sort((a, b) => b[1].score - a[1].score)
                        .slice(0, 5);

                    if (topFeatures.length > 0) {
                        html += `
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; margin-top: 12px; padding-top: 12px; border-top: 1px solid #e2e8f0;">
                        `;

                        topFeatures.forEach(([featureName, featureData]) => {
                            const value = featureData.value || 0;
                            const weight = featureData.weight || 0;
                            const score = featureData.score || 0;
                            const percent = (value * 100).toFixed(1);

                            html += `
                                <div style="background: white; padding: 10px; border-radius: 8px;">
                                    <div style="font-size: 11px; color: #718096; margin-bottom: 4px;">${featureName}</div>
                                    <div style="display: flex; align-items: baseline; gap: 6px;">
                                        <span style="font-size: 16px; font-weight: 600; color: #2d3748;">${percent}%</span>
                                        <span style="font-size: 10px; color: #a0aec0;">Ã—${weight}</span>
                                    </div>
                                    <div style="width: 100%; background: #e2e8f0; height: 4px; border-radius: 2px; margin-top: 6px;">
                                        <div style="width: ${percent}%; background: linear-gradient(90deg, #48bb78 0%, #38a169 100%); height: 100%; border-radius: 2px;"></div>
                                    </div>
                                </div>
                            `;
                        });

                        html += '</div>';
                    }

                    html += '</div>';
                });

                html += '</div></div>';
            }

            // 11ç»´ç‰¹å¾è¯´æ˜
            const features = [
                { name: 'å‘é‡ç›¸ä¼¼åº¦', icon: 'ğŸ§ ', desc: 'æŸ¥è¯¢ä¸æŒ‡æ ‡çš„è¯­ä¹‰ç›¸ä¼¼åº¦', weight: featureWeights.VectorSimilarityExtractor || 0.3 },
                { name: 'å›¾è°±åˆ†æ•°', icon: 'ğŸ•¸ï¸', desc: 'åŸºäºçŸ¥è¯†å›¾è°±çš„å…³ç³»å¼ºåº¦', weight: featureWeights.GraphScoreExtractor || 0.15 },
                { name: 'æŒ‡æ ‡é‡è¦æ€§', icon: 'â­', desc: 'æŒ‡æ ‡åœ¨ä¸šåŠ¡ä¸­çš„é‡è¦ç¨‹åº¦', weight: featureWeights.ImportanceExtractor || 0.1 },
                { name: 'æŸ¥è¯¢è¯è¦†ç›–ç‡', icon: 'ğŸ“', desc: 'æŸ¥è¯¢è¯åœ¨æŒ‡æ ‡ä¸­çš„è¦†ç›–æ¯”ä¾‹', weight: featureWeights.QueryCoverageExtractor || 0.08 },
                { name: 'ç²¾ç¡®åŒ¹é…', icon: 'ğŸ¯', desc: 'æŸ¥è¯¢æ˜¯å¦ä¸æŒ‡æ ‡ç²¾ç¡®åŒ¹é…', weight: featureWeights.ExactMatchExtractor || 0.15 },
                { name: 'å‰ç¼€åŒ¹é…', icon: 'ğŸ“Œ', desc: 'æŸ¥è¯¢æ˜¯å¦ä¸æŒ‡æ ‡å‰ç¼€åŒ¹é…', weight: featureWeights.PrefixMatchExtractor || 0.05 },
                { name: 'é¢†åŸŸåŒ¹é…', icon: 'ğŸ·ï¸', desc: 'æŸ¥è¯¢ä¸æŒ‡æ ‡é¢†åŸŸçš„åŒ¹é…åº¦', weight: featureWeights.DomainMatchExtractor || 0.05 },
                { name: 'å¬å›æ¥æº', icon: 'ğŸ“', desc: 'æŒ‡æ ‡çš„å¬å›æ¸ é“æ ‡è¯†', weight: featureWeights.RecallSourceExtractor || 0.02 },
                { name: 'ç»„åˆåˆ†æ•°', icon: 'ğŸ”€', desc: 'å¤šç»´åº¦ç‰¹å¾çš„åŠ æƒèåˆ', weight: featureWeights.CombinedScoreExtractor || 0.05 },
                { name: 'æ–‡æœ¬ç›¸å…³æ€§', icon: 'ğŸ“„', desc: 'åŸºäºæ–‡æœ¬çš„ç›¸å…³æ€§è®¡ç®—', weight: featureWeights.TextRelevanceExtractor || 0.05 },
            ];

            html += `
                <div style="background: white; border: 2px solid #e2e8f0; border-radius: 12px; padding: 20px;">
                    <div style="font-size: 16px; font-weight: 700; color: #2d3748; margin-bottom: 20px;">âš–ï¸ 11ç»´ç‰¹å¾ç²¾æ’ä½“ç³»</div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px;">
            `;

            features.forEach(feature => {
                html += `
                    <div style="background: #f7fafc; padding: 16px; border-radius: 10px; border-left: 4px solid #667eea;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 24px;">${feature.icon}</span>
                                <div style="font-size: 15px; font-weight: 600; color: #2d3748;">${feature.name}</div>
                            </div>
                            <span style="font-size: 13px; color: #667eea; font-weight: 600;">æƒé‡ ${(feature.weight * 100).toFixed(0)}%</span>
                        </div>
                        <div style="font-size: 13px; color: #718096; line-height: 1.5;">${feature.desc}</div>
                    </div>
                `;
            });

            html += '</div></div>';

            // ç²¾æ’æµç¨‹è¯´æ˜
            html += `
                <div style="background: white; border: 2px solid #e2e8f0; border-radius: 12px; padding: 20px;">
                    <div style="font-size: 16px; font-weight: 700; color: #2d3748; margin-bottom: 15px;">ğŸ”„ ç²¾æ’æµç¨‹</div>
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <div style="display: flex; align-items: flex-start; gap: 12px;">
                            <div style="background: #48bb78; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; flex-shrink: 0;">1</div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #2d3748;">ç‰¹å¾æå–</div>
                                <div style="font-size: 13px; color: #718096; margin-top: 4px;">å¯¹æ¯ä¸ªå€™é€‰æŒ‡æ ‡æå– 11 ç»´ç‰¹å¾å‘é‡</div>
                            </div>
                        </div>
                        <div style="display: flex; align-items: flex-start; gap: 12px;">
                            <div style="background: #48bb78; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; flex-shrink: 0;">2</div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #2d3748;">ç‰¹å¾å½’ä¸€åŒ–</div>
                                <div style="font-size: 13px; color: #718096; margin-top: 4px;">å¯¹ä¸åŒé‡çº²çš„ç‰¹å¾è¿›è¡Œ Min-Max å½’ä¸€åŒ–</div>
                            </div>
                        </div>
                        <div style="display: flex; align-items: flex-start; gap: 12px;">
                            <div style="background: #48bb78; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; flex-shrink: 0;">3</div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #2d3748;">åŠ æƒèåˆ</div>
                                <div style="font-size: 13px; color: #718096; margin-top: 4px;">ä½¿ç”¨é¢„å®šä¹‰æƒé‡è®¡ç®—æœ€ç»ˆå¾—åˆ† = Î£(ç‰¹å¾å€¼ Ã— æƒé‡)</div>
                            </div>
                        </div>
                        <div style="display: flex; align-items: flex-start; gap: 12px;">
                            <div style="background: #48bb78; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; flex-shrink: 0;">4</div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #2d3748;">æ’åºé‡æ’</div>
                                <div style="font-size: 13px; color: #718096; margin-top: 4px;">æŒ‰æœ€ç»ˆå¾—åˆ†é‡æ–°æ’åºï¼Œè¿”å› Top-K ç»“æœ</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            html += '</div>';
            container.innerHTML = html;
        }

        // æ ¹å› åˆ†æå±•ç¤º
        function displayRootCauseModule(data) {
            const container = document.getElementById('root-cause-content');
            if (!container) return;

            const rootCause = data.root_cause_analysis;

            if (!rootCause) {
                container.innerHTML = '<p style="color: #718096;">æš‚æ— æ ¹å› åˆ†ææ•°æ®ã€‚è¯·å°è¯•ä½¿ç”¨åŒ…å«"ä¸ºä»€ä¹ˆ"ã€"åˆ†æ"ç­‰å…³é”®è¯çš„æŸ¥è¯¢ï¼ˆå¦‚ï¼š"ä¸ºä»€ä¹ˆGMVä¸‹é™äº†ï¼Ÿ"ï¼‰ã€‚</p>';
                return;
            }

            let html = '<div style="display: flex; flex-direction: column; gap: 24px;">';

            // åˆ†ææŠ¥å‘Šå¡ç‰‡
            html += `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 12px; padding: 24px;">
                    <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">ğŸ” æ ¹å› åˆ†ææŠ¥å‘Š</div>
                    <div style="font-size: 18px; font-weight: 700; line-height: 1.6; white-space: pre-wrap;">${rootCause.report}</div>
                </div>
            `;

            // å¼‚å¸¸æ£€æµ‹
            if (rootCause.anomalies && rootCause.anomalies.length > 0) {
                html += `
                    <div style="background: white; border: 2px solid #e2e8f0; border-radius: 12px; padding: 20px;">
                        <div style="font-size: 18px; font-weight: 700; color: #2d3748; margin-bottom: 16px;">âš ï¸ æ£€æµ‹åˆ°çš„å¼‚å¸¸</div>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                `;

                rootCause.anomalies.forEach(anomaly => {
                    const severityColor = {
                        'high': '#f56565',
                        'medium': '#ed8936',
                        'low': '#48bb78'
                    }[anomaly.severity] || '#718096';

                    const typeIcon = {
                        'spike': 'ğŸ“ˆ',
                        'dip': 'ğŸ“‰',
                        'high': 'â¬†ï¸',
                        'low': 'â¬‡ï¸'
                    }[anomaly.type] || 'â“';

                    html += `
                        <div style="background: ${severityColor}10; border-left: 4px solid ${severityColor}; padding: 16px; border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <div style="font-size: 20px;">${typeIcon}</div>
                                <div style="font-size: 12px; padding: 4px 12px; background: ${severityColor}; color: white; border-radius: 6px; font-weight: 600;">
                                    ${anomaly.severity === 'high' ? 'é«˜ä¸¥é‡åº¦' : anomaly.severity === 'medium' ? 'ä¸­ç­‰' : 'ä½'}
                                </div>
                            </div>
                            <div style="font-size: 14px; font-weight: 600; color: #2d3748; margin-bottom: 4px;">
                                ${anomaly.timestamp}
                            </div>
                            <div style="font-size: 13px; color: #718096;">
                                å®é™…å€¼: ${anomaly.value.toFixed(2)} | æœŸæœ›å€¼: ${anomaly.expected.toFixed(2)}
                            </div>
                            <div style="font-size: 13px; color: ${severityColor}; font-weight: 600; margin-top: 4px;">
                                åç¦»åº¦: ${anomaly.deviation_pct.toFixed(1)}%
                            </div>
                        </div>
                    `;
                });

                html += `
                        </div>
                    </div>
                `;
            }

            // è¶‹åŠ¿åˆ†æ
            if (rootCause.trends) {
                const trend = rootCause.trends;
                const trendIcon = {
                    'upward': 'ğŸ“ˆ',
                    'downward': 'ğŸ“‰',
                    'stable': 'â¡ï¸',
                    'volatile': 'ğŸ“Š'
                }[trend.trend_type] || 'â“';

                html += `
                    <div style="background: white; border: 2px solid #e2e8f0; border-radius: 12px; padding: 20px;">
                        <div style="font-size: 18px; font-weight: 700; color: #2d3748; margin-bottom: 16px;">ğŸ“ˆ è¶‹åŠ¿åˆ†æ</div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div style="background: #f7fafc; padding: 16px; border-radius: 10px; text-align: center;">
                                <div style="font-size: 32px;">${trendIcon}</div>
                                <div style="font-size: 14px; color: #718096; margin-top: 8px;">è¶‹åŠ¿ç±»å‹</div>
                                <div style="font-size: 16px; font-weight: 600; color: #2d3748;">${trend.trend_type}</div>
                            </div>
                            <div style="background: #f7fafc; padding: 16px; border-radius: 10px; text-align: center;">
                                <div style="font-size: 32px;">${(trend.trend_strength * 100).toFixed(0)}%</div>
                                <div style="font-size: 14px; color: #718096; margin-top: 8px;">è¶‹åŠ¿å¼ºåº¦</div>
                            </div>
                            <div style="background: #f7fafc; padding: 16px; border-radius: 10px; text-align: center;">
                                <div style="font-size: 32px;">${trend.slope.toFixed(2)}</div>
                                <div style="font-size: 14px; color: #718096; margin-top: 8px;">æ–œç‡</div>
                            </div>
                            <div style="background: #f7fafc; padding: 16px; border-radius: 10px; text-align: center;">
                                <div style="font-size: 32px;">${(trend.r_squared * 100).toFixed(1)}%</div>
                                <div style="font-size: 14px; color: #718096; margin-top: 8px;">æ‹Ÿåˆåº¦</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // ç»´åº¦åˆ†è§£
            if (rootCause.dimensions && rootCause.dimensions.length > 0) {
                html += `
                    <div style="background: white; border: 2px solid #e2e8f0; border-radius: 12px; padding: 20px;">
                        <div style="font-size: 18px; font-weight: 700; color: #2d3748; margin-bottom: 16px;">ğŸ“Š ç»´åº¦åˆ†è§£åˆ†æ</div>
                `;

                rootCause.dimensions.forEach(dim => {
                    html += `
                        <div style="margin-bottom: 20px; padding: 16px; background: #f7fafc; border-radius: 10px;">
                            <div style="font-size: 16px; font-weight: 600; color: #2d3748; margin-bottom: 12px;">${dim.dimension_name}ç»´åº¦</div>
                            <div style="font-size: 13px; color: #48bb78; margin-bottom: 16px;">${dim.analysis}</div>
                            <div style="display: flex; flex-direction: column; gap: 8px;">
                    `;

                    dim.top_contributors.forEach(contributor => {
                        const pct = contributor.contribution_pct;
                        html += `
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div style="width: 100px; font-size: 13px; color: #2d3748; font-weight: 500;">${contributor.name}</div>
                                <div style="flex: 1; background: #e2e8f0; height: 20px; border-radius: 10px; position: relative; overflow: hidden;">
                                    <div style="position: absolute; left: 0; top: 0; height: 100%; width: ${pct}%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);"></div>
                                </div>
                                <div style="width: 60px; font-size: 13px; color: #667eea; font-weight: 600; text-align: right;">${pct.toFixed(1)}%</div>
                            </div>
                        `;
                    });

                    html += `
                            </div>
                        </div>
                    `;
                });

                html += `
                    </div>
                `;
            }

            // å› æœæ¨æ–­
            if (rootCause.causal_factors && rootCause.causal_factors.length > 0) {
                html += `
                    <div style="background: white; border: 2px solid #e2e8f0; border-radius: 12px; padding: 20px;">
                        <div style="font-size: 18px; font-weight: 700; color: #2d3748; margin-bottom: 16px;">ğŸ”— æ½œåœ¨åŸå› åˆ†æ</div>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                `;

                rootCause.causal_factors.forEach(factor => {
                    const categoryColor = {
                        'internal': '#4299e1',
                        'external': '#ed8936',
                        'structural': '#48bb78'
                    }[factor.category] || '#718096';

                    const categoryIcon = {
                        'internal': 'ğŸ¢',
                        'external': 'ğŸŒ',
                        'structural': 'ğŸ—ï¸'
                    }[factor.category] || 'â“';

                    html += `
                        <div style="border: 2px solid ${categoryColor}; border-radius: 10px; padding: 16px;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <span style="font-size: 24px;">${categoryIcon}</span>
                                    <div style="font-size: 16px; font-weight: 700; color: #2d3748;">${factor.name}</div>
                                </div>
                                                                <div style="font-size: 14px; padding: 4px 12px; background: ${categoryColor}; color: white; border-radius: 6px; font-weight: 600;">
                                    ${(factor.confidence * 100).toFixed(0)}% ç½®ä¿¡åº¦
                                                                </div>
                            </div>
                            <div style="font-size: 13px; color: #718096; line-height: 1.6; margin-bottom: 12px;">
                                ${factor.explanation}
                            </div>
                            <div style="font-size: 12px; color: #718096;">
                                <strong>è¯æ®ï¼š</strong>
                                ${factor.evidence.map(e => `<span style="display: inline-block; background: #f7fafc; padding: 2px 8px; border-radius: 4px; margin: 2px;">${e}</span>`).join('')}
                            </div>
                        </div>
                    `;
                });

                html += `
                        </div>
                    </div>
                `;
            }

            // è¡ŒåŠ¨å»ºè®®
            if (rootCause.recommendations && rootCause.recommendations.length > 0) {
                html += `
                    <div style="background: white; border: 2px solid #48bb78; border-radius: 12px; padding: 20px;">
                        <div style="font-size: 18px; font-weight: 700; color: #2d3748; margin-bottom: 16px;">ğŸ’¡ è¡ŒåŠ¨å»ºè®®</div>
                        <ul style="margin: 0; padding-left: 20px;">
                `;

                rootCause.recommendations.forEach(rec => {
                    html += `
                        <li style="margin-bottom: 8px; font-size: 14px; color: #2d3748; line-height: 1.6;">${rec}</li>
                    `;
                });

                html += `
                        </ul>
                    </div>
                `;
            }

            html += '</div>';
            container.innerHTML = html;
        }

        // é¡µé¢åŠ è½½åè‡ªåŠ¨æ‰§è¡Œ
        window.onload = function() {
            // åŠ è½½ä¼šè¯å†å²
            loadConversationHistory();

            // å›è½¦é”®æ”¯æŒ
            document.getElementById('queryInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') executeQuery();
            });

            // ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­
            document.getElementById('conversationDetailModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeConversationDetail();
                }
            });

            // å¦‚æœæ²¡æœ‰å†å²è®°å½•ï¼Œè‡ªåŠ¨æ‰§è¡Œç¤ºä¾‹æŸ¥è¯¢
            if (conversationHistory.length === 0) {
                setTimeout(() => executeQuery(), 500);
            }
        };
    </script>
</body>
</html>
