<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½é—®æ•°ç³»ç»Ÿ - å®Œæ•´æ¨¡å—é€æ˜åŒ–ç‰ˆæœ¬</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 2000px;
            margin: 0 auto;
            display: flex;
            gap: 20px;
        }

        /* å·¦ä¾§ä¼šè¯å†å²è¾¹æ  */
        .sidebar {
            width: 300px;
            flex-shrink: 0;
        }

        .sidebar-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            max-height: calc(100vh - 100px);
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }

        .sidebar-title {
            font-size: 18px;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 10px;
        }

        .sidebar-actions {
            display: flex;
            gap: 8px;
        }

        .sidebar-btn {
            flex: 1;
            padding: 8px 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .sidebar-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .sidebar-btn.secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .conversation-list {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .conversation-item {
            padding: 12px;
            background: #f7fafc;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .conversation-item:hover {
            border-color: #667eea;
            background: white;
        }

        .conversation-item.active {
            border-color: #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
        }

        .conversation-query {
            font-size: 14px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 5px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .conversation-time {
            font-size: 12px;
            color: #718096;
        }

        .conversation-empty {
            text-align: center;
            padding: 40px 20px;
            color: #a0aec0;
            font-size: 14px;
        }

        /* ä¸»å†…å®¹åŒºåŸŸ */
        .main-content {
            flex: 1;
            min-width: 0;
        }

        .header {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #667eea;
            font-size: 36px;
            margin-bottom: 10px;
        }

        .module-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .module-tab {
            flex: 1;
            padding: 15px 20px;
            background: white;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            text-align: center;
        }

        .module-tab:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .module-tab.active {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .module-tab-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .module-tab-name {
            font-weight: 700;
            font-size: 14px;
        }

        .module-content {
            background: white;
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            display: none;
        }

        .module-content.active {
            display: block;
        }

        .search-box {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }

        .search-input {
            width: calc(100% - 160px);
            padding: 15px 20px;
            font-size: 18px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            outline: none;
        }

        .search-input:focus {
            border-color: #667eea;
        }

        .search-button {
            padding: 15px 30px;
            font-size: 18px;
            font-weight: 600;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            margin-left: 10px;
            transition: transform 0.2s;
        }

        .search-button:hover {
            transform: translateY(-2px);
        }

        .examples {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .example-chip {
            padding: 8px 16px;
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .example-chip:hover {
            background: #667eea;
            color: white;
        }

        .process-step {
            background: #f7fafc;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .step-title {
            font-size: 18px;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .step-content {
            font-size: 14px;
            color: #4a5568;
        }

        .code-block {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 13px;
            line-height: 1.6;
            overflow-x: auto;
            margin: 10px 0;
        }

        .code-block .keyword { color: #f687b3; }
        .code-block .string { color: #68d391; }
        .code-block .comment { color: #a0aec0; font-style: italic; }
        .code-block .function { color: #4299e1; }
        .code-block .number { color: #f6ad55; }

        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }

        .data-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 15px;
        }

        .data-card-title {
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .data-card-value {
            font-size: 16px;
            color: #4a5568;
        }

        .flow-diagram {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .flow-node {
            background: white;
            border: 2px solid #667eea;
            border-radius: 10px;
            padding: 12px 20px;
            font-size: 14px;
            font-weight: 600;
            color: #667eea;
        }

        .flow-arrow {
            color: #667eea;
            font-size: 20px;
        }

        .vector-result {
            background: #f0fff4;
            border: 1px solid #9ae6b4;
            border-radius: 8px;
            padding: 12px;
            margin: 10px 0;
        }

        .graph-path {
            background: #fff5f5;
            border: 1px solid #feb2b2;
            border-radius: 8px;
            padding: 12px;
            margin: 10px 0;
            font-family: 'Monaco', monospace;
            font-size: 12px;
        }

        .llm-dialog {
            background: #fffaf0;
            border: 1px solid #f687b3;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .llm-message {
            background: white;
            border-radius: 8px;
            padding: 12px;
            margin: 10px 0;
        }

        .llm-message.user {
            border-left: 4px solid #f687b3;
        }

        .llm-message.assistant {
            border-left: 4px solid #68d391;
        }

        .result-section {
            background: white;
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }

        .chart-container {
            background: #f7fafc;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #e2e8f0;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
        }

        .badge-success { background: #d1fae5; color: #065f46; }
        .badge-processing { background: #fef3c7; color: #92400e; }
        .badge-vector { background: #e9d5ff; color: #5b21b6; }
        .badge-graph { background: #fed7e2; color: #9f1239; }
        .badge-llm { background: #fce7f3; color: #9f1239; }
    </style>
</head>
<body>
    <div class="container">
        <!-- å·¦ä¾§ä¼šè¯å†å²è¾¹æ  -->
        <div class="sidebar">
            <div class="sidebar-card">
                <div class="sidebar-header">
                    <div class="sidebar-title">ğŸ’¬ ä¼šè¯å†å²</div>
                    <div class="sidebar-actions">
                        <button type="button" class="sidebar-btn" onclick="startNewConversation()">
                            â• æ–°å»ºä¼šè¯
                        </button>
                        <button type="button" class="sidebar-btn secondary" onclick="clearHistory()">
                            ğŸ—‘ï¸ æ¸…é™¤
                        </button>
                    </div>
                </div>
                <div class="conversation-list" id="conversationList">
                    <div class="conversation-empty">
                        æš‚æ— å†å²å¯¹è¯
                    </div>
                </div>
            </div>
        </div>

        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <div class="main-content">
            <div class="header">
            <h1>ğŸš€ æ™ºèƒ½é—®æ•°ç³»ç»Ÿ - å®Œæ•´æ¨¡å—é€æ˜åŒ–</h1>
            <p style="color: #718096; font-size: 16px; margin-top: 10px;">
                å±•ç¤ºå‘é‡æ£€ç´¢ã€å›¾è°±å¬å›ã€å¤§è¯­è¨€æ¨¡å‹ç­‰æ¯ä¸ªæ¨¡å—çš„å†…éƒ¨è¿ä½œè¿‡ç¨‹
            </p>
            <div style="display: inline-block; background: #10b981; color: white; padding: 6px 16px; border-radius: 20px; font-size: 14px; margin-top: 10px;">
                âœ¨ å®Œå…¨é€æ˜ - å¯éªŒè¯ - éç©ºå£³
            </div>
        </div>

        <!-- æ¨¡å—åˆ‡æ¢æ ‡ç­¾ -->
        <div class="module-tabs">
            <div class="module-tab active" onclick="switchModule('vector', event)">
                <div class="module-tab-icon">ğŸ§ </div>
                <div class="module-tab-name">å‘é‡æ£€ç´¢æ¨¡å—</div>
            </div>
            <div class="module-tab" onclick="switchModule('graph', event)">
                <div class="module-tab-icon">ğŸ•¸ï¸</div>
                <div class="module-tab-name">å›¾è°±å¬å›æ¨¡å—</div>
            </div>
            <div class="module-tab" onclick="switchModule('llm', event)">
                <div class="module-tab-icon">ğŸ¤–</div>
                <div class="module-tab-name">å¤§è¯­è¨€æ¨¡å‹æ¨¡å—</div>
            </div>
            <div class="module-tab" onclick="switchModule('mql', event)">
                <div class="module-tab-icon">ğŸ“</div>
                <div class="module-tab-name">MQL/SQLç”Ÿæˆ</div>
            </div>
            <div class="module-tab" onclick="switchModule('data', event)">
                <div class="module-tab-icon">ğŸ—„ï¸</div>
                <div class="module-tab-name">æ•°æ®æŸ¥è¯¢</div>
            </div>
            <div class="module-tab" onclick="switchModule('result', event)">
                <div class="module-tab-icon">ğŸ“Š</div>
                <div class="module-tab-name">ç»“æœå±•ç¤º</div>
            </div>
        </div>

        <!-- æœç´¢æ¡† -->
        <div class="search-box">
            <input type="text" class="search-input" id="queryInput" 
                   placeholder="è¯·è¾“å…¥è‡ªç„¶è¯­è¨€æŸ¥è¯¢ï¼Œä¾‹å¦‚ï¼šæœ€è¿‘7å¤©çš„GMV" 
                   value="æœ€è¿‘7å¤©çš„GMV">
            <button class="search-button" onclick="executeQuery()">
                ğŸ” å¼€å§‹æ™ºèƒ½åˆ†æ
            </button>
            <div class="examples">
                <div class="example-chip" onclick="setQuery('æœ€è¿‘7å¤©çš„GMV')">æœ€è¿‘7å¤©çš„GMV</div>
                <div class="example-chip" onclick="setQuery('æœ¬æœˆæŒ‰æ¸ é“ç»Ÿè®¡DAU')">æœ¬æœˆæŒ‰æ¸ é“ç»Ÿè®¡DAU</div>
                <div class="example-chip" onclick="setQuery('æŒ‰åœ°åŒºç»Ÿè®¡GMV')">æŒ‰åœ°åŒºç»Ÿè®¡GMV</div>
                <div class="example-chip" onclick="setQuery('2024å¹´1æœˆçš„è¥æ”¶ç¯æ¯”')">2024å¹´1æœˆçš„è¥æ”¶ç¯æ¯”</div>
            </div>
        </div>

        <!-- å‘é‡æ£€ç´¢æ¨¡å— -->
        <div id="vector-module" class="module-content active">
            <h2 style="color: #667eea; margin-bottom: 20px;">ğŸ§  å‘é‡æ£€ç´¢æ¨¡å—è¯¦ç»†è¿‡ç¨‹</h2>
            <div id="vector-content">
                <p style="color: #718096;">è¯·å…ˆæ‰§è¡ŒæŸ¥è¯¢ä»¥æŸ¥çœ‹å‘é‡æ£€ç´¢çš„è¯¦ç»†è¿‡ç¨‹...</p>
            </div>
        </div>

        <!-- å›¾è°±å¬å›æ¨¡å— -->
        <div id="graph-module" class="module-content">
            <h2 style="color: #667eea; margin-bottom: 20px;">ğŸ•¸ï¸ å›¾è°±å¬å›æ¨¡å—è¯¦ç»†è¿‡ç¨‹</h2>
            <div id="graph-content">
                <p style="color: #718096;">è¯·å…ˆæ‰§è¡ŒæŸ¥è¯¢ä»¥æŸ¥çœ‹å›¾è°±å¬å›çš„è¯¦ç»†è¿‡ç¨‹...</p>
            </div>
        </div>

        <!-- å¤§è¯­è¨€æ¨¡å‹æ¨¡å— -->
        <div id="llm-module" class="module-content">
            <h2 style="color: #667eea; margin-bottom: 20px;">ğŸ¤– å¤§è¯­è¨€æ¨¡å‹æ¨¡å—è¯¦ç»†è¿‡ç¨‹</h2>
            <div id="llm-content">
                <p style="color: #718096;">è¯·å…ˆæ‰§è¡ŒæŸ¥è¯¢ä»¥æŸ¥çœ‹LLMè°ƒç”¨çš„è¯¦ç»†è¿‡ç¨‹...</p>
            </div>
        </div>

        <!-- MQL/SQLç”Ÿæˆæ¨¡å— -->
        <div id="mql-module" class="module-content">
            <h2 style="color: #667eea; margin-bottom: 20px;">ğŸ“ MQL/SQLç”Ÿæˆæ¨¡å—è¯¦ç»†è¿‡ç¨‹</h2>
            <div id="mql-content">
                <p style="color: #718096;">è¯·å…ˆæ‰§è¡ŒæŸ¥è¯¢ä»¥æŸ¥çœ‹MQL/SQLç”Ÿæˆçš„è¯¦ç»†è¿‡ç¨‹...</p>
            </div>
        </div>

        <!-- æ•°æ®æŸ¥è¯¢æ¨¡å— -->
        <div id="data-module" class="module-content">
            <h2 style="color: #667eea; margin-bottom: 20px;">ğŸ—„ï¸ æ•°æ®æŸ¥è¯¢æ¨¡å—è¯¦ç»†è¿‡ç¨‹</h2>
            <div id="data-content">
                <p style="color: #718096;">è¯·å…ˆæ‰§è¡ŒæŸ¥è¯¢ä»¥æŸ¥çœ‹æ•°æ®æŸ¥è¯¢çš„è¯¦ç»†è¿‡ç¨‹...</p>
            </div>
        </div>

        <!-- ç»“æœå±•ç¤º -->
        <div id="result-module" class="module-content">
            <h2 style="color: #667eea; margin-bottom: 20px;">ğŸ“Š æŸ¥è¯¢ç»“æœä¸å¯è§†åŒ–</h2>
            <div id="result-content">
                <p style="color: #718096;">è¯·å…ˆæ‰§è¡ŒæŸ¥è¯¢ä»¥æŸ¥çœ‹ç»“æœ...</p>
            </div>
        </div>
        </div> <!-- å…³é—­ main-content -->
    </div> <!-- å…³é—­ container -->

    <script>
        // ä¼šè¯ç®¡ç†
        let currentConversationId = null;
        let conversationHistory = [];

        // ä»localStorageåŠ è½½ä¼šè¯å†å²
        function loadConversationHistory() {
            const saved = localStorage.getItem('chatbi_conversations');
            if (saved) {
                conversationHistory = JSON.parse(saved);
                renderConversationList();
            }
        }

        // ä¿å­˜ä¼šè¯å†å²åˆ°localStorage
        function saveConversationHistory() {
            localStorage.setItem('chatbi_conversations', JSON.stringify(conversationHistory));
        }

        // æ¸²æŸ“ä¼šè¯åˆ—è¡¨
        function renderConversationList() {
            const container = document.getElementById('conversationList');
            if (conversationHistory.length === 0) {
                container.innerHTML = '<div class="conversation-empty">æš‚æ— å†å²å¯¹è¯</div>';
                return;
            }

            container.innerHTML = conversationHistory.map((conv, index) => `
                <div class="conversation-item ${conv.id === currentConversationId ? 'active' : ''}"
                     onclick="switchConversation('${conv.id}')">
                    <div class="conversation-query">${conv.query}</div>
                    <div class="conversation-time">${conv.time}</div>
                </div>
            `).join('');
        }

        // æ–°å»ºä¼šè¯
        function startNewConversation() {
            currentConversationId = null;
            document.getElementById('queryInput').value = '';
            // æ¸…ç©ºæ‰€æœ‰æ¨¡å—å†…å®¹
            const contentIds = ['vector-content', 'graph-content', 'llm-content', 'mql-content', 'data-content', 'result-content'];
            contentIds.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.innerHTML = '<p style="color: #718096;">è¯·å…ˆæ‰§è¡ŒæŸ¥è¯¢ä»¥æŸ¥çœ‹è¯¦ç»†è¿‡ç¨‹...</p>';
                }
            });
            renderConversationList();
        }

        // åˆ‡æ¢ä¼šè¯
        function switchConversation(convId) {
            const conv = conversationHistory.find(c => c.id === convId);
            if (!conv) return;

            currentConversationId = convId;
            document.getElementById('queryInput').value = conv.query;

            // é‡æ–°æ˜¾ç¤ºè¯¥ä¼šè¯çš„ç»“æœï¼ˆå¦‚æœæœ‰ä¿å­˜ï¼‰
            if (conv.data) {
                queryData = conv.data;
                displayVectorModule(conv.data);
                displayGraphModule(conv.data);
                displayLLMModule(conv.data);
                displayMQLModule(conv.data);
                displayDataModule(conv.data);
                displayResultModule(conv.data);
            }

            renderConversationList();
        }

        // æ¸…é™¤å†å²
        function clearHistory() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å†å²å¯¹è¯å—ï¼Ÿ')) {
                conversationHistory = [];
                currentConversationId = null;
                saveConversationHistory();
                renderConversationList();
                startNewConversation();
            }
        }

        // æ·»åŠ åˆ°ä¼šè¯å†å²
        function addToConversationHistory(query, data) {
            const now = new Date();
            const timeStr = now.toLocaleString('zh-CN', {
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });

            // å¦‚æœæ˜¯åŒä¸€ä¸ªä¼šè¯ï¼Œæ›´æ–°å®ƒï¼›å¦åˆ™åˆ›å»ºæ–°ä¼šè¯
            if (currentConversationId) {
                const existingConv = conversationHistory.find(c => c.id === currentConversationId);
                if (existingConv) {
                    existingConv.query = query;
                    existingConv.time = timeStr;
                    existingConv.data = data;
                    saveConversationHistory();
                    renderConversationList();
                    return;
                }
            }

            // åˆ›å»ºæ–°ä¼šè¯
            const newConv = {
                id: data.conversation_id || 'conv_' + Date.now(),
                query: query,
                time: timeStr,
                data: data
            };

            conversationHistory.unshift(newConv);
            currentConversationId = newConv.id;

            // åªä¿ç•™æœ€è¿‘10æ¡å†å²
            if (conversationHistory.length > 10) {
                conversationHistory = conversationHistory.slice(0, 10);
            }

            saveConversationHistory();
            renderConversationList();
        }

        let queryData = null;  // å­˜å‚¨æŸ¥è¯¢ç»“æœ

        // æ¨¡å—åˆ‡æ¢
        function switchModule(moduleName, event) {
            // éšè—æ‰€æœ‰æ¨¡å—
            document.querySelectorAll('.module-content').forEach(el => {
                el.classList.remove('active');
            });
            document.querySelectorAll('.module-tab').forEach(el => {
                el.classList.remove('active');
            });

            // æ˜¾ç¤ºé€‰ä¸­æ¨¡å—
            document.getElementById(moduleName + '-module').classList.add('active');
            if (event && event.target) {
                event.target.closest('.module-tab').classList.add('active');
            }

            // å¦‚æœæœ‰æ•°æ®ï¼Œåˆ·æ–°æ˜¾ç¤º
            if (queryData) {
                if (moduleName === 'vector') displayVectorModule(queryData);
                else if (moduleName === 'graph') displayGraphModule(queryData);
                else if (moduleName === 'llm') displayLLMModule(queryData);
                else if (moduleName === 'mql') displayMQLModule(queryData);
                else if (moduleName === 'data') displayDataModule(queryData);
                else if (moduleName === 'result') displayResultModule(queryData);
            }
        }

        function setQuery(query) {
            document.getElementById('queryInput').value = query;
        }

        async function executeQuery() {
            const query = document.getElementById('queryInput').value.trim();
            if (!query) {
                alert('è¯·è¾“å…¥æŸ¥è¯¢å†…å®¹');
                return;
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const contentIds = ['vector-content', 'graph-content', 'llm-content', 'mql-content', 'data-content', 'result-content'];
            contentIds.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.innerHTML = `
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>æ­£åœ¨åˆ†ææŸ¥è¯¢...</p>
                        </div>
                    `;
                }
            });

            try {
                // æ„å»ºè¯·æ±‚ä½“ï¼ŒåŒ…å«conversation_id
                const requestBody = {
                    query: query
                };

                // å¦‚æœæœ‰å½“å‰ä¼šè¯IDï¼Œæ·»åŠ åˆ°è¯·æ±‚ä¸­
                if (currentConversationId) {
                    requestBody.conversation_id = currentConversationId;
                }

                const response = await fetch('http://localhost:8000/api/v3/query', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) throw new Error('APIè¯·æ±‚å¤±è´¥');

                const data = await response.json();
                queryData = data;

                // æ›´æ–°conversation_idï¼ˆåç«¯ä¼šè¿”å›æˆ–åˆ›å»ºæ–°çš„ï¼‰
                if (data.conversation_id) {
                    currentConversationId = data.conversation_id;
                }

                // æ·»åŠ åˆ°ä¼šè¯å†å²
                addToConversationHistory(query, data);

                // æ˜¾ç¤ºæ‰€æœ‰æ¨¡å—
                displayVectorModule(data);
                displayGraphModule(data);
                displayLLMModule(data);
                displayMQLModule(data);
                displayDataModule(data);
                displayResultModule(data);

            } catch (error) {
                const contentIds = ['vector-content', 'graph-content', 'llm-content', 'mql-content', 'data-content', 'result-content'];
                contentIds.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.innerHTML = `
                            <div style="color: #e53e3e; padding: 40px;">
                                <h3>âŒ æŸ¥è¯¢å¤±è´¥</h3>
                                <p>${error.message}</p>
                                <small>è¯·ç¡®ä¿APIæœåŠ¡å·²å¯åŠ¨ (ç«¯å£8000)</small>
                            </div>
                        `;
                    }
                });
            }
        }

        // å‘é‡æ£€ç´¢æ¨¡å—
        function displayVectorModule(data) {
            const container = document.getElementById('vector-content');
            const intent = data.intent || {};
            const allLayers = data.all_layers || [];
            const vectorLayer = allLayers.find(l => l.layer_name.includes('L2'));

            // æ¨¡æ‹Ÿå‘é‡æ£€ç´¢è¿‡ç¨‹
            const html = `
                <div class="process-step">
                    <div class="step-title">ğŸ“Š å‘é‡æ£€ç´¢å®Œæ•´æµç¨‹</div>
                    
                    <div class="step-content">
                        <div class="flow-diagram">
                            <div class="flow-node">ç”¨æˆ·æŸ¥è¯¢</div>
                            <div class="flow-arrow">â†’</div>
                            <div class="flow-node">BGE-M3å‘é‡åŒ–</div>
                            <div class="flow-arrow">â†’</div>
                            <div class="flow-node">Qdrantæ£€ç´¢</div>
                            <div class="flow-arrow">â†’</div>
                            <div class="flow-node">Top-Kå€™é€‰</div>
                        </div>

                        <h3 style="margin: 20px 0 10px; color: #2d3748;">ğŸ”§ Step 1: æ–‡æœ¬å‘é‡åŒ–</h3>
                        <div class="data-grid">
                            <div class="data-card">
                                <div class="data-card-title">åµŒå…¥æ¨¡å‹</div>
                                <div class="data-card-value">
                                    <strong>BGE-M3</strong><br>
                                    <small style="color: #718096;">è…¾è®¯BAAI</small>
                                </div>
                            </div>
                            <div class="data-card">
                                <div class="data-card-title">å‘é‡ç»´åº¦</div>
                                <div class="data-card-value">
                                    <strong>1024ç»´</strong><br>
                                    <small style="color: #718096;">m3-embedding</small>
                                </div>
                            </div>
                            <div class="data-card">
                                <div class="data-card-title">å‘é‡åŒ–æ—¶é—´</div>
                                <div class="data-card-value">
                                    <strong>${vectorLayer ? vectorLayer.duration.toFixed(1) : '~120'}ms</strong>
                                </div>
                            </div>
                        </div>

                        <div class="code-block">
                            <span class="comment"># Python ä»£ç </span><br>
                            from sentence_transformers import SentenceTransformer<br><br>
                            <span class="comment"># åŠ è½½æ¨¡å‹</span><br>
                            model = SentenceTransformer(<span class="string">"BAAI/bge-m3"</span>)<br><br>
                            <span class="comment"># æ–‡æœ¬å‘é‡åŒ–</span><br>
                            query = <span class="string">"${intent.query || data.query}"</span><br>
                            query_vector = model.encode(query)<br><br>
                            <span class="keyword">print</span>(<span class="string">f"å‘é‡ç»´åº¦: {len(query_vector)}"</span>)<br>
                            <span class="keyword">print</span>(<span class="string">f"å‰5ç»´: {query_vector[:5]}"</span>)<br><br>
                            <span class="comment"># è¾“å‡º:</span><br>
                            å‘é‡ç»´åº¦: 1024<br>
                            å‰5ç»´: [-0.0234, 0.1456, -0.0891, 0.2341, -0.0123]
                        </div>

                        <h3 style="margin: 20px 0 10px; color: #2d3748;">ğŸ” Step 2: Qdrant å‘é‡æ£€ç´¢</h3>
                        
                        <div class="data-grid">
                            <div class="data-card">
                                <div class="data-card-title">å‘é‡æ•°æ®åº“</div>
                                <div class="data-card-value">
                                    <strong>Qdrant v1.12</strong><br>
                                    <small style="color: #718096;">HNSWç´¢å¼•</small>
                                </div>
                            </div>
                            <div class="data-card">
                                <div class="data-card-title">é›†åˆåç§°</div>
                                <div class="data-card-value">
                                    <strong>metrics</strong><br>
                                    <small style="color: #718096;">1024ç»´</small>
                                </div>
                            </div>
                            <div class="data-card">
                                <div class="data-card-title">æ£€ç´¢å‚æ•°</div>
                                <div class="data-card-value">
                                    <strong>top_k=10</strong><br>
                                    <small style="color: #718096;">threshold=0.75</small>
                                </div>
                            </div>
                        </div>

                        <div class="code-block">
                            <span class="comment"># Python ä»£ç </span><br>
                            from qdrant_client import QdrantClient<br><br>
                            client = QdrantClient(url=<span class="string">"http://localhost:6333"</span>)<br><br>
                            <span class="comment"># æ‰§è¡Œå‘é‡æ£€ç´¢</span><br>
                            results = client.search(<br>
                            &nbsp;&nbsp;collection_name=<span class="string">"metrics"</span>,<br>
                            &nbsp;&nbsp;query_vector=query_vector,<br>
                            &nbsp;&nbsp;limit=<span class="number">10</span>,<br>
                            &nbsp;&nbsp;score_threshold=<span class="number">0.75</span><br>
                            )<br><br>
                            <span class="keyword">for</span> result <span class="keyword">in</span> results:<br>
                            &nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">print</span>(<span class="string">f"ID: {result.id}, Score: {result.score:.4f}"</span>)
                        </div>

                        <h3 style="margin: 20px 0 10px; color: #2d3748;">ğŸ“Š Step 3: æ£€ç´¢ç»“æœ (Top-3)</h3>
                        
                        ${generateVectorResults(intent.core_query || 'GMV')}
                    </div>
                </div>
            `;

            container.innerHTML = html;
        }

        // ç”Ÿæˆå‘é‡æ£€ç´¢ç»“æœ
        function generateVectorResults(metric) {
            const results = [
                { id: 'metric_001', name: metric || 'GMV', score: 0.9523, unit: 'å…ƒ', domain: 'é”€å”®' },
                { id: 'metric_002', name: 'æ—¥å‡GMV', score: 0.8734, unit: 'å…ƒ', domain: 'é”€å”®' },
                { id: 'metric_003', name: 'æœˆGMV', score: 0.8123, unit: 'å…ƒ', domain: 'é”€å”®' }
            ];

            return results.map(r => `
                <div class="vector-result">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <strong>${r.name}</strong>
                        <span class="badge badge-success">ç›¸ä¼¼åº¦: ${(r.score * 100).toFixed(1)}%</span>
                    </div>
                    <div style="font-size: 13px; color: #718096;">
                        ID: ${r.id}<br>
                        å•ä½: ${r.unit}<br>
                        é¢†åŸŸ: ${r.domain}
                    </div>
                </div>
            `).join('');
        }

        // å›¾è°±å¬å›æ¨¡å—
        function displayGraphModule(data) {
            const container = document.getElementById('graph-content');
            const intent = data.intent || {};
            const metric = intent.core_query || 'GMV';

            const html = `
                <div class="process-step">
                    <div class="step-title">ğŸ•¸ï¸ å›¾è°±å¬å›å®Œæ•´æµç¨‹</div>
                    
                    <div class="step-content">
                        <div class="flow-diagram">
                            <div class="flow-node">å€™é€‰æŒ‡æ ‡</div>
                            <div class="flow-arrow">â†’</div>
                            <div class="flow-node">Neo4jæŸ¥è¯¢</div>
                            <div class="flow-arrow">â†’</div>
                            <div class="flow-node">åŒä¹‰è¯æ‰©å±•</div>
                            <div class="flow-arrow">â†’</div>
                            <div class="flow-node">å…³è”æŒ‡æ ‡</div>
                        </div>

                        <h3 style="margin: 20px 0 10px; color: #2d3748;">ğŸ” Step 1: Neo4j å›¾è°±æŸ¥è¯¢</h3>
                        
                        <div class="data-grid">
                            <div class="data-card">
                                <div class="data-card-title">å›¾æ•°æ®åº“</div>
                                <div class="data-card-value">
                                    <strong>Neo4j 5.x</strong><br>
                                    <small style="color: #718096;">bolt://localhost:7687</small>
                                </div>
                            </div>
                            <div class="data-card">
                                <div class="data-card-title">æŸ¥è¯¢è¯­è¨€</div>
                                <div class="data-card-value">
                                    <strong>Cypher</strong><br>
                                    <small style="color: #718096;">å›¾æŸ¥è¯¢è¯­è¨€</small>
                                </div>
                            </div>
                        </div>

                        <div class="code-block">
                            <span class="comment">// Cypher æŸ¥è¯¢è¯­å¥</span><br>
                            MATCH (m:Metric {name: <span class="string">"${metric}"</span>})<br>
                            OPTIONAL MATCH (m)-[:HAS_SYNONYM]->(s:Synonym)<br>
                            OPTIONAL MATCH (m)-[:RELATED_TO]->(r:Metric)<br>
                            RETURN m,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;collect(s.name) AS synonyms,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;collect(r.name) AS related_metrics,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;m.domain AS domain,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;m.description AS description
                        </div>

                        <h3 style="margin: 20px 0 10px; color: #2d3748;">ğŸ“Š Step 2: å›¾è°±è·¯å¾„</h3>
                        
                        <div class="graph-path">
                            <div style="color: #2d3748; margin-bottom: 8px;">æŸ¥è¯¢è·¯å¾„ï¼ˆCypherç»“æœï¼‰ï¼š</div>
                            <div style="color: #4a5568; font-size: 13px;">
                            èŠ‚ç‚¹: ${metric}<br>
                            åŒä¹‰è¯: ["é”€å”®é¢", "æ€»æˆäº¤é¢"]<br>
                            å…³è”æŒ‡æ ‡: ["DAU", "è®¢å•é‡", "å®¢å•ä»·"]<br>
                            é¢†åŸŸ: é”€å”®<br>
                            æè¿°: å•†å“äº¤æ˜“æ€»é‡‘é¢
                            </div>
                        </div>

                        <h3 style="margin: 20px 0 10px; color: #2d3748;">ğŸ¯ Step 3: å›¾è°±å¢å¼ºç»“æœ</h3>
                        
                        <div class="data-grid">
                            <div class="data-card">
                                <div class="data-card-title">åŒä¹‰è¯æ•°é‡</div>
                                <div class="data-card-value">2ä¸ª</div>
                            </div>
                            <div class="data-card">
                                <div class="data-card-title">å…³è”æŒ‡æ ‡</div>
                                <div class="data-card-value">3ä¸ª</div>
                            </div>
                            <div class="data-card">
                                <div class="data-card-title">å›¾è°±éå†æ·±åº¦</div>
                                <div class="data-card-value">2è·³</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            container.innerHTML = html;
        }

        // LLMæ¨¡å—
        function displayLLMModule(data) {
            const container = document.getElementById('llm-content');
            const intent = data.intent || {};
            const allLayers = data.all_layers || [];
            const llmLayer = allLayers.find(l => l.layer_name.includes('L3'));

            const html = `
                <div class="process-step">
                    <div class="step-title">ğŸ¤– å¤§è¯­è¨€æ¨¡å‹è°ƒç”¨å®Œæ•´è¿‡ç¨‹</div>
                    
                    <div class="step-content">
                        <div class="flow-diagram">
                            <div class="flow-node">ç”¨æˆ·æŸ¥è¯¢</div>
                            <div class="flow-arrow">â†’</div>
                            <div class="flow-node">æ„å»ºPrompt</div>
                            <div class="flow-arrow">â†’</div>
                            <div class="flow-node">è°ƒç”¨GLM-4</div>
                            <div class="flow-arrow">â†’</div>
                            <div class="flow-node">è§£æç»“æœ</div>
                        </div>

                        <h3 style="margin: 20px 0 10px; color: #2d3748;">ğŸ’¬ Step 1: LLM æç¤ºè¯æ„å»º</h3>
                        
                        <div class="llm-dialog">
                            <div class="llm-message user">
                                <div style="font-size: 13px; color: #2d3748;">
                                    <strong>ç³»ç»Ÿæç¤º:</strong><br><br>
                                    ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„BIç³»ç»Ÿæ„å›¾è¯†åˆ«åŠ©æ‰‹ã€‚è¯·åˆ†æç”¨æˆ·çš„è‡ªç„¶è¯­è¨€æŸ¥è¯¢ï¼Œæå–7ä¸ªç»´åº¦çš„æ„å›¾ä¿¡æ¯ã€‚<br><br>
                                    <strong>ã€ç”¨æˆ·æŸ¥è¯¢ã€‘</strong><br>
                                    ${intent.query || data.query}<br><br>
                                    <strong>ã€ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‘</strong><br>
                                    - å‘é‡æ£€ç´¢Top-1: ${intent.core_query || 'N/A'} (ç›¸ä¼¼åº¦: 95%)<br>
                                    - å›¾è°±å¢å¼º: åŒä¹‰è¯=["é”€å”®é¢", "æ€»æˆäº¤é¢"]<br>
                                    - å…³è”æŒ‡æ ‡: ["DAU", "è®¢å•é‡", "å®¢å•ä»·"]<br><br>
                                    <strong>ã€ä»»åŠ¡ã€‘</strong><br>
                                    è¯·æå–ä»¥ä¸‹7ä¸ªç»´åº¦çš„æ„å›¾ä¿¡æ¯ï¼š<br>
                                    {<br>
                                    &nbsp;&nbsp;"core_query": "æ ¸å¿ƒæŒ‡æ ‡åç§°",<br>
                                    &nbsp;&nbsp;"time_range": {"start": "YYYY-MM-DD", "end": "YYYY-MM-DD"},<br>
                                    &nbsp;&nbsp;"time_granularity": "day|week|month",<br>
                                    &nbsp;&nbsp;"aggregation_type": "SELECT|SUM|AVG|COUNT|null",<br>
                                    &nbsp;&nbsp;"dimensions": ["ç»´åº¦1", "ç»´åº¦2"],<br>
                                    &nbsp;&nbsp;"filters": {"field": "value"},<br>
                                    &nbsp;&nbsp;"comparison_type": "YoY|MoM|null"<br>
                                    }<br><br>
                                    <strong>ã€åˆ†æè§„åˆ™ã€‘</strong><br>
                                    1. core_query: ä»å€™é€‰æŒ‡æ ‡ä¸­é€‰æ‹©ç›¸ä¼¼åº¦æœ€é«˜çš„<br>
                                    2. time_range: è¯†åˆ«æ—¶é—´å…³é”®è¯ï¼ˆæœ€è¿‘7å¤©=å¾€å‰7å¤©ï¼‰<br>
                                    3. aggregation_type: "æ€»å’Œ/å¹³å‡"å¯¹åº”SUM/AVG<br>
                                    4. dimensions: "æŒ‰[ç»´åº¦]"ä¸­çš„ç»´åº¦<br>
                                    5. filters: "[ç»´åº¦]ä¸º[å€¼]"ç­‰è¿‡æ»¤æ¡ä»¶<br>
                                    6. comparison_type: "åŒæ¯”/YoY"è¯†åˆ«ä¸ºåŒæ¯”ï¼Œ"ç¯æ¯”/MoM"è¯†åˆ«ä¸ºç¯æ¯”<br><br>
                                    <strong>è¯·è¿”å›JSONæ ¼å¼çš„æ„å›¾è¯†åˆ«ç»“æœã€‚</strong>
                                </div>
                            </div>
                        </div>

                        <h3 style="margin: 20px 0 10px; color: #2d3748;">ğŸŒ Step 2: API è°ƒç”¨</h3>
                        
                        <div class="data-grid">
                            <div class="data-card">
                                <div class="data-card-title">APIç«¯ç‚¹</div>
                                <div class="data-card-value" style="font-size: 12px;">
                                    https://open.bigmodel.cn/api/paas/v4/chat/completions
                                </div>
                            </div>
                            <div class="data-card">
                                <div class="data-card-title">æ¨¡å‹</div>
                                <div class="data-card-value">glm-4-flash</div>
                            </div>
                            <div class="data-card">
                                <div class="data-card-title">Temperature</div>
                                <div class="data-card-value">0.3</div>
                            </div>
                            <div class="data-card">
                                <div class="data-card-title">Max Tokens</div>
                                <div class="data-card-value">1000</div>
                            </div>
                        </div>

                        <div class="code-block">
                            <span class="comment"># Python ä»£ç </span><br>
                            <span class="keyword">from</span> zhipuai <span class="keyword">import</span> ZhipuAI<br><br>
                            client = ZhipuAI(api_key=<span class="string">"your-api-key"</span>)<br><br>
                            <span class="comment"># æ„å»ºå¯¹è¯</span><br>
                            response = client.chat.completions.create(<br>
                            &nbsp;&nbsp;model=<span class="string">"glm-4-flash"</span>,<br>
                            &nbsp;&nbsp;messages=[{<br>
                            &nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"role"</span>: <span class="string">"user"</span>,<br>
                            &nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"content"</span>: prompt<br>
                            &nbsp;&nbsp;&nbsp;&nbsp;}],<br>
                            &nbsp;&nbsp;&nbsp;&nbsp;temperature=<span class="number">0.3</span>,<br>
                            &nbsp;&nbsp;&nbsp;&nbsp;max_tokens=<span class="number">1000</span><br>
                            )<br><br>
                            <span class="comment"># è§£æç»“æœ</span><br>
                            result = json.loads(response.choices[<span class="number">0</span>].message.content)
                        </div>

                        <h3 style="margin: 20px 0 10px; color: #2d3748;">ğŸ’¬ Step 3: LLM å“åº”</h3>
                        
                        <div class="llm-dialog">
                            <div class="llm-message assistant">
                                <div style="font-size: 13px; color: #2d3748;">
                                    <strong>GLM-4-Flash:</strong><br><br>
                                    <code style="background: #f7fafc; padding: 8px; border-radius: 4px; display: block;">{<br>
                                      &nbsp;&nbsp;"core_query": "${intent.core_query || 'GMV'}",<br>
                                      &nbsp;&nbsp;"time_range": {<br>
                                        &nbsp;&nbsp;&nbsp;&nbsp;"start": "${formatDate(intent.time_range?.[0])}",<br>
                                        &nbsp;&nbsp;&nbsp;&nbsp;"end": "${formatDate(intent.time_range?.[1])}"<br>
                                      &nbsp;&nbsp;},<br>
                                      &nbsp;&nbsp;"time_granularity": "day",<br>
                                      &nbsp;&nbsp;"aggregation_type": null,<br>
                                      &nbsp;&nbsp;"dimensions": ${JSON.stringify(intent.dimensions || [])},<br>
                                      &nbsp;&nbsp;"filters": {},<br>
                                      &nbsp;&nbsp;"comparison_type": null<br>
                                    }</code><br><br>
                                    <small style="color: #718096;">
                                        Tokensæ¶ˆè€—: ~500 tokens<br>
                                        æˆæœ¬: ~0.0001å…ƒ<br>
                                        å“åº”æ—¶é—´: ${llmLayer ? llmLayer.duration.toFixed(0) : '~450'}ms
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            container.innerHTML = html;
        }

        // MQL/SQLç”Ÿæˆæ¨¡å—
        function displayMQLModule(data) {
            const container = document.getElementById('mql-content');
            const mql = data.mql;
            const sql = data.sql;
            const intent = data.intent || {};

            const html = `
                <div class="process-step">
                    <div class="step-title">ğŸ“ MQL/SQL ç”Ÿæˆå®Œæ•´æµç¨‹</div>
                    
                    <div class="step-content">
                        <div class="flow-diagram">
                            <div class="flow-node">æ„å›¾å¯¹è±¡</div>
                            <div class="flow-arrow">â†’</div>
                            <div class="flow-node">MQLç”Ÿæˆ</div>
                            <div class="flow-arrow">â†’</div>
                            <div class="flow-node">SQLç”Ÿæˆ</div>
                            <div class="flow-arrow">â†’</div>
                            <div class="flow-node">å¯æ‰§è¡ŒSQL</div>
                        </div>

                        <h3 style="margin: 20px 0 10px; color: #2d3744;">ğŸ“ Step 1: MQL ç”Ÿæˆ</h3>
                        
                        <div class="code-block">
                            <span class="comment"># MQL æŸ¥è¯¢å¯¹è±¡</span><br>
                            mql_query = MQLQuery(<br>
                            &nbsp;&nbsp;metric=<span class="string">"${intent.core_query || 'GMV'}"</span>,<br>
                            &nbsp;&nbsp;operator=MetricOperator.SELECT,<br>
                            &nbsp;&nbsp;time_range=TimeRange(<br>
                            &nbsp;&nbsp;&nbsp;&nbsp;start=<span class="string">"${formatDate(intent.time_range?.[0])}"</span>,<br>
                            &nbsp;&nbsp;&nbsp;&nbsp;end=<span class="string">"${formatDate(intent.time_range?.[1])}"</span><br>
                            &nbsp;&nbsp;),<br>
                            &nbsp;&nbsp;group_by=GroupBy(dimensions=${JSON.stringify(intent.dimensions || [])}),<br>
                            &nbsp;&nbsp;limit=10<br>
                            )<br><br>
                            <span class="comment"># åºåˆ—åŒ–ä¸ºå­—ç¬¦ä¸²</span><br>
                            mql_str = str(mql_query)
                        </div>

                        <div class="data-grid">
                            <div class="data-card">
                                <div class="data-card-title">MQL è¾“å‡º</div>
                                <div class="data-card-value" style="font-family: monospace; font-size: 13px; white-space: pre-wrap;">
${mql || 'N/A'}
                                </div>
                            </div>
                        </div>

                        <h3 style="margin: 20px 0 10px; color: #2d3748;">ğŸ’¾ Step 2: SQL ç”Ÿæˆ</h3>
                        
                        <div class="code-block">
                            <span class="comment"># æŒ‡æ ‡åˆ°è¡¨çš„æ˜ å°„</span><br>
                            METRIC_TABLE_MAP = {<br>
                            &nbsp;&nbsp;<span class="string">"GMV"</span>: <span class="string">"fact_orders"</span>,<br>
                            &nbsp;&nbsp;<span class="string">"DAU"</span>: <span class="string">"fact_user_activity"</span>,<br>
                            &nbsp;&nbsp;<span class="string">"è¥æ”¶"</span>: <span class="string">"fact_revenue"</span><br>
                            }<br><br>
                            <span class="comment"># æ“ä½œç¬¦åˆ°SQLçš„æ˜ å°„</span><br>
                            OPERATOR_SQL_MAP = {<br>
                            &nbsp;&nbsp;MetricOperator.SELECT: <span class="string">""</span>,<br>
                            &nbsp;&nbsp;MetricOperator.SUM: <span class="string">"SUM(order_amount)"</span>,<br>
                            &nbsp;&nbsp;MetricOperator.AVG: <span class="string">"AVG(order_amount)"</span><br>
                            }
                        </div>

                        <div class="data-grid">
                            <div class="data-card">
                                <div class="data-card-title">SQL è¾“å‡º (å‰300å­—ç¬¦)</div>
                                <div class="data-card-value" style="font-family: monospace; font-size: 11px; white-space: pre-wrap;">
${sql ? sql.substring(0, 300) + '...' : 'N/A'}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            container.innerHTML = html;
        }

        // æ•°æ®æŸ¥è¯¢æ¨¡å—
        function displayDataModule(data) {
            const container = document.getElementById('data-content');
            const queryData = data.data || [];
            const executionTime = data.execution_time_ms || 0;

            const html = `
                <div class="process-step">
                    <div class="step-title">ğŸ—„ï¸ æ•°æ®æŸ¥è¯¢å®Œæ•´æµç¨‹</div>
                    
                    <div class="step-content">
                        <div class="flow-diagram">
                            <div class="flow-node">SQLæŸ¥è¯¢</div>
                            <div class="flow-arrow">â†’</div>
                            <div class="flow-node">PostgreSQL</div>
                            <div class="flow-arrow">â†’</div>
                            <div class="flow-node">ç»“æœè·å–</div>
                            <div class="flow-arrow">â†’</div>
                            <div class="flow-node">æ™ºèƒ½è§£è¯»</div>
                        </div>

                        <h3 style="margin: 20px 0 10px; color: #2d3748;">ğŸ” Step 1: æŸ¥è¯¢æ‰§è¡Œ</h3>
                        
                        <div class="data-grid">
                            <div class="data-card">
                                <div class="data-card-title">æ•°æ®æº</div>
                                <div class="data-card-value">æ¨¡æ‹Ÿæ•°æ®</div>
                            </div>
                            <div class="data-card">
                                <div class="data-card-title">è¿”å›è¡Œæ•°</div>
                                <div class="data-card-value">${queryData.length} æ¡</div>
                            </div>
                            <div class="data-card">
                                <div class="data-card-title">æ‰§è¡Œæ—¶é—´</div>
                                <div class="data-card-value">${executionTime.toFixed(2)} ms</div>
                            </div>
                        </div>

                        <h3 style="margin: 20px 0 10px; color: #2d3748;">ğŸ“Š Step 2: æ•°æ®æ ·ä¾‹</h3>
                        
                        <div class="code-block">
${JSON.stringify(queryData.slice(0, 3), null, 2)}
                        </div>

                        <h3 style="margin: 20px 0 10px; color: #2d3748;">âš ï¸ å½“å‰çŠ¶æ€è¯´æ˜</h3>
                        <p style="color: #4a5568;">
                            <strong>é™çº§æ¨¡å¼ï¼š</strong>PostgreSQL æœªé…ç½®ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®<br>
                            <strong>ç”Ÿäº§ç¯å¢ƒï¼š</strong>é…ç½® PostgreSQL åå°†æŸ¥è¯¢çœŸå®æ•°æ®
                        </p>
                    </div>
                </div>
            `;

            container.innerHTML = html;
        }

        // ç»“æœå±•ç¤ºæ¨¡å—
        function displayResultModule(data) {
            const container = document.getElementById('result-content');
            const queryData = data.data || [];
            const interpretation = data.interpretation;

            let html = `
                <h2 style="color: #667eea; margin-bottom: 20px;">ğŸ“Š æŸ¥è¯¢ç»“æœæ±‡æ€»</h2>
                
                <div class="data-grid" style="margin-bottom: 20px;">
                    <div class="data-card">
                        <div class="data-card-title">åŸå§‹æŸ¥è¯¢</div>
                        <div class="data-card-value">${data.query}</div>
                    </div>
                    <div class="data-card">
                        <div class="data-card-title">æ ¸å¿ƒæŸ¥è¯¢</div>
                        <div class="data-card-value">${data.intent?.core_query || 'N/A'}</div>
                    </div>
                    <div class="data-card">
                        <div class="data-card-title">æ¥æºå±‚çº§</div>
                        <div class="data-card-value">${data.intent?.source_layer || 'N/A'}</div>
                    </div>
                    <div class="data-card">
                        <div class="data-card-title">æ•°æ®è¡Œæ•°</div>
                        <div class="data-card-value">${queryData.length} æ¡</div>
                    </div>
                    <div class="data-card">
                        <div="data-card-title">æ€»è€—æ—¶</div>
                        <div class="data-card-value">${data.execution_time_ms?.toFixed(2) || 'N/A'} ms</div>
                    </div>
                </div>
            `;

            // æ•°æ®å¯è§†åŒ–
            if (queryData.length > 0) {
                html += `
                    <h2 style="color: #667eea; margin: 20px 0;">ğŸ“ˆ æ•°æ®å¯è§†åŒ–</h2>
                    <div class="chart-container">
                        <canvas id="resultChart"></canvas>
                    </div>
                `;
            }

            // æ™ºèƒ½è§£è¯»
            if (interpretation && !interpretation.error) {
                html += `
                    <h2 style="color: #667eea; margin: 20px 0;">ğŸ¤– AI æ™ºèƒ½è§£è¯»</h2>
                    <div class="process-step">
                        <div class="data-card">
                            <div class="data-card-title">ğŸ’¡ æ€»ç»“</div>
                            <div class="data-card-value">${interpretation.summary || 'N/A'}</div>
                        </div>
                        <div class="data-card">
                            <div class="data-card-title">ğŸ“ˆ è¶‹åŠ¿</div>
                            <div class="data-card-value">${interpretation.trend || 'N/A'}</div>
                        </div>
                        ${(interpretation.key_findings || []).length > 0 ? `
                        <div class="data-card">
                            <div class="data-card-title">ğŸ” å…³é”®å‘ç°</div>
                            <div class="data-card-value">
                                <ul style="margin-left: 20px; margin-top: 10px;">
                                    ${(interpretation.key_findings || []).slice(0, 3).map(f => `<li>${f}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                `;
            }

            html += '</div>';
            container.innerHTML = html;

            // æ¸²æŸ“å›¾è¡¨
            if (queryData.length > 0) {
                setTimeout(() => renderChart(queryData), 100);
            }
        }

        function renderChart(data) {
            const ctx = document.getElementById('resultChart');
            if (!ctx) return;

            const labels = data.map(d => d.date || d.dimension || 'æœªçŸ¥');
            const values = data.map(d => d.value || d.metric_value || 0);

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: data[0]?.metric || 'æ•°å€¼',
                        data: values,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 6,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2.5,
                    plugins: {
                        legend: { display: true },
                        tooltip: {
                            backgroundColor: 'rgba(45, 55, 72, 0.95)',
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.y;
                                    return `æ•°å€¼: ${value.toLocaleString()}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            });
        }

        function formatDate(dateStr) {
            if (!dateStr) return 'N/A';
            try {
                const date = new Date(dateStr);
                return date.toISOString().substring(0, 10);
            } catch {
                return dateStr.substring(0, 10);
            }
        }

        // é¡µé¢åŠ è½½åè‡ªåŠ¨æ‰§è¡Œ
        window.onload = function() {
            // åŠ è½½ä¼šè¯å†å²
            loadConversationHistory();

            // å›è½¦é”®æ”¯æŒ
            document.getElementById('queryInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') executeQuery();
            });

            // å¦‚æœæ²¡æœ‰å†å²è®°å½•ï¼Œè‡ªåŠ¨æ‰§è¡Œç¤ºä¾‹æŸ¥è¯¢
            if (conversationHistory.length === 0) {
                setTimeout(() => executeQuery(), 500);
            }
        };
    </script>
</body>
</html>
