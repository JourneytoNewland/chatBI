<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½é—®æ•° - æµç¨‹å¼•æ“å¯è§†åŒ–</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js?v=2.0"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB',
                'Microsoft YaHei', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .header h1 {
            color: #667eea;
            font-size: 28px;
            margin-bottom: 15px;
        }

        .header p {
            color: #666;
            font-size: 14px;
            line-height: 1.6;
        }

        .search-box {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .search-input {
            width: 100%;
            padding: 15px 20px;
            font-size: 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            outline: none;
            transition: all 0.3s;
        }

        .search-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .examples {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .example-chip {
            padding: 8px 15px;
            background: #f0f0f0;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .example-chip:hover {
            background: #667eea;
            color: white;
        }

        .search-button {
            margin-top: 15px;
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .search-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        /* æµç¨‹èŠ‚ç‚¹æ ·å¼ */
        .pipeline {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .node {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            position: relative;
            transition: all 0.3s;
        }

        .node:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }

        .node-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }

        .node-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .node-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-l1 { background: #e3f2fd; color: #1976d2; }
        .badge-l2 { background: #f3e5f5; color: #7b1fa2; }
        .badge-l3 { background: #fff3e0; color: #f57c00; }
        .badge-mql { background: #e8f5e9; color: #388e3c; }
        .badge-sql { background: #fce4ec; color: #c2185b; }
        .badge-data { background: #fff9c4; color: #f9a825; }

        .node-content {
            font-size: 14px;
            color: #666;
            line-height: 1.8;
        }

        .node-content strong {
            color: #333;
        }

        .confidence-bar {
            margin-top: 10px;
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            overflow: hidden;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.5s;
        }

        .node-time {
            margin-top: 10px;
            font-size: 12px;
            color: #999;
        }

        /* æµç¨‹ç®­å¤´ */
        .flow-arrow {
            text-align: center;
            font-size: 24px;
            color: #667eea;
            margin: 10px 0;
        }

        /* ç»“æœå±•ç¤ºåŒº */
        .result-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .result-section h3 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 20px;
        }

        .code-block {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            overflow-x: auto;
            margin-bottom: 15px;
        }

        .keyword {
            color: #d32f2f;
        }

        .string {
            color: #388e3c;
        }

        .function {
            color: #7b1fa2;
        }

        .comment {
            color: #757575;
            font-style: italic;
        }

        .chart-container {
            margin-top: 20px;
            padding: 20px;
            background: #fafafa;
            border-radius: 10px;
        }

        .interpretation-card {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            padding: 20px;
            border-radius: 10px;
            margin-top: 15px;
        }

        .interpretation-card h4 {
            color: #2e7d32;
            margin-bottom: 10px;
        }

        .interpretation-card p {
            color: #1b5e20;
            line-height: 1.8;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #c62828;
        }

        .success {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #2e7d32;
        }

        /* å“åº”å¼ */
        @media (max-width: 768px) {
            .pipeline {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <h1>ğŸš€ æ™ºèƒ½é—®æ•°ç³»ç»Ÿ - æµç¨‹å¼•æ“å¯è§†åŒ–</h1>
            <p>
                åŸºäºä¸‰å±‚æ··åˆæ¶æ„çš„æ„å›¾è¯†åˆ« + MQL/SQLè‡ªåŠ¨ç”Ÿæˆ + æ™ºèƒ½è§£è¯»<br>
                æ¯ä¸€æ­¥éƒ½é‡‡ç”¨æœ€ä¼˜ç®—æ³•ï¼ŒçœŸå®å¯éªŒè¯çš„AIç³»ç»Ÿ
            </p>
        </div>

        <!-- æœç´¢æ¡† -->
        <div class="search-box">
            <div id="apiStatus" class="error" style="display: none; margin-bottom: 15px;">
                âš ï¸ APIæœåŠ¡æœªè¿æ¥ï¼Œè¯·å…ˆå¯åŠ¨åç«¯æœåŠ¡ï¼š<br>
                <code>python3 -m uvicorn src.api.main:app --host 0.0.0.0 --port 8000</code>
            </div>
            <input
                type="text"
                class="search-input"
                id="queryInput"
                placeholder="è¯·è¾“å…¥è‡ªç„¶è¯­è¨€æŸ¥è¯¢ï¼Œä¾‹å¦‚ï¼šæœ€è¿‘7å¤©çš„GMV"
                value="æœ€è¿‘7å¤©çš„GMV"
            >
            <div class="examples">
                <div class="example-chip" onclick="setQuery('æœ€è¿‘7å¤©çš„GMV')">æœ€è¿‘7å¤©çš„GMV</div>
                <div class="example-chip" onclick="setQuery('æœ¬æœˆæŒ‰æ¸ é“ç»Ÿè®¡DAU')">æœ¬æœˆæŒ‰æ¸ é“ç»Ÿè®¡DAU</div>
                <div class="example-chip" onclick="setQuery('2024å¹´1æœˆçš„è®¢å•è½¬åŒ–ç‡')">2024å¹´1æœˆçš„è®¢å•è½¬åŒ–ç‡</div>
                <div class="example-chip" onclick="setQuery('æŒ‰åœ°åŒºç»Ÿè®¡GMVå¹¶æŒ‰é™åºæ’åˆ—')">æŒ‰åœ°åŒºç»Ÿè®¡GMVå¹¶æŒ‰é™åºæ’åˆ—</div>
            </div>
            <button class="search-button" type="button" onclick="executeQuery()">
                ğŸ” å¼€å§‹æ™ºèƒ½åˆ†æ
            </button>
        </div>

        <!-- æµç¨‹å±•ç¤ºåŒº -->
        <div id="pipelineContainer"></div>

        <!-- ç»“æœå±•ç¤ºåŒº -->
        <div id="resultContainer"></div>
    </div>

    <script>
        console.log('âœ… Script loaded successfully');

        // æ£€æŸ¥APIæœåŠ¡çŠ¶æ€
        async function checkAPIStatus() {
            try {
                const response = await fetch('http://localhost:8000/health', {
                    method: 'GET',
                    signal: AbortSignal.timeout(3000)
                });
                if (response.ok) {
                    document.getElementById('apiStatus').style.display = 'none';
                    return true;
                }
            } catch (error) {
                document.getElementById('apiStatus').style.display = 'block';
                return false;
            }
            return false;
        }

        function setQuery(query) {
            console.log('setQuery called with:', query);
            document.getElementById('queryInput').value = query;
        }

        async function executeQuery() {
            console.log('executeQuery called');
            // æ£€æŸ¥APIçŠ¶æ€
            const isAPIReady = await checkAPIStatus();
            if (!isAPIReady) {
                return;
            }

            const query = document.getElementById('queryInput').value.trim();
            if (!query) {
                alert('è¯·è¾“å…¥æŸ¥è¯¢å†…å®¹');
                return;
            }

            const pipelineContainer = document.getElementById('pipelineContainer');
            const resultContainer = document.getElementById('resultContainer');

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            pipelineContainer.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>æ­£åœ¨æ‰§è¡Œä¸‰å±‚æ„å›¾è¯†åˆ«...</p>
                </div>
            `;
            resultContainer.innerHTML = '';

            try {
                const response = await fetch('http://localhost:8000/api/v3/query', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ query })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();

                // æ˜¾ç¤ºæµç¨‹å¼•æ“
                displayPipeline(data);

                // æ˜¾ç¤ºè¯¦ç»†ç»“æœ
                displayResults(data);

            } catch (error) {
                console.error('Query error:', error);
                pipelineContainer.innerHTML = `
                    <div class="error">
                        <strong>æŸ¥è¯¢å¤±è´¥</strong><br>
                        ${error.message}<br>
                        <small>è¯·ç¡®ä¿APIæœåŠ¡å·²å¯åŠ¨ (ç«¯å£8000)</small>
                    </div>
                `;
            }
        }

        function displayPipeline(data) {
            const container = document.getElementById('pipelineContainer');
            const all_layers = data.all_layers || [];
            const intent = data.intent || {};
            const mql = data.mql;
            const sql = data.sql;

            let html = '<div class="pipeline">';

            // æ˜¾ç¤ºä¸‰å±‚æ¶æ„è¯¦æƒ…
            if (all_layers.length > 0) {
                all_layers.forEach(layer => {
                    const isSuccess = layer.success;
                    const badgeClass = layer.layer_name.includes('L1') ? 'badge-l1' :
                                      layer.layer_name.includes('L2') ? 'badge-l2' : 'badge-l3';
                    const badgeText = isSuccess ? 'âœ“ æˆåŠŸ' : 'âœ— å¤±è´¥';

                    let content = `<p><strong>å±‚çº§ï¼š</strong>${layer.layer_name}</p>`;
                    content += `<p><strong>çŠ¶æ€ï¼š</strong>${badgeText}</p>`;
                    content += `<p><strong>è€—æ—¶ï¼š</strong>${layer.duration.toFixed(2)}ms</p>`;
                    content += `<p><strong>ç½®ä¿¡åº¦ï¼š</strong>${(layer.confidence * 100).toFixed(1)}%</p>`;

                    if (layer.metadata && layer.metadata.method) {
                        content += `<p><strong>æ–¹æ³•ï¼š</strong>${layer.metadata.method}</p>`;
                    }

                    html += `
                        <div class="node">
                            <div class="node-header">
                                <span class="node-title">ğŸ” ${layer.layer_name}</span>
                                <span class="node-badge ${badgeClass}">${badgeText}</span>
                            </div>
                            <div class="node-content">
                                ${content}
                            </div>
                            <div class="confidence-bar">
                                <div class="confidence-fill" style="width: ${layer.confidence * 100}%"></div>
                            </div>
                        </div>
                    `;
                });
            }

            // MQLç”ŸæˆèŠ‚ç‚¹
            if (mql) {
                html += `
                    <div class="node">
                        <div class="node-header">
                            <span class="node-title">ğŸ“ MQLç”Ÿæˆ</span>
                            <span class="node-badge badge-mql">âœ“ æˆåŠŸ</span>
                        </div>
                        <div class="node-content">
                            <div class="code-block">${highlightMQL(mql)}</div>
                            <p><strong>è¯´æ˜ï¼š</strong>æŒ‡æ ‡æŸ¥è¯¢è¯­è¨€è‡ªåŠ¨ç”Ÿæˆ</p>
                        </div>
                    </div>
                `;
            }

            // SQLç”ŸæˆèŠ‚ç‚¹
            if (sql) {
                html += `
                    <div class="node">
                        <div class="node-header">
                            <span class="node-title">ğŸ’¾ SQLç”Ÿæˆ</span>
                            <span class="node-badge badge-sql">âœ“ æˆåŠŸ</span>
                        </div>
                        <div class="node-content">
                            <div class="code-block">${highlightSQL(sql)}</div>
                            <p><strong>è¯´æ˜ï¼š</strong>åŠ¨æ€SQLç”Ÿæˆï¼ˆéæ¨¡æ¿ï¼‰</p>
                        </div>
                    </div>
                `;
            }

            html += '</div>';
            container.innerHTML = html;
        }

        function createNodeHTML(id, title, badgeClass, layer, description, confidence) {
            let content = `<p><strong>ç®—æ³•è¯´æ˜ï¼š</strong>${description}</p>`;

            if (id === 'L1' && layer.metadata) {
                content += `<p><strong>æ–¹æ³•ï¼š</strong>${layer.metadata.method || 'regex_patterns'}</p>`;
                if (layer.metadata.time_detected) content += `<p>âœ… è¯†åˆ«åˆ°æ—¶é—´èŒƒå›´</p>`;
                if (layer.metadata.aggregation_detected) content += `<p>âœ… è¯†åˆ«åˆ°èšåˆç±»å‹</p>`;
                if (layer.metadata.dimensions_detected) content += `<p>âœ… è¯†åˆ«åˆ°ç»´åº¦</p>`;
            }

            if (id === 'L2' && layer.metadata) {
                const candidates = layer.metadata.candidates_found || 0;
                const topScore = layer.metadata.top_score || 0;
                content += `<p><strong>å¬å›å€™é€‰ï¼š</strong>${candidates}ä¸ª</p>`;
                content += `<p><strong>æœ€é«˜å¾—åˆ†ï¼š</strong>${(topScore * 100).toFixed(1)}%</p>`;
                if (layer.metadata.candidates && layer.metadata.candidates.length > 0) {
                    content += `<p><strong>Top 3 å€™é€‰ï¼š</strong></p><ul>`;
                    layer.metadata.candidates.slice(0, 3).forEach(c => {
                        content += `<li>${c.name} (${(c.score * 100).toFixed(1)}%)</li>`;
                    });
                    content += `</ul>`;
                }
            }

            if (id === 'L3' && layer.metadata) {
                if (layer.metadata.model) content += `<p><strong>æ¨¡å‹ï¼š</strong>${layer.metadata.model}</p>`;
                if (layer.metadata.reasoning) content += `<p><strong>æ¨ç†ï¼š</strong>${layer.metadata.reasoning}</p>`;
                if (layer.metadata.tokens_used) content += `<p><strong>Tokenæ¶ˆè€—ï¼š</strong>${layer.metadata.tokens_used}</p>`;
            }

            if (id === 'MQL' && layer.metadata?.mql) {
                content += `<div class="code-block">${highlightMQL(layer.metadata.mql)}</div>`;
            }

            if (id === 'SQL' && layer.metadata?.sql) {
                content += `<div class="code-block">${highlightSQL(layer.metadata.sql)}</div>`;
            }

            if (id === 'Data' && layer.metadata?.rows !== undefined) {
                content += `<p><strong>è¿”å›è¡Œæ•°ï¼š</strong>${layer.metadata.rows}</p>`;
            }

            const duration = layer.duration || 0;

            return `
                <div class="node">
                    <div class="node-header">
                        <span class="node-title">${id}: ${title}</span>
                        <span class="node-badge ${badgeClass}">${layer.success ? 'âœ“ æˆåŠŸ' : 'âœ— å¤±è´¥'}</span>
                    </div>
                    <div class="node-content">
                        ${content}
                    </div>
                    ${confidence > 0 ? `
                        <div class="confidence-bar">
                            <div class="confidence-fill" style="width: ${confidence * 100}%"></div>
                        </div>
                        <p style="margin-top: 5px; font-size: 12px; color: #667eea;">
                            ç½®ä¿¡åº¦: ${(confidence * 100).toFixed(1)}%
                        </p>
                    ` : ''}
                    <div class="node-time">
                        è€—æ—¶: ${duration.toFixed(2)}ms
                    </div>
                </div>
            `;
        }

        function highlightMQL(mql) {
            return mql
                .replace(/(SELECT|FROM|WHERE|GROUP BY|ORDER BY|LIMIT)/g, '<span class="keyword">$1</span>')
                .replace(/([A-Z_]+)/g, '<span class="function">$1</span>');
        }

        function highlightSQL(sql) {
            return sql
                .replace(/(SELECT|FROM|WHERE|GROUP BY|ORDER BY|LIMIT|AND|OR|AS)/g, '<span class="keyword">$1</span>')
                .replace(/('[^']*')/g, '<span class="string">$1</span>')
                .replace(/(\d+)/g, '<span class="string">$1</span>');
        }

        function displayResults(data) {
            const container = document.getElementById('resultContainer');
            const intent = data.intent || {};
            const queryData = data.data || [];
            const interpretation = data.interpretation;

            let html = `
                <div class="result-section">
                    <h3>ğŸ“Š æŸ¥è¯¢ç»“æœæ±‡æ€»</h3>
                    <div class="code-block">
                        <strong>æŸ¥è¯¢ï¼š</strong>${data.query}<br>
                        <strong>æ ¸å¿ƒæŸ¥è¯¢ï¼š</strong>${intent.core_query || 'N/A'}<br>
                        <strong>æ—¶é—´ç²’åº¦ï¼š</strong>${intent.time_granularity || 'N/A'}<br>
                        <strong>ç»´åº¦ï¼š</strong>${JSON.stringify(intent.dimensions || [])}<br>
                        <strong>æ•°æ®è¡Œæ•°ï¼š</strong>${queryData.length} æ¡<br>
                        <strong>æ€»è€—æ—¶ï¼š</strong>${data.execution_time_ms?.toFixed(2) || 'N/A'}ms
                    </div>
                </div>
            `;

            // æ•°æ®å¯è§†åŒ–
            if (queryData && queryData.length > 0) {
                html += `
                    <div class="result-section">
                        <h3>ğŸ“ˆ æ•°æ®å¯è§†åŒ–</h3>
                        <div class="chart-container">
                            <canvas id="resultChart"></canvas>
                        </div>
                    </div>
                `;
            }

            // æ™ºèƒ½è§£è¯»
            if (interpretation) {
                html += `
                    <div class="result-section">
                        <h3>ğŸ¤– AIæ™ºèƒ½è§£è¯»</h3>
                        <div class="interpretation-card">
                            <h4>ğŸ’¡ æ ¸å¿ƒæ´å¯Ÿ</h4>
                            <p>${interpretation.summary || 'æš‚æ— æ´å¯Ÿ'}</p>
                            ${interpretation.trends ? `<h4>ğŸ“ˆ è¶‹åŠ¿åˆ†æ</h4><p>${interpretation.trends}</p>` : ''}
                            ${interpretation.suggestions ? `<h4>ğŸ’­ å»ºè®®</h4><p>${interpretation.suggestions}</p>` : ''}
                        </div>
                    </div>
                `;
            }

            // MQLå’ŒSQLå±•ç¤º
            if (data.mql) {
                html += `
                    <div class="result-section">
                        <h3>ğŸ“ MQLæŸ¥è¯¢</h3>
                        <div class="code-block">${highlightMQL(data.mql)}</div>
                    </div>
                `;
            }

            if (data.sql) {
                html += `
                    <div class="result-section">
                        <h3>ğŸ’¾ SQLæŸ¥è¯¢</h3>
                        <div class="code-block">${highlightSQL(data.sql)}</div>
                    </div>
                `;
            }

            container.innerHTML = html;

            // æ¸²æŸ“å›¾è¡¨
            if (queryData && queryData.length > 0) {
                renderChart(queryData);
            }
        }

        function highlightMQL(mql) {
            return mql
                .replace(/(SELECT|FROM|WHERE|GROUP BY|ORDER BY|LIMIT)/g, '<span class="keyword">$1</span>')
                .replace(/([A-Z_]+)/g, '<span class="function">$1</span>');
        }

        function highlightSQL(sql) {
            return sql
                .replace(/(SELECT|FROM|WHERE|GROUP BY|ORDER BY|LIMIT|AND|OR|AS)/g, '<span class="keyword">$1</span>')
                .replace(/('[^']*')/g, '<span class="string">$1</span>')
                .replace(/(\d+)/g, '<span class="string">$1</span>');
        }

        function renderChart(data) {
            const ctx = document.getElementById('resultChart').getContext('2d');

            const labels = data.map(d => d.date || d.dimension || 'æœªçŸ¥');
            const values = data.map(d => d.value || d.metric_value || 0);

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'æŒ‡æ ‡å€¼',
                        data: values,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨æ‰§è¡Œä¸€æ¬¡æŸ¥è¯¢
        window.onload = function() {
            console.log('Window loaded');
            console.log('Functions available:', {
                checkAPIStatus: typeof checkAPIStatus,
                setQuery: typeof setQuery,
                executeQuery: typeof executeQuery,
                displayPipeline: typeof displayPipeline,
                displayResults: typeof displayResults
            });

            setTimeout(() => {
                console.log('Auto-executing query...');
                executeQuery();
            }, 500);
        };
    </script>
</body>
</html>
