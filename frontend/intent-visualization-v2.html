<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ„å›¾è¯†åˆ«æµç¨‹å¯è§†åŒ– - æ™ºèƒ½é—®æ•°ç³»ç»Ÿ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 32px;
            color: #2d3748;
            margin-bottom: 10px;
        }

        .header p {
            color: #718096;
            font-size: 16px;
        }

        .search-box {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }

        .search-box input {
            width: 100%;
            padding: 16px 20px;
            font-size: 18px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            outline: none;
            transition: all 0.3s;
        }

        .search-box input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .examples {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .example-btn {
            padding: 8px 16px;
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .example-btn:hover {
            background: #edf2f7;
            border-color: #cbd5e0;
        }

        /* ========== æµç¨‹å›¾å®¹å™¨ ========== */
        .flowchart-container {
            display: grid;
            grid-template-columns: 1fr 500px;
            gap: 20px;
            margin-bottom: 20px;
        }

        .flowchart-canvas {
            background: white;
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .flow-node {
            background: white;
            border: 3px solid #e2e8f0;
            border-radius: 12px;
            padding: 16px 20px;
            margin: 0 auto 30px;
            max-width: 400px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .flow-node:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .flow-node.active {
            border-color: #667eea;
            background: linear-gradient(135deg, #f0f4ff 0%, #e6f3ff 100%);
        }

        .flow-node.completed {
            border-color: #48bb78;
        }

        .flow-node.processing {
            border-color: #ecc94b;
            animation: pulse 1.5s infinite;
            position: relative;
        }

        .flow-node.processing::after {
            content: '';
            position: absolute;
            inset: -2px;
            border-radius: 12px;
            border: 2px solid #ecc94b;
            animation: ripple 1.5s infinite;
        }

        @keyframes ripple {
            0% {
                transform: scale(1);
                opacity: 0.8;
            }
            100% {
                transform: scale(1.3);
                opacity: 0;
            }
        }

        .node-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .node-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .node-title {
            font-size: 18px;
            font-weight: 700;
            color: #2d3748;
        }

        .node-meta {
            display: flex;
            gap: 12px;
            font-size: 13px;
            color: #718096;
            margin-bottom: 8px;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .node-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            background: #e2e8f0;
            color: #4a5568;
        }

        .node-status.completed {
            background: #c6f6d5;
            color: #22543d;
        }

        .node-status.processing {
            background: #fefcbf;
            color: #744210;
        }

        /* è¿æ¥çº¿ */
        .flow-connector {
            width: 4px;
            height: 30px;
            background: linear-gradient(to bottom, #a0aec0, #a0aec0);
            margin: 0 auto;
            position: relative;
        }

        .flow-connector::after {
            content: 'â–¼';
            position: absolute;
            bottom: -12px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 16px;
            color: #a0aec0;
        }

        .flow-connector.active {
            background: linear-gradient(to bottom, #667eea, #764ba2);
        }

        .flow-connector.active::after {
            color: #667eea;
        }

        /* ========== è¯¦æƒ…é¢æ¿ ========== */
        .detail-panel {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        .detail-title {
            font-size: 22px;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .detail-section {
            margin-bottom: 24px;
        }

        .detail-section-title {
            font-size: 16px;
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .detail-content {
            background: #f7fafc;
            border-radius: 8px;
            padding: 16px;
            font-size: 14px;
            line-height: 1.6;
            color: #2d3748;
        }

        .detail-content code {
            background: #e2e8f0;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 13px;
        }

        .detail-list {
            list-style: none;
        }

        .detail-list li {
            padding: 8px 0;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
        }

        .detail-list li:last-child {
            border-bottom: none;
        }

        .detail-list-label {
            font-weight: 600;
            color: #4a5568;
        }

        .detail-list-value {
            color: #718096;
            text-align: right;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #a0aec0;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        /* æ€§èƒ½æŒ‡æ ‡ */
        .performance-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        .perf-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            padding: 16px;
            color: white;
        }

        .perf-label {
            font-size: 13px;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .perf-value {
            font-size: 28px;
            font-weight: 700;
        }

        /* è¾“å…¥è¾“å‡ºå¡ç‰‡ */
        .io-card {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
        }

        .io-card-title {
            font-size: 14px;
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .io-card-content {
            font-size: 13px;
            color: #718096;
            line-height: 1.5;
        }

        /* æ ‡ç­¾ */
        .tag {
            display: inline-block;
            padding: 4px 10px;
            background: #edf2f7;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            color: #4a5568;
            margin: 2px;
        }

        .tag-primary {
            background: #bee3f8;
            color: #2c5282;
        }

        .tag-success {
            background: #c6f6d5;
            color: #22543d;
        }

        /* éšè—è¯¦æƒ…é¢æ¿ */
        .detail-panel.hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <h1>ğŸ¯ æ„å›¾è¯†åˆ«æµç¨‹å¯è§†åŒ–</h1>
            <p>åŠ¨æ€å±•ç¤ºæŸ¥è¯¢æ„å›¾è¯†åˆ«çš„å®Œæ•´æµç¨‹ï¼Œç‚¹å‡»æ¯ä¸ªèŠ‚ç‚¹æŸ¥çœ‹è¾“å…¥ã€ç®—æ³•å’Œè¾“å‡ºè¯¦æƒ…</p>
        </div>

        <!-- æœç´¢æ¡† -->
        <div class="search-box">
            <input
                type="text"
                id="queryInput"
                placeholder="è¾“å…¥æŸ¥è¯¢ï¼Œä¾‹å¦‚ï¼šGMVä¸Šå‡è¶‹åŠ¿å‰10å"
                onkeypress="if(event.key === 'Enter') analyzeQuery()"
            >
            <div class="examples">
                <button class="example-btn" onclick="setQuery('GMV')">GMV</button>
                <button class="example-btn" onclick="setQuery('GMVä¸Šå‡è¶‹åŠ¿å‰10å')">è¶‹åŠ¿+æ’åº</button>
                <button class="example-btn" onclick="setQuery('DAUå¤§äº10000')">é˜ˆå€¼è¿‡æ»¤</button>
                <button class="example-btn" onclick="setQuery('æœ€è¿‘30å¤©GMVæ³¢åŠ¨')">æ³¢åŠ¨åˆ†æ</button>
                <button class="example-btn" onclick="setQuery('å®ƒçš„å¢é•¿ç‡')">æŒ‡ä»£æŸ¥è¯¢</button>
            </div>
        </div>

        <!-- ä¸»å†…å®¹ -->
        <div class="flowchart-container" id="mainContent">
            <!-- æµç¨‹å›¾ -->
            <div class="flowchart-canvas" id="flowchart">
                <!-- èŠ‚ç‚¹ä¼šåŠ¨æ€ç”Ÿæˆ -->
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ”</div>
                    <p>è¯·è¾“å…¥æŸ¥è¯¢å¼€å§‹åˆ†æ</p>
                </div>
            </div>

            <!-- è¯¦æƒ…é¢æ¿ -->
            <div class="detail-panel hidden" id="detailPanel">
                <div class="detail-title" id="detailTitle">
                    <span id="detailIcon">ğŸ“Š</span>
                    <span id="detailName">èŠ‚ç‚¹åç§°</span>
                </div>

                <div class="performance-grid" id="performanceGrid">
                    <!-- æ€§èƒ½æŒ‡æ ‡ä¼šåŠ¨æ€å¡«å…… -->
                </div>

                <div class="detail-section">
                    <div class="detail-section-title">ğŸ“¥ è¾“å…¥</div>
                    <div class="detail-content" id="detailInput">
                        <!-- åŠ¨æ€å¡«å…… -->
                    </div>
                </div>

                <div class="detail-section">
                    <div class="detail-section-title">âš™ï¸ ç®—æ³•/æ–¹æ³•</div>
                    <div class="detail-content" id="detailAlgorithm">
                        <!-- åŠ¨æ€å¡«å…… -->
                    </div>
                </div>

                <div class="detail-section">
                    <div class="detail-section-title">ğŸ“¤ è¾“å‡º</div>
                    <div class="detail-content" id="detailOutput">
                        <!-- åŠ¨æ€å¡«å…… -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';
        let currentQuery = '';
        let currentStep = 0;
        let lastDebugData = null;  // ä¿å­˜æœ€åä¸€æ¬¡çš„ API å“åº”
        let lastExecutionSteps = null;  // ä¿å­˜æ‰§è¡Œæ­¥éª¤

        // æµç¨‹èŠ‚ç‚¹å®šä¹‰
        const FLOW_NODES = [
            {
                id: 'input',
                title: 'ç”¨æˆ·è¾“å…¥',
                icon: 'ğŸ’¬',
                description: 'æ¥æ”¶ç”¨æˆ·è‡ªç„¶è¯­è¨€æŸ¥è¯¢',
                getDetail: (data) => ({
                    input: `æŸ¥è¯¢æ–‡æœ¬: <code>${data.query}</code>`,
                    algorithm: 'N/A',
                    output: 'åŸå§‹æŸ¥è¯¢å­—ç¬¦ä¸²',
                    duration: 0
                })
            },
            {
                id: 'intent',
                title: 'æ„å›¾è¯†åˆ«',
                icon: 'ğŸ¯',
                description: 'è¯†åˆ«æŸ¥è¯¢æ„å›¾å’Œå‚æ•°',
                getDetail: (data) => {
                    const intent = data.intent || {};
                    return {
                        input: `æŸ¥è¯¢: ${data.query}`,
                        algorithm: 'æ­£åˆ™è¡¨è¾¾å¼ + å…³é”®è¯åŒ¹é…',
                        output: `
                            <ul class="detail-list">
                                <li><span class="detail-list-label">æ ¸å¿ƒæŸ¥è¯¢</span><span class="detail-list-value">${intent.core_query || '-'}</span></li>
                                <li><span class="detail-list-label">æ—¶é—´èŒƒå›´</span><span class="detail-list-value">${intent.time_range ? 'æ˜¯' : 'å¦'}</span></li>
                                <li><span class="detail-list-label">èšåˆç±»å‹</span><span class="detail-list-value">${intent.aggregation_type || '-'}</span></li>
                                <li><span class="detail-list-label">è¶‹åŠ¿ç±»å‹</span><span class="detail-list-value">${intent.trend_type || '-'}</span></li>
                                <li><span class="detail-list-label">æ’åºéœ€æ±‚</span><span class="detail-list-value">${intent.sort_requirement ? `Top ${intent.sort_requirement.top_n}` : '-'}</span></li>
                                <li><span class="detail-list-label">é˜ˆå€¼è¿‡æ»¤</span><span class="detail-list-value">${intent.threshold_filters?.length || 0}ä¸ª</span></li>
                            </ul>
                        `,
                        duration: 5
                    };
                }
            },
            {
                id: 'llm_intent',
                title: 'LLMæ„å›¾è¯†åˆ«',
                icon: 'ğŸ¤–',
                description: 'æ™ºè°±AIå¤§æ¨¡å‹æ„å›¾è¯†åˆ«',
                getDetail: (data) => ({
                    input: `æŸ¥è¯¢: ${data.query}`,
                    algorithm: 'Few-shot Learning + Chain of Thought (æ™ºè°±AI glm-4-flash)',
                    output: `
                        <ul class="detail-list">
                            <li><span class="detail-list-label">LLMæ¨¡å‹</span><span class="detail-list-value">glm-4-flash</span></li>
                            <li><span class="detail-list-label">æç¤ºè¯ç­–ç•¥</span><span class="detail-list-value">4-shot + JSONçº¦æŸ</span></li>
                            <li><span class="detail-list-label">Temperature</span><span class="detail-list-value">0.1</span></li>
                        </ul>
                    `,
                    duration: 7000
                })
            },
            {
                id: 'vectorization',
                title: 'æŸ¥è¯¢å‘é‡åŒ–',
                icon: 'ğŸ”„',
                description: 'å°†æŸ¥è¯¢è½¬æ¢ä¸ºå‘é‡',
                getDetail: (data) => ({
                    input: `æ ¸å¿ƒæŸ¥è¯¢: ${data.intent?.core_query || data.query}`,
                    algorithm: 'sentence-transformers (m3e-base)',
                    output: `
                        <ul class="detail-list">
                            <li><span class="detail-list-label">å‘é‡ç»´åº¦</span><span class="detail-list-value">384</span></li>
                            <li><span class="detail-list-label">å‘é‡èŒƒæ•°</span><span class="detail-list-value">1.0</span></li>
                        </ul>
                    `,
                    duration: 700
                })
            },
            {
                id: 'vector_recall',
                title: 'å‘é‡å¬å›',
                icon: 'ğŸ”·',
                description: 'åŒè·¯é“¾è·¯1 - è¯­ä¹‰æ£€ç´¢',
                getDetail: (data) => ({
                    input: `æŸ¥è¯¢å‘é‡: shape=(384,)`,
                    algorithm: 'ä½™å¼¦ç›¸ä¼¼åº¦ + HNSWç´¢å¼•',
                    output: `å¬å› ${data.candidates?.length || 0} ä¸ªå€™é€‰`,
                    duration: 30
                })
            },
            {
                id: 'graph_recall',
                title: 'å›¾è°±å¬å›',
                icon: 'ğŸ”¶',
                description: 'åŒè·¯é“¾è·¯2 - å…³ç³»æ¨ç†',
                getDetail: (data) => ({
                    input: `æ ¸å¿ƒæŸ¥è¯¢: ${data.intent?.core_query || data.query}`,
                    algorithm: 'Neo4j + CypheræŸ¥è¯¢',
                    output: `åŸºäºçŸ¥è¯†å›¾è°±çš„å…³ç³»æ‰©å±•`,
                    duration: 10
                })
            },
            {
                id: 'merge',
                title: 'åŒè·¯åˆå¹¶',
                icon: 'ğŸ”·ğŸ”¶',
                description: 'åˆå¹¶å‘é‡å¬å›å’Œå›¾è°±å¬å›ç»“æœ',
                getDetail: (data) => ({
                    input: 'å‘é‡å¬å›å€™é€‰ + å›¾è°±å¬å›å€™é€‰',
                    algorithm: 'merged_score = 0.6 * vector_score + 0.4 * graph_score',
                    output: `åˆå¹¶å ${data.candidates?.length || 0} ä¸ªå€™é€‰`,
                    duration: 5
                })
            },
            {
                id: 'recall',
                title: 'åŒè·¯å¬å›',
                icon: 'ğŸ”®',
                description: 'å‘é‡å¬å› + å›¾è°±å¬å›',
                getDetail: (data) => ({
                    input: `æ ¸å¿ƒæŸ¥è¯¢: ${data.intent?.core_query || data.query}`,
                    algorithm: 'cos(A, B) = (AÂ·B) / (||A|| Ã— ||B||)',
                    output: `
                        <div class="io-card">
                            <div class="io-card-title">ğŸ”· å‘é‡å¬å›</div>
                            <div class="io-card-content">
                                å¬å› ${data.candidates?.length || 0} ä¸ªå€™é€‰<br>
                                ç›¸ä¼¼åº¦èŒƒå›´: 0.2 - 0.9
                            </div>
                        </div>
                        <div class="io-card">
                            <div class="io-card-title">ğŸ”® å›¾è°±å¬å›</div>
                            <div class="io-card-content">
                                åŸºäºNeo4jå…³ç³»å›¾è°±<br>
                                è¡¥å……ç›¸å…³è”çš„æŒ‡æ ‡
                            </div>
                        </div>
                    `,
                    duration: 150
                })
            },
            {
                id: 'feature',
                title: 'ç‰¹å¾æå–',
                icon: 'ğŸ§®',
                description: 'æå–11ç»´ç‰¹å¾å‘é‡',
                getDetail: (data) => ({
                    input: `${data.candidates?.length || 0} ä¸ªå€™é€‰æŒ‡æ ‡`,
                    algorithm: 'å¤šç‰¹å¾èåˆï¼ˆå‘é‡ã€å›¾è°±ã€æ–‡æœ¬ã€é¢†åŸŸç­‰ï¼‰',
                    output: `
                        <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                            <span class="tag tag-primary">å‘é‡ç›¸ä¼¼åº¦ 0.30</span>
                            <span class="tag tag-primary">å›¾è°±åˆ†æ•° 0.15</span>
                            <span class="tag tag-primary">ç²¾ç¡®åŒ¹é… 0.15</span>
                            <span class="tag tag-primary">æŸ¥è¯¢è¦†ç›– 0.08</span>
                            <span class="tag tag-primary">æ–‡æœ¬ç›¸å…³ 0.05</span>
                            <span class="tag">é¢†åŸŸåŒ¹é…</span>
                            <span class="tag">åŒä¹‰è¯</span>
                            <span class="tag">å­—é¢åŒ¹é…</span>
                            <span class="tag">ç¼–è¾‘è·ç¦»</span>
                            <span class="tag">è¯­ä¹‰ç›¸ä¼¼</span>
                            <span class="tag">ä½ç½®æƒé‡</span>
                        </div>
                    `,
                    duration: 50
                })
            },
            {
                id: 'rank',
                title: 'ç²¾æ’æ‰“åˆ†',
                icon: 'âš–ï¸',
                description: 'åŸºäºç‰¹å¾æƒé‡è®¡ç®—æœ€ç»ˆå¾—åˆ†',
                getDetail: (data) => ({
                    input: '11ç»´ç‰¹å¾å‘é‡',
                    algorithm: 'Score = Î£(feature_i Ã— weight_i)',
                    output: `
                        <ul class="detail-list">
                            ${data.candidates?.slice(0, 3).map((c, i) => `
                                <li>
                                    <span class="detail-list-label">#${i + 1} ${c.name}</span>
                                    <span class="detail-list-value">${(c.score * 100).toFixed(1)}%</span>
                                </li>
                            `).join('') || '<li>æš‚æ— æ•°æ®</li>'}
                        </ul>
                    `,
                    duration: 80
                })
            },
            {
                id: 'validate',
                title: 'ç»“æœéªŒè¯',
                icon: 'âœ…',
                description: 'éªŒè¯ç»“æœçš„æœ‰æ•ˆæ€§',
                getDetail: (data) => ({
                    input: `${data.candidates?.length || 0} ä¸ªç²¾æ’ç»“æœ`,
                    algorithm: 'è§„åˆ™éªŒè¯ï¼ˆç»´åº¦å…¼å®¹æ€§ã€æ—¶é—´ç²’åº¦ã€æ•°æ®æ–°é²œåº¦ï¼‰',
                    output: `
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                            <span class="tag tag-success">âœ“ ç»´åº¦å…¼å®¹</span>
                            <span class="tag tag-success">âœ“ æ—¶é—´ç²’åº¦</span>
                            <span class="tag tag-success">âœ“ æ•°æ®æ–°é²œåº¦</span>
                            <span class="tag tag-success">âœ“ æƒé™éªŒè¯</span>
                        </div>
                        <div style="margin-top: 8px; font-size: 13px;">
                            æœ€ç»ˆè¿”å›: <strong>${data.total || 0}</strong> ä¸ªç»“æœ
                        </div>
                    `,
                    duration: 20
                })
            },
            {
                id: 'output',
                title: 'æœ€ç»ˆè¾“å‡º',
                icon: 'ğŸ¯',
                description: 'è¿”å›æ ¼å¼åŒ–çš„æ£€ç´¢ç»“æœ',
                getDetail: (data) => ({
                    input: 'éªŒè¯é€šè¿‡çš„å€™é€‰åˆ—è¡¨',
                    algorithm: 'JSONåºåˆ—åŒ– + å“åº”æ ¼å¼åŒ–',
                    output: `
                        <div class="io-card">
                            <div class="io-card-title">ğŸ“Š å“åº”æ•°æ®</div>
                            <div class="io-card-content">
                                <ul class="detail-list">
                                    <li><span class="detail-list-label">query</span><span class="detail-list-value">${data.query}</span></li>
                                    <li><span class="detail-list-label">total</span><span class="detail-list-value">${data.total}</span></li>
                                    <li><span class="detail-list-label">execution_time</span><span class="detail-list-value">${data.execution_time?.toFixed(2)}ms</span></li>
                                    <li><span class="detail-list-label">conversation_id</span><span class="detail-list-value">${data.conversation_id?.substring(0, 8)}...</span></li>
                                </ul>
                            </div>
                        </div>
                    `,
                    duration: 10
                })
            }
        ];

        function setQuery(query) {
            document.getElementById('queryInput').value = query;
            analyzeQuery();
        }

        async function analyzeQuery() {
            const query = document.getElementById('queryInput').value.trim();
            if (!query) return;

            currentQuery = query;
            currentStep = 0;

            // æ¸…ç©ºä¹‹å‰çš„è¯¦æƒ…
            hideDetailPanel();

            // æ¸²æŸ“æµç¨‹å›¾èŠ‚ç‚¹
            renderFlowchart();

            // è°ƒç”¨ Debug API
            try {
                const response = await fetch(`${API_BASE}/debug/search-debug`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query: query,
                        top_k: 10
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();

                // ä¿å­˜æ•°æ®ä¾›åç»­ç‚¹å‡»ä½¿ç”¨
                lastDebugData = data;
                lastExecutionSteps = data.execution_steps;

                // ä½¿ç”¨çœŸå®æ•°æ®æ‰§è¡Œæµç¨‹
                await executeFlowWithRealData(data);

            } catch (error) {
                console.error('Error:', error);
                alert(`åˆ†æå¤±è´¥: ${error.message}`);
            }
        }

        async function executeFlowWithRealData(debugData) {
            const { execution_steps } = debugData;

            // æ›´æ–°æ¯ä¸ªèŠ‚ç‚¹çš„çŠ¶æ€
            for (let i = 0; i < FLOW_NODES.length && i < execution_steps.length; i++) {
                const node = FLOW_NODES[i];
                const step = execution_steps[i];

                const nodeElement = document.getElementById(`node-${node.id}`);
                const statusElement = document.getElementById(`status-${node.id}`);
                const durationElement = document.getElementById(`duration-${node.id}`);

                // æ ‡è®°ä¸ºå¤„ç†ä¸­
                if (nodeElement) {
                    nodeElement.classList.add('processing');
                    if (statusElement) statusElement.textContent = 'å¤„ç†ä¸­...';
                    if (statusElement) statusElement.classList.add('processing');
                }

                // ç­‰å¾…ä¸€å°æ®µæ—¶é—´æ¨¡æ‹Ÿå¤„ç†
                await sleep(200);

                // æ›´æ–°ä¸ºå®ŒæˆçŠ¶æ€
                if (nodeElement) {
                    nodeElement.classList.remove('processing');
                    nodeElement.classList.add('completed');
                    if (statusElement) {
                        statusElement.textContent = step.success ? 'å®Œæˆ' : 'å¤±è´¥';
                        statusElement.classList.remove('processing');
                        if (step.success) {
                            statusElement.classList.add('completed');
                        }
                    }
                    if (durationElement) {
                        durationElement.textContent = step.duration_ms.toFixed(0);
                    }
                }

                // æ¿€æ´»è¿æ¥çº¿
                if (i < FLOW_NODES.length - 1) {
                    const connector = document.getElementById(`connector-${node.id}`);
                    if (connector) connector.classList.add('active');
                }

                // è‡ªåŠ¨æ˜¾ç¤ºç¬¬ä¸€ä¸ªå®Œæˆçš„èŠ‚ç‚¹è¯¦æƒ…
                if (i === 0 && nodeElement) {
                    showNodeDetailFromStep(node.id, step);
                }

                await sleep(100);
            }

            // æ›´æ–°æ€»è€—æ—¶ï¼ˆæ˜¾ç¤ºåœ¨è¯¦æƒ…é¢æ¿ä¸­ï¼‰
            // æ³¨ï¼šæ€»è€—æ—¶ä¼šåœ¨æ˜¾ç¤ºç¬¬ä¸€ä¸ªèŠ‚ç‚¹æ—¶æ›´æ–°
        }

        /**
         * ä»çœŸå®çš„ Debug API æ•°æ®å±•ç¤ºèŠ‚ç‚¹è¯¦æƒ…
         * @param {string} nodeId - èŠ‚ç‚¹ID
         * @param {object} step - æ‰§è¡Œæ­¥éª¤è¯¦æƒ…
         */
        function showNodeDetailFromStep(nodeId, step) {
            const node = FLOW_NODES.find(n => n.id === nodeId);
            if (!node) return;

            // é«˜äº®å½“å‰èŠ‚ç‚¹
            document.querySelectorAll('.flow-node').forEach(el => el.classList.remove('active'));
            const nodeElement = document.getElementById(`node-${nodeId}`);
            if (nodeElement) {
                nodeElement.classList.add('active');
            }

            // æ˜¾ç¤ºè¯¦æƒ…é¢æ¿
            const panel = document.getElementById('detailPanel');
            panel.classList.remove('hidden');

            // å¡«å……æ ‡é¢˜
            document.getElementById('detailIcon').textContent = node.icon;
            document.getElementById('detailName').textContent = step.step_name;

            // å¡«å……æ€§èƒ½æŒ‡æ ‡
            const perfGrid = document.getElementById('performanceGrid');
            perfGrid.innerHTML = `
                <div class="perf-card">
                    <div class="perf-label">æ‰§è¡Œæ—¶é—´</div>
                    <div class="perf-value">${step.duration_ms.toFixed(0)}ms</div>
                </div>
                <div class="perf-card">
                    <div class="perf-label">çŠ¶æ€</div>
                    <div class="perf-value" style="font-size: 18px;">${step.success ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥'}</div>
                </div>
            `;

            // å¡«å……è¾“å…¥æ•°æ®
            document.getElementById('detailInput').innerHTML = formatData(step.input_data);

            // å¡«å……ç®—æ³•ï¼ˆä¿ç•™æ¢è¡Œå’Œæ ¼å¼ï¼‰
            document.getElementById('detailAlgorithm').innerHTML = `
                <pre style="white-space: pre-wrap; font-family: 'Monaco', 'Consolas', monospace; font-size: 12px; line-height: 1.5; margin: 0;">${escapeHtml(step.algorithm)}</pre>
            `;

            // å¡«å……è¾“å‡ºæ•°æ®
            document.getElementById('detailOutput').innerHTML = formatData(step.output_data);

            // å¦‚æœæœ‰é”™è¯¯ä¿¡æ¯,æ˜¾ç¤º
            if (!step.success && step.error_message) {
                document.getElementById('detailOutput').innerHTML += `
                    <div style="margin-top: 12px; padding: 8px; background: #fed7d7; border-left: 3px solid #fc8181; color: #742a2a;">
                        <strong>é”™è¯¯:</strong> ${escapeHtml(step.error_message)}
                    </div>
                `;
            }
        }

        /**
         * æ ¼å¼åŒ–æ•°æ®ä¸ºå¯è¯»çš„HTML
         * @param {any} data - è¦æ ¼å¼åŒ–çš„æ•°æ®
         * @returns {string} HTMLå­—ç¬¦ä¸²
         */
        function formatData(data) {
            if (!data) return '<span style="color: #a0aec0;">æ— æ•°æ®</span>';

            if (typeof data === 'string') {
                return escapeHtml(data);
            }

            if (Array.isArray(data)) {
                if (data.length === 0) return '<span style="color: #a0aec0;">ç©ºæ•°ç»„</span>';
                return `<ul class="detail-list">
                    ${data.map(item => `
                        <li>
                            <span class="detail-list-value">${formatSingleItem(item)}</span>
                        </li>
                    `).join('')}
                </ul>`;
            }

            if (typeof data === 'object') {
                const keys = Object.keys(data);
                if (keys.length === 0) return '<span style="color: #a0aec0;">ç©ºå¯¹è±¡</span>';
                return `<ul class="detail-list">
                    ${keys.map(key => `
                        <li>
                            <span class="detail-list-label">${escapeHtml(key)}</span>
                            <span class="detail-list-value">${formatSingleItem(data[key])}</span>
                        </li>
                    `).join('')}
                </ul>`;
            }

            return String(data);
        }

        /**
         * æ ¼å¼åŒ–å•ä¸ªæ•°æ®é¡¹
         * @param {any} item - æ•°æ®é¡¹
         * @returns {string} HTMLå­—ç¬¦ä¸²
         */
        function formatSingleItem(item) {
            if (item === null) return '<span style="color: #a0aec0;">null</span>';
            if (item === undefined) return '<span style="color: #a0aec0;">undefined</span>';

            if (typeof item === 'string') {
                return escapeHtml(item);
            }

            if (typeof item === 'object') {
                return `<code style="font-size: 11px;">${escapeHtml(JSON.stringify(item))}</code>`;
            }

            return String(item);
        }

        /**
         * è½¬ä¹‰HTMLç‰¹æ®Šå­—ç¬¦
         * @param {string} text - è¦è½¬ä¹‰çš„æ–‡æœ¬
         * @returns {string} è½¬ä¹‰åçš„æ–‡æœ¬
         */
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function renderFlowchart() {
            const container = document.getElementById('flowchart');

            let html = '';

            FLOW_NODES.forEach((node, index) => {
                // æ·»åŠ èŠ‚ç‚¹
                html += `
                    <div class="flow-node" id="node-${node.id}" onclick="handleNodeClick('${node.id}')">
                        <div class="node-header">
                            <div class="node-icon">${node.icon}</div>
                            <div>
                                <div class="node-title">${node.title}</div>
                                <div class="node-meta">
                                    <span class="meta-item">â±ï¸ <span id="duration-${node.id}">-</span>ms</span>
                                </div>
                            </div>
                        </div>
                        <div class="node-status" id="status-${node.id}">ç­‰å¾…ä¸­</div>
                    </div>
                `;

                // æ·»åŠ è¿æ¥çº¿ï¼ˆé™¤äº†æœ€åä¸€ä¸ªèŠ‚ç‚¹ï¼‰
                if (index < FLOW_NODES.length - 1) {
                    html += `<div class="flow-connector" id="connector-${node.id}"></div>`;
                }
            });

            container.innerHTML = html;
        }

        /**
         * å¤„ç†èŠ‚ç‚¹ç‚¹å‡»äº‹ä»¶
         * @param {string} nodeId - èŠ‚ç‚¹ID
         */
        function handleNodeClick(nodeId) {
            // å¦‚æœæœ‰çœŸå®çš„æ‰§è¡Œæ­¥éª¤æ•°æ®,ä½¿ç”¨å®ƒ
            if (lastExecutionSteps) {
                const nodeIndex = FLOW_NODES.findIndex(n => n.id === nodeId);
                if (nodeIndex >= 0 && nodeIndex < lastExecutionSteps.length) {
                    showNodeDetailFromStep(nodeId, lastExecutionSteps[nodeIndex]);
                    return;
                }
            }

            // å¦åˆ™å°è¯•ä½¿ç”¨ mock æ•°æ®
            if (lastDebugData) {
                showNodeDetail(nodeId, lastDebugData);
            } else {
                // å¦‚æœæ²¡æœ‰ä»»ä½•æ•°æ®,æ˜¾ç¤ºæç¤º
                alert('è¯·å…ˆæ‰§è¡ŒæŸ¥è¯¢ä»¥æŸ¥çœ‹è¯¦æƒ…');
            }
        }

        async function simulateFlowExecution(data) {
            // ä¾æ¬¡æ‰§è¡Œæ¯ä¸ªæ­¥éª¤
            for (let i = 0; i < FLOW_NODES.length; i++) {
                const node = FLOW_NODES[i];
                const nodeElement = document.getElementById(`node-${node.id}`);
                const statusElement = document.getElementById(`status-${node.id}`);
                const durationElement = document.getElementById(`duration-${node.id}`);

                // æ ‡è®°ä¸ºå¤„ç†ä¸­
                nodeElement.classList.add('processing');
                statusElement.textContent = 'å¤„ç†ä¸­...';
                statusElement.classList.add('processing');

                // æ¨¡æ‹Ÿå¤„ç†æ—¶é—´
                const detail = node.getDetail(data);
                await sleep(300);

                // æ ‡è®°ä¸ºå®Œæˆ
                nodeElement.classList.remove('processing');
                nodeElement.classList.add('completed');
                statusElement.textContent = 'å®Œæˆ';
                statusElement.classList.remove('processing');
                statusElement.classList.add('completed');
                durationElement.textContent = detail.duration || Math.floor(data.execution_time / FLOW_NODES.length);

                // æ¿€æ´»è¿æ¥çº¿
                if (i < FLOW_NODES.length - 1) {
                    const connector = document.getElementById(`connector-${node.id}`);
                    connector.classList.add('active');
                }

                // è‡ªåŠ¨æ˜¾ç¤ºç¬¬ä¸€ä¸ªå®Œæˆçš„èŠ‚ç‚¹è¯¦æƒ…
                if (i === 0) {
                    showNodeDetail(node.id, data);
                }

                await sleep(200);
            }
        }

        function showNodeDetail(nodeId, data = null) {
            const node = FLOW_NODES.find(n => n.id === nodeId);
            if (!node) return;

            // é«˜äº®å½“å‰èŠ‚ç‚¹
            document.querySelectorAll('.flow-node').forEach(el => el.classList.remove('active'));
            document.getElementById(`node-${nodeId}`).classList.add('active');

            // æ˜¾ç¤ºè¯¦æƒ…é¢æ¿
            const panel = document.getElementById('detailPanel');
            panel.classList.remove('hidden');

            // å¡«å……æ ‡é¢˜
            document.getElementById('detailIcon').textContent = node.icon;
            document.getElementById('detailName').textContent = node.title;

            // å¦‚æœæ²¡æœ‰ä¼ å…¥æ•°æ®ï¼Œå°è¯•è·å–å½“å‰æ•°æ®
            if (!data) {
                // è¿™é‡Œå¯ä»¥ä¿å­˜æœ€åä¸€æ¬¡çš„ API å“åº”
                return;
            }

            const detail = node.getDetail(data);

            // å¡«å……æ€§èƒ½æŒ‡æ ‡
            const perfGrid = document.getElementById('performanceGrid');
            perfGrid.innerHTML = `
                <div class="perf-card">
                    <div class="perf-label">æ‰§è¡Œæ—¶é—´</div>
                    <div class="perf-value">${detail.duration || Math.floor(data.execution_time / FLOW_NODES.length)}ms</div>
                </div>
                <div class="perf-card">
                    <div class="perf-label">ç´¯è®¡è€—æ—¶</div>
                    <div class="perf-value">${data.execution_time?.toFixed(0) || 0}ms</div>
                </div>
            `;

            // å¡«å……è¯¦æƒ…
            document.getElementById('detailInput').innerHTML = detail.input;
            document.getElementById('detailAlgorithm').innerHTML = detail.algorithm;
            document.getElementById('detailOutput').innerHTML = detail.output;
        }

        function hideDetailPanel() {
            document.getElementById('detailPanel').classList.add('hidden');
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // é¡µé¢åŠ è½½å®Œæˆå
        window.addEventListener('load', () => {
            document.getElementById('queryInput').focus();
        });
    </script>
</body>
</html>
