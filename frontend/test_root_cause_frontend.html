<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ ¹å› åˆ†ææµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            padding: 20px;
            background: #f7fafc;
        }
        .test-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px;
            font-size: 14px;
            font-weight: 600;
        }
        .test-button:hover {
            background: #5a67d8;
        }
        #result {
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 12px;
            min-height: 200px;
        }
    </style>
</head>
<body>
    <h1>ğŸ” æ ¹å› åˆ†æåŠŸèƒ½æµ‹è¯•</h1>

    <div>
        <button class="test-button" onclick="testGMVDecline()">æµ‹è¯•1: GMVä¸‹é™åˆ†æ</button>
        <button class="test-button" onclick="testDAUGrowth()">æµ‹è¯•2: DAUå¢é•¿åˆ†æ</button>
        <button class="test-button" onclick="testWithAPICall()">æµ‹è¯•3: é€šè¿‡APIè°ƒç”¨</button>
    </div>

    <div id="result"></div>

    <script>
        // æ¨¡æ‹Ÿæ ¹å› åˆ†ææ•°æ®
        const mockRootCauseData = {
            "query": "ä¸ºä»€ä¹ˆGMVä¸‹é™äº†ï¼Ÿ",
            "metric": "GMV",
            "anomalies": [
                {
                    "timestamp": "2026-02-04",
                    "value": 35000.0,
                    "expected": 50000.0,
                    "deviation": 15000.0,
                    "deviation_pct": 30.0,
                    "severity": "high",
                    "type": "dip"
                },
                {
                    "timestamp": "2026-02-05",
                    "value": 30000.0,
                    "expected": 50000.0,
                    "deviation": 20000.0,
                    "deviation_pct": 40.0,
                    "severity": "high",
                    "type": "dip"
                }
            ],
            "dimensions": [
                {
                    "dimension_name": "åœ°åŒº",
                    "total_value": 1000000.0,
                    "top_contributors": [
                        {"name": "åä¸œ", "value": 500000.0, "contribution_pct": 50.0},
                        {"name": "åå—", "value": 300000.0, "contribution_pct": 30.0},
                        {"name": "ååŒ—", "value": 200000.0, "contribution_pct": 20.0}
                    ],
                    "analysis": "åœ°åŒºç»´åº¦é«˜åº¦é›†ä¸­ï¼Œåä¸œå æ¯”50.0%"
                }
            ],
            "trends": {
                "trend_type": "downward",
                "trend_strength": 0.76,
                "slope": -2500.0,
                "r_squared": 0.85,
                "turning_points": [],
                "forecast": [28500, 26000, 23500]
            },
            "causal_factors": [
                {
                    "name": "ä¾›åº”é“¾é—®é¢˜",
                    "category": "internal",
                    "confidence": 0.85,
                    "evidence": ["åº“å­˜ä¸è¶³", "ç‰©æµå»¶è¿Ÿ"],
                    "explanation": "ä¾›åº”é“¾ä¸­æ–­ä¼šå¯¼è‡´å•†å“ç¼ºè´§ï¼Œç›´æ¥å½±å“é”€å”®é¢",
                    "actionable": true
                },
                {
                    "name": "å¸‚åœºç«äº‰",
                    "category": "external",
                    "confidence": 0.70,
                    "evidence": ["ç«å“ä¿ƒé”€", "ä»·æ ¼æˆ˜"],
                    "explanation": "ç«äº‰å¯¹æ‰‹çš„ä¿ƒé”€æ´»åŠ¨å¯èƒ½åˆ†æµå®¢æˆ·",
                    "actionable": true
                }
            ],
            "report": "GMVæ•´ä½“å‘ˆç°downwardè¶‹åŠ¿ï¼Œè¶‹åŠ¿å¼ºåº¦ä¸º0.76ã€‚\nä¸»è¦åŸå› æ˜¯ä¾›åº”é“¾é—®é¢˜ã€å¸‚åœºç«äº‰ã€‚\n- ä¾›åº”é“¾é—®é¢˜ï¼šä¾›åº”é“¾ä¸­æ–­ä¼šå¯¼è‡´å•†å“ç¼ºè´§ï¼Œç›´æ¥å½±å“é”€å”®é¢\n- å¸‚åœºç«äº‰ï¼šç«äº‰å¯¹æ‰‹çš„ä¿ƒé”€æ´»åŠ¨å¯èƒ½åˆ†æµå®¢æˆ·\nå»ºè®®ä¼˜å…ˆå¤„ç†ä¾›åº”é“¾é—®é¢˜é—®é¢˜ï¼Œè¿™å°†æœ‰åŠ©äºæ”¹å–„GMVè¡¨ç°ã€‚",
            "recommendations": [
                "æ£€æŸ¥åº“å­˜æ°´å¹³å’Œä¾›åº”é“¾çŠ¶æ€ï¼Œç¡®ä¿å•†å“ä¾›åº”å……è¶³",
                "ä¼˜åŒ–åœ°åŒºç»“æ„ï¼Œé™ä½å¯¹åä¸œçš„è¿‡åº¦ä¾èµ–"
            ]
        };

        function testGMVDecline() {
            displayResult(mockRootCauseData);
        }

        function testDAUGrowth() {
            const dauData = {
                ...mockRootCauseData,
                "query": "ä¸ºä»€ä¹ˆDAUçªç„¶å¢é•¿äº†ï¼Ÿ",
                "metric": "DAU",
                "trends": {
                    "trend_type": "upward",
                    "trend_strength": 0.91,
                    "slope": 2500.0,
                    "r_squared": 0.88,
                    "turning_points": [],
                    "forecast": [21500, 24000, 26500]
                },
                "causal_factors": [
                    {
                        "name": "è¥é”€æ´»åŠ¨",
                        "category": "internal",
                        "confidence": 0.95,
                        "evidence": ["æ–°æ¸ é“æŠ•æ”¾", "ç—…æ¯’ä¼ æ’­"],
                        "explanation": "è¥é”€æ¨å¹¿é€šå¸¸ä¼šå¸¦æ¥çŸ­æœŸå†…ç”¨æˆ·å¢é•¿",
                        "actionable": true
                    },
                    {
                        "name": "äº§å“ä¼˜åŒ–",
                        "category": "internal",
                        "confidence": 0.85,
                        "evidence": ["æ–°åŠŸèƒ½", "ä½“éªŒä¼˜åŒ–"],
                        "explanation": "äº§å“ä½“éªŒæå‡ä¼šå¸å¼•æ›´å¤šç”¨æˆ·ä½¿ç”¨",
                        "actionable": true
                    }
                ],
                "report": "DAUæ•´ä½“å‘ˆç°upwardè¶‹åŠ¿ï¼Œè¶‹åŠ¿å¼ºåº¦ä¸º0.91ã€‚\nä¸»è¦åŸå› æ˜¯è¥é”€æ´»åŠ¨ã€äº§å“ä¼˜åŒ–ã€‚\nå»ºè®®ä¼˜å…ˆå¤„ç†è¥é”€æ´»åŠ¨é—®é¢˜ï¼Œè¿™å°†æœ‰åŠ©äºæ”¹å–„DAUè¡¨ç°ã€‚",
                "recommendations": [
                    "ä¼˜åŒ–è¥é”€ç­–ç•¥ï¼Œæå‡æ¸ é“æŠ•æ”¾æ•ˆç‡",
                    "æŒç»­äº§å“åˆ›æ–°ï¼Œæå‡ç”¨æˆ·ä½“éªŒå’Œç²˜æ€§"
                ]
            };
            displayResult(dauData);
        }

        async function testWithAPICall() {
            try {
                const response = await fetch('http://localhost:8000/api/v3/query', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({query: 'åˆ†æGMV'})
                });

                if (!response.ok) {
                    throw new Error('APIè¯·æ±‚å¤±è´¥');
                }

                const data = await response.json();
                console.log('API Response:', data);

                document.getElementById('result').innerHTML = `
                    <h2>APIå“åº”</h2>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                `;
            } catch (error) {
                document.getElementById('result').innerHTML = `
                    <h2>é”™è¯¯</h2>
                    <p style="color: #f56565;">${error.message}</p>
                `;
            }
        }

        function displayResult(rootCause) {
            let html = '<div style="display: flex; flex-direction: column; gap: 24px;">';

            // åˆ†ææŠ¥å‘Šå¡ç‰‡
            html += `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 12px; padding: 24px;">
                    <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">ğŸ” æ ¹å› åˆ†ææŠ¥å‘Š</div>
                    <div style="font-size: 18px; font-weight: 700; line-height: 1.6; white-space: pre-wrap;">${rootCause.report}</div>
                </div>
            `;

            // å¼‚å¸¸æ£€æµ‹
            if (rootCause.anomalies && rootCause.anomalies.length > 0) {
                html += `
                    <div style="background: white; border: 2px solid #e2e8f0; border-radius: 12px; padding: 20px;">
                        <div style="font-size: 18px; font-weight: 700; color: #2d3748; margin-bottom: 16px;">âš ï¸ æ£€æµ‹åˆ°çš„å¼‚å¸¸</div>
                `;

                rootCause.anomalies.forEach(anomaly => {
                    const severityColor = {
                        'high': '#f56565',
                        'medium': '#ed8936',
                        'low': '#48bb78'
                    }[anomaly.severity] || '#718096';

                    const typeIcon = {
                        'spike': 'ğŸ“ˆ',
                        'dip': 'ğŸ“‰',
                        'high': 'â¬†ï¸',
                        'low': 'â¬‡ï¸'
                    }[anomaly.type] || 'â“';

                    html += `
                        <div style="background: ${severityColor}10; border-left: 4px solid ${severityColor}; padding: 16px; border-radius: 8px; margin-bottom: 12px;">
                            <div style="font-size: 20px; margin-bottom: 8px;">${typeIcon}</div>
                            <div style="font-size: 14px; font-weight: 600; color: #2d3748; margin-bottom: 4px;">
                                ${anomaly.timestamp}
                            </div>
                            <div style="font-size: 13px; color: #718096;">
                                å®é™…å€¼: ${anomaly.value.toFixed(2)} | æœŸæœ›å€¼: ${anomaly.expected.toFixed(2)}
                            </div>
                            <div style="font-size: 13px; color: ${severityColor}; font-weight: 600; margin-top: 4px;">
                                åç¦»åº¦: ${anomaly.deviation_pct.toFixed(1)}%
                            </div>
                        </div>
                    `;
                });

                html += '</div>';
            }

            // è¶‹åŠ¿åˆ†æ
            if (rootCause.trends) {
                const trend = rootCause.trends;
                const trendIcon = {
                    'upward': 'ğŸ“ˆ',
                    'downward': 'ğŸ“‰',
                    'stable': 'â¡ï¸',
                    'volatile': 'ğŸ“Š'
                }[trend.trend_type] || 'â“';

                html += `
                    <div style="background: white; border: 2px solid #e2e8f0; border-radius: 12px; padding: 20px;">
                        <div style="font-size: 18px; font-weight: 700; color: #2d3748; margin-bottom: 16px;">ğŸ“ˆ è¶‹åŠ¿åˆ†æ</div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div style="background: #f7fafc; padding: 16px; border-radius: 10px; text-align: center;">
                                <div style="font-size: 32px;">${trendIcon}</div>
                                <div style="font-size: 14px; color: #718096; margin-top: 8px;">è¶‹åŠ¿ç±»å‹</div>
                                <div style="font-size: 16px; font-weight: 600; color: #2d3748;">${trend.trend_type}</div>
                            </div>
                            <div style="background: #f7fafc; padding: 16px; border-radius: 10px; text-align: center;">
                                <div style="font-size: 32px;">${(trend.trend_strength * 100).toFixed(0)}%</div>
                                <div style="font-size: 14px; color: #718096; margin-top: 8px;">è¶‹åŠ¿å¼ºåº¦</div>
                            </div>
                            <div style="background: #f7fafc; padding: 16px; border-radius: 10px; text-align: center;">
                                <div style="font-size: 32px;">${trend.slope.toFixed(2)}</div>
                                <div style="font-size: 14px; color: #718096; margin-top: 8px;">æ–œç‡</div>
                            </div>
                            <div style="background: #f7fafc; padding: 16px; border-radius: 10px; text-align: center;">
                                <div style="font-size: 32px;">${(trend.r_squared * 100).toFixed(1)}%</div>
                                <div style="font-size: 14px; color: #718096; margin-top: 8px;">æ‹Ÿåˆåº¦</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // ç»´åº¦åˆ†è§£
            if (rootCause.dimensions && rootCause.dimensions.length > 0) {
                html += `
                    <div style="background: white; border: 2px solid #e2e8f0; border-radius: 12px; padding: 20px;">
                        <div style="font-size: 18px; font-weight: 700; color: #2d3748; margin-bottom: 16px;">ğŸ“Š ç»´åº¦åˆ†è§£åˆ†æ</div>
                `;

                rootCause.dimensions.forEach(dim => {
                    html += `
                        <div style="margin-bottom: 20px; padding: 16px; background: #f7fafc; border-radius: 10px;">
                            <div style="font-size: 16px; font-weight: 600; color: #2d3748; margin-bottom: 12px;">${dim.dimension_name}ç»´åº¦</div>
                            <div style="font-size: 13px; color: #48bb78; margin-bottom: 16px;">${dim.analysis}</div>
                            <div style="display: flex; flex-direction: column; gap: 8px;">
                    `;

                    dim.top_contributors.forEach(contributor => {
                        const pct = contributor.contribution_pct;
                        html += `
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div style="width: 100px; font-size: 13px; color: #2d3748; font-weight: 500;">${contributor.name}</div>
                                <div style="flex: 1; background: #e2e8f0; height: 20px; border-radius: 10px; position: relative; overflow: hidden;">
                                    <div style="position: absolute; left: 0; top: 0; height: 100%; width: ${pct}%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);"></div>
                                </div>
                                <div style="width: 60px; font-size: 13px; color: #667eea; font-weight: 600; text-align: right;">${pct.toFixed(1)}%</div>
                            </div>
                        `;
                    });

                    html += `
                            </div>
                        </div>
                    `;
                });

                html += `
                    </div>
                `;
            }

            // å› æœæ¨æ–­
            if (rootCause.causal_factors && rootCause.causal_factors.length > 0) {
                html += `
                    <div style="background: white; border: 2px solid #e2e8f0; border-radius: 12px; padding: 20px;">
                        <div style="font-size: 18px; font-weight: 700; color: #2d3748; margin-bottom: 16px;">ğŸ”— æ½œåœ¨åŸå› åˆ†æ</div>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                `;

                rootCause.causal_factors.forEach(factor => {
                    const categoryColor = {
                        'internal': '#4299e1',
                        'external': '#ed8936',
                        'structural': '#48bb78'
                    }[factor.category] || '#718096';

                    const categoryIcon = {
                        'internal': 'ğŸ¢',
                        'external': 'ğŸŒ',
                        'structural': 'ğŸ—ï¸'
                    }[factor.category] || 'â“';

                    html += `
                        <div style="border: 2px solid ${categoryColor}; border-radius: 10px; padding: 16px;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <span style="font-size: 24px;">${categoryIcon}</span>
                                    <div style="font-size: 16px; font-weight: 700; color: #2d3748;">${factor.name}</div>
                                </div>
                                <div style="font-size: 14px; padding: 4px 12px; background: ${categoryColor}; color: white; border-radius: 6px; font-weight: 600;">
                                    ${(factor.confidence * 100).toFixed(0)}% ç½®ä¿¡åº¦
                                </div>
                            </div>
                            <div style="font-size: 13px; color: #718096; line-height: 1.6; margin-bottom: 12px;">
                                ${factor.explanation}
                            </div>
                            <div style="font-size: 12px; color: #718096;">
                                <strong>è¯æ®ï¼š</strong>
                                ${factor.evidence.map(e => `<span style="display: inline-block; background: #f7fafc; padding: 2px 8px; border-radius: 4px; margin: 2px;">${e}</span>`).join('')}
                            </div>
                        </div>
                    `;
                });

                html += `
                        </div>
                    </div>
                `;
            }

            // è¡ŒåŠ¨å»ºè®®
            if (rootCause.recommendations && rootCause.recommendations.length > 0) {
                html += `
                    <div style="background: white; border: 2px solid #48bb78; border-radius: 12px; padding: 20px;">
                        <div style="font-size: 18px; font-weight: 700; color: #2d3748; margin-bottom: 16px;">ğŸ’¡ è¡ŒåŠ¨å»ºè®®</div>
                        <ul style="margin: 0; padding-left: 20px;">
                `;

                rootCause.recommendations.forEach(rec => {
                    html += `
                        <li style="margin-bottom: 8px; font-size: 14px; color: #2d3748; line-height: 1.6;">${rec}</li>
                    `;
                });

                html += `
                        </ul>
                    </div>
                `;
            }

            html += '</div>';
            document.getElementById('result').innerHTML = html;
        }
    </script>
</body>
</html>
