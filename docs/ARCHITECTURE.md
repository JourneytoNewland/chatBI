# 系统架构设计文档

## 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    智能问数系统架构                          │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                       用户界面层                             │
│  • Web UI (React/Vue)                                       │
│  • CLI 命令行工具                                           │
│  • 第三方系统集成                                           │
└────────────────────┬────────────────────────────────────────┘
                     │ HTTP/REST
┌────────────────────▼────────────────────────────────────────┐
│                      API层 (FastAPI)                        │
│  ┌────────────────────────────────────────────────────┐   │
│  │ POST /api/v1/search                                │   │
│  │ - 接收自然语言查询                                  │   │
│  │ - 返回Top-K指标                                     │   │
│  │ - 执行时间统计                                      │   │
│  └────────────────────────────────────────────────────┘   │
│  ┌────────────────────────────────────────────────────┐   │
│  │ GET /health                                         │   │
│  │ - 健康检查                                          │   │
│  └────────────────────────────────────────────────────┘   │
└────────────────────┬────────────────────────────────────────┘
                     │
        ┌────────────┴────────────┐
        │                         │
┌───────▼────────┐      ┌────────▼────────┐
│  Phase 1       │      │  Phase 2        │
│  向量召回层     │      │  图谱召回层     │
├────────────────┤      ├─────────────────┤
│ 向量化器        │      │ Neo4j客户端     │
│ • m3e-base     │      │ • 连接管理      │
│ • 768维向量    │      │ • 查询执行      │
│                │      │                 │
│ Qdrant存储     │      │ 图谱存储        │
│ • HNSW索引     │      │ • 节点管理      │
│ • ANN检索      │      │ • 关系管理      │
│ • 批量upsert   │      │                 │
│                │      │ 图谱召回器      │
│ 单路召回       │      │ • 文本召回      │
│ • 语义相似度   │      │ • 域召回        │
│ • Top-K        │      │ • 关系召回      │
└───────┬────────┘      │ • 混合召回      │
        │               └────────┬────────┘
        │                        │
        └────────┬───────────────┘
                 │
    ┌────────────▼──────────────┐
    │   Phase 3 融合精排层       │
    ├──────────────────────────┤
    │ 双路并行召回              │
    │ • asyncio异步并发        │
    │ • 超时控制                │
    │ • 结果合并去重            │
    │ • 加权融合（0.7+0.3）     │
    ├──────────────────────────┤
    │ 特征提取（11维）          │
    │ • VectorSimilarity       │
    │ • GraphScore             │
    │ • ExactMatch             │
    │ • QueryCoverage          │
    │ • ...                    │
    ├──────────────────────────┤
    │ 规则打分器                │
    │ • 多特征加权融合          │
    │ • 可配置权重              │
    │ • 可解释性                │
    ├──────────────────────────┤
    │ 结果验证器                │
    │ • 维度兼容性              │
    │ • 时间粒度                │
    │ • 数据新鲜度              │
    │ • 权限验证                │
    └──────────────────────────┘
                 │
    ┌────────────▼──────────────┐
    │      最终结果              │
    │ • Top-K 排序结果          │
    │ • 执行时间统计            │
    │ • 验证状态                │
    └──────────────────────────┘
```

---

## 数据流图

```
用户输入: "最近7天的活跃用户数"
    │
    ▼
┌─────────────────────────────────────┐
│ 1. API层接收请求                    │
│    - 验证参数                       │
│    - 记录开始时间                   │
└────────────┬────────────────────────┘
             │
     ┌───────┴────────┐
     │                │
     ▼                ▼
┌─────────────┐  ┌─────────────┐
│ 向量召回     │  │ 图谱召回     │
│             │  │             │
│ • 向量化    │  │ • 文本匹配  │
│ • Qdrant    │  │ • 域召回    │
│ • Top-50    │  │ • 关系召回  │
└──────┬──────┘  │ • Top-30    │
       │         └──────┬──────┘
       │                │
       └────────┬───────┘
                │
        ┌───────▼──────────┐
        │ 结果合并去重      │
        │ • metric_id去重  │
        │ • 加权融合        │
        └───────┬──────────┘
                │
        ┌───────▼──────────┐
        │ 转换为Candidate   │
        │ • 补充元数据      │
        └───────┬──────────┘
                │
        ┌───────▼──────────┐
        │ 特征提取          │
        │ • 11维特征向量   │
        └───────┬──────────┘
                │
        ┌───────▼──────────┐
        │ 规则打分          │
        │ • 加权求和        │
        │ • 排序            │
        │ • Top-K截断       │
        └───────┬──────────┘
                │
        ┌───────▼──────────┐
        │ 结果验证          │
        │ • 4个验证器      │
        │ • 过滤FAILED     │
        └───────┬──────────┘
                │
        ┌───────▼──────────┐
        │ 格式化响应        │
        │ • 记录执行时间    │
        └───────┬──────────┘
                │
                ▼
        返回JSON响应:
        {
          "query": "...",
          "candidates": [...],
          "total": 5,
          "execution_time": 485.32
        }
```

---

## 模块交互图

```
┌─────────────────────────────────────────────────────────┐
│                    模块依赖关系                         │
└─────────────────────────────────────────────────────────┘

API层 (FastAPI)
    │
    ├──> DualRecall (双路召回)
    │       │
    │       ├──> MetricVectorizer
    │       │       └──> m3e-base模型
    │       │
    │       ├──> QdrantVectorStore
    │       │       └──> Qdrant数据库
    │       │
    │       └──> GraphRecall
    │               ├──> Neo4jClient
    │               └──> Neo4j数据库
    │
    ├──> RuleBasedRanker (精排)
    │       └──> 11个FeatureExtractor
    │
    └──> ValidationPipeline (验证)
            └──> 4个Validator

配置层
    ├──> settings (环境变量)
    │       ├──> QdrantConfig
    │       ├──> VectorizerConfig
    │       └──> Neo4jConfig
    │
    └──> .env文件
```

---

## 时序图：完整查询流程

```
用户                API              DualRecall         向量召回         图谱召回         精排层              验证层
 │                  │                    │                │                │                │                │
 │─POST /search──> │                    │                │                │                │                │
 │                  │                    │                │                │                │                │
 │                  │─async recall─────>│                │                │                │                │
 │                  │                    │                │                │                │                │
 │                  │                    │─vector───────> │                │                │                │
 │                  │                    │                │                │                │                │
 │                  │                    │<─results────── │                │                │                │
 │                  │                    │                │                │                │                │
 │                  │                    │─graph─────────> │                │                │                │
 │                  │                    │                │                │                │                │
 │                  │                    │<─results────── │                │                │                │
 │                  │                    │                │                │                │                │
 │                  │<─merged results────│                │                │                │                │
 │                  │                    │                │                │                │                │
 │                  │─rank───────────────────────────────────>│                │                │
 │                  │                    │                │                │                │
 │                  │<─ranked────────────────────────────────│                │                │
 │                  │                    │                │                │                │
 │                  │─validate───────────────────────────────────────────────>│                │
 │                  │                    │                │                │                │
 │                  │<─validated────────────────────────────────────────────│                │
 │                  │                    │                │                │                │
 │<─JSON response── │                    │                │                │                │
 │                  │                    │                │                │                │
```

---

## 性能优化策略

### 1. 向量检索优化

```
未优化：
  查询 → 向量化 → Qdrant检索 → 返回结果
  100ms    50ms      150ms      20ms
  总计: 320ms

优化后：
  批量向量化 + HNSW索引 + 查询缓存
  20ms       50ms       30ms
  总计: 100ms
```

### 2. 图谱检索优化

```
未优化：
  查询 → Cypher执行 → 遍历所有节点 → 返回
  10ms      200ms         100ms        10ms
  总计: 320ms

优化后：
  索引 + 限制深度 + 结果缓存
  10ms   50ms      20ms
  总计: 80ms
```

### 3. 并行召回优化

```
串行执行：
  向量召回(100ms) → 图谱召回(80ms) → 合并(10ms)
  总计: 190ms

异步并行：
  向量召回(100ms) ╱
  图谱召回(80ms)  ╲ → 合并(10ms)
  总计: 110ms
```

---

## 扩展点设计

### 1. 自定义特征提取器

```python
from src.rerank.features import FeatureExtractor

class MyCustomExtractor(FeatureExtractor):
    def extract(self, candidate, context):
        # 自定义特征计算逻辑
        return feature_value

# 注册到工厂
FeatureExtractorFactory.STANDARD_FEATURES.append(
    MyCustomExtractor()
)
```

### 2. 自定义验证器

```python
from src.validator.validators import Validator

class MyCustomValidator(Validator):
    def validate(self, candidate, context):
        # 自定义验证逻辑
        return ValidationResult(...)

# 添加到流水线
pipeline = ValidationPipeline(
    validators=[..., MyCustomValidator()]
)
```

### 3. 自定义召回策略

```python
from src.recall.graph.recall import GraphRecall

class MyCustomStrategy:
    def recall(self, query, top_k):
        # 自定义召回逻辑
        return results
```

---

## 部署架构

### 开发环境

```
本地机器
  ├── Qdrant (Docker)
  ├── Neo4j (Docker)
  └── FastAPI (uvicorn)
```

### 生产环境

```
负载均衡 (Nginx)
    │
    ├──> API Server 1 (uvicorn)
    ├──> API Server 2 (uvicorn)
    └──> API Server 3 (uvicorn)
         │
    ┌────┴────┐
    │         │
  Qdrant  Neo4j
  集群    集群
```

### 容器化部署

```yaml
# docker-compose.yml
services:
  api:
    image: semantic-query:latest
    ports: ["8000:8000"]
    depends_on: [qdrant, neo4j]

  qdrant:
    image: qdrant/qdrant:latest

  neo4j:
    image: neo4j:latest
```

---

## 监控指标

### 系统指标

- CPU 使用率
- 内存使用量
- 磁盘 I/O
- 网络 I/O

### 业务指标

- QPS (每秒查询数)
- P50/P95/P99 延迟
- 召回率
- 准确率
- 错误率

### 组件指标

- Qdrant 查询延迟
- Neo4j 查询延迟
- 向量化耗时
- 特征提取耗时
- 验证器耗时

---

## 故障排查

### 常见问题

**1. Qdrant连接失败**
```bash
# 检查容器状态
docker ps | grep qdrant

# 查看日志
docker logs qdrant

# 重启容器
docker restart qdrant
```

**2. Neo4j连接超时**
```bash
# 检查连接
bolt://localhost:7687

# 验证认证
NEO4J_AUTH=neo4j/password
```

**3. 模型加载慢**
```python
# 使用延迟加载
vectorizer = MetricVectorizer()
# 模型在首次调用时才加载
```

---

## 文档版本

- **v1.0** (2026-02-04): 初始版本，三个Phase全部完成
