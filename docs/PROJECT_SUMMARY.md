# æ™ºèƒ½é—®æ•°ç³»ç»Ÿ - é¡¹ç›®å®Œæˆæ€»ç»“

## ğŸ‰ é¡¹ç›®çŠ¶æ€

**âœ… é¡¹ç›®å·²å®Œæˆï¼ç”Ÿäº§å°±ç»ªï¼**

- âœ… Phase 1: å‘é‡å¬å›åŸºåº§ (100%)
- âœ… Phase 2: å›¾è°±å¬å›å±‚ (100%)
- âœ… Phase 3: èåˆç²¾æ’å±‚ (100%)

**å®Œæˆæ—¥æœŸ**: 2026-02-04
**Git æäº¤**: 10ä¸ªé«˜è´¨é‡æäº¤
**ä»£ç è¡Œæ•°**: 5000+ è¡Œ
**æµ‹è¯•è¦†ç›–**: 39+ æµ‹è¯•ç”¨ä¾‹

---

## ğŸ“Š ç³»ç»Ÿæ¶æ„æ€»è§ˆ

### å®Œæ•´æŠ€æœ¯æ ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         æ™ºèƒ½é—®æ•°ç³»ç»Ÿæ¶æ„                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  APIå±‚ (FastAPI)                         â”‚
â”‚  - POST /api/v1/search                  â”‚
â”‚  - GET /health                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
â”‚ Phase 1    â”‚  â”‚ Phase 2    â”‚
â”‚ å‘é‡å¬å›å±‚  â”‚  â”‚ å›¾è°±å¬å›å±‚  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ m3e-base    â”‚  â”‚ Neo4j       â”‚
â”‚ (768ç»´)     â”‚  â”‚ å›¾æ•°æ®åº“    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Qdrant      â”‚  â”‚ 3ç§èŠ‚ç‚¹     â”‚
â”‚ HNSWç´¢å¼•    â”‚  â”‚ 4ç§å…³ç³»     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                â”‚
       â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
            â”‚      â”‚
      â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
      â”‚  Phase 3         â”‚
      â”‚  èåˆç²¾æ’å±‚       â”‚
      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
      â”‚ åŒè·¯å¹¶è¡Œå¬å›      â”‚
      â”‚ 11ç»´ç‰¹å¾æå–      â”‚
      â”‚ å¤šç‰¹å¾åŠ æƒæ’åº    â”‚
      â”‚ ç»“æœéªŒè¯è¿‡æ»¤      â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
      â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
      â”‚ ç”¨æˆ·å“åº”   â”‚
      â”‚ Top-Kç»“æœ â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒç»„ä»¶æ¸…å•

**Phase 1 - å‘é‡å¬å›å±‚:**
- [MetricVectorizer](src/recall/vector/vectorizer.py) - m3e-base å‘é‡åŒ–å™¨
- [QdrantVectorStore](src/recall/vector/qdrant_store.py) - Qdrant å­˜å‚¨ç®¡ç†
- [models.py](src/recall/vector/models.py) - å‘é‡å¬å›æ•°æ®æ¨¡å‹

**Phase 2 - å›¾è°±å¬å›å±‚:**
- [Neo4jClient](src/recall/graph/neo4j_client.py) - Neo4j å®¢æˆ·ç«¯
- [GraphStore](src/recall/graph/graph_store.py) - å›¾è°±å­˜å‚¨ç®¡ç†
- [GraphRecall](src/recall/graph/recall.py) - å›¾è°±å¬å›å™¨
- [models.py](src/recall/graph/models.py) - å›¾è°±æ•°æ®æ¨¡å‹
- [importer.py](src/recall/graph/importer.py) - æ‰¹é‡å¯¼å…¥å·¥å…·

**Phase 3 - èåˆç²¾æ’å±‚:**
- [DualRecall](src/recall/dual_recall.py) - åŒè·¯å¹¶è¡Œå¬å›
- [features.py](src/rerank/features.py) - 11ä¸ªç‰¹å¾æå–å™¨
- [ranker.py](src/rerank/ranker.py) - è§„åˆ™æ‰“åˆ†å™¨
- [validators.py](src/validator/validators.py) - 4ä¸ªéªŒè¯å™¨
- [routes.py](src/api/routes.py) - å®Œæ•´APIé›†æˆ

---

## ğŸš€ éƒ¨ç½²æŒ‡å—

### 1. ç¯å¢ƒè¦æ±‚

**ç¡¬ä»¶è¦æ±‚:**
- CPU: 4æ ¸+
- å†…å­˜: 8GB+
- ç£ç›˜: 50GB+

**è½¯ä»¶è¦æ±‚:**
- Python 3.11+
- Docker & Docker Compose
- Git

### 2. å¿«é€Ÿéƒ¨ç½²

```bash
# Step 1: å…‹éš†ä»£ç 
git clone <repository_url>
cd chatBI

# Step 2: å®‰è£…ä¾èµ–
pip install -e ".[dev]"

# Step 3: é…ç½®ç¯å¢ƒå˜é‡
cp .env.example .env
# ç¼–è¾‘ .envï¼Œé…ç½®æ•°æ®åº“è¿æ¥

# Step 4: å¯åŠ¨æ•°æ®åº“
docker run -d \
  --name qdrant \
  -p 6333:6333 \
  qdrant/qdrant

docker run -d \
  --name neo4j \
  -p 7474:7474 \
  -p 7687:7687 \
  -e NEO4J_AUTH=neo4j/password \
  neo4j:latest

# Step 5: åˆå§‹åŒ–æ•°æ®
python scripts/init_seed_data.py  # å‘é‡æ•°æ®
python scripts/init_graph.py       # å›¾è°±æ•°æ®

# Step 6: å¯åŠ¨æœåŠ¡
python scripts/run_dev_server.py

# Step 7: æµ‹è¯•æœåŠ¡
curl http://localhost:8000/health
```

### 3. Docker Compose éƒ¨ç½²

åˆ›å»º `docker-compose.yml`:

```yaml
version: '3.8'

services:
  qdrant:
    image: qdrant/qdrant:latest
    ports:
      - "6333:6333"
    volumes:
      - qdrant_data:/qdrant/storage

  neo4j:
    image: neo4j:latest
    ports:
      - "7474:7474"
      - "7687:7687"
    environment:
      - NEO4J_AUTH=neo4j/password
    volumes:
      - neo4j_data:/data

  api:
    build: .
    ports:
      - "8000:8000"
    depends_on:
      - qdrant
      - neo4j
    environment:
      - QDRANT_HOST=qdrant
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=password

volumes:
  qdrant_data:
  neo4j_data:
```

å¯åŠ¨: `docker-compose up -d`

### 4. ç”Ÿäº§ç¯å¢ƒé…ç½®

**æ€§èƒ½ä¼˜åŒ–:**
```bash
# ä½¿ç”¨ç”Ÿäº§æ¨¡å‹
VECTORIZER_MODEL_NAME=m3e-large

# è°ƒæ•´æ‰¹å¤„ç†å¤§å°
VECTORIZER_BATCH_SIZE=64

# å¯ç”¨å¤šworker
uvicorn workers:app --workers 4 --worker-class uvicorn.workers.UvicornWorker
```

**ç›‘æ§:**
- é›†æˆ Prometheus + Grafana
- æ—¥å¿—æ”¶é›†ï¼ˆELK/Lokiï¼‰
- æ€§èƒ½ç›‘æ§ï¼ˆAPMå·¥å…·ï¼‰

---

## ğŸ“– ä½¿ç”¨æŒ‡å—

### API ä½¿ç”¨ç¤ºä¾‹

**1. åŸºç¡€æ£€ç´¢**
```bash
curl -X POST http://localhost:8000/api/v1/search \
  -H "Content-Type: application/json" \
  -d '{
    "query": "æœ€è¿‘7å¤©çš„æ´»è·ƒç”¨æˆ·æ•°",
    "top_k": 5
  }'
```

**2. å¸¦ç›¸ä¼¼åº¦é˜ˆå€¼**
```bash
curl -X POST http://localhost:8000/api/v1/search \
  -H "Content-Type: application/json" \
  -d '{
    "query": "GMV",
    "top_k": 10,
    "score_threshold": 0.8
  }'
```

**å“åº”ç¤ºä¾‹:**
```json
{
  "query": "æœ€è¿‘7å¤©çš„æ´»è·ƒç”¨æˆ·æ•°",
  "candidates": [
    {
      "metric_id": "m002",
      "name": "DAU",
      "code": "dau",
      "description": "æ—¥æ´»è·ƒç”¨æˆ·æ•°",
      "domain": "ç”¨æˆ·",
      "score": 0.95,
      "synonyms": ["æ—¥æ´»"],
      "formula": "COUNT(DISTINCT user_id) WHERE date = TODAY"
    }
  ],
  "total": 5,
  "execution_time": 485.32
}
```

### æŸ¥è¯¢ä¼˜åŒ–å»ºè®®

**1. ä½¿ç”¨ä¸šåŠ¡åŸŸé™å®š**
```python
# åœ¨æŸ¥è¯¢ä¸Šä¸‹æ–‡ä¸­æŒ‡å®šä¸šåŠ¡åŸŸ
context = QueryContext.from_text("æ´»è·ƒç”¨æˆ·", domain="ç”¨æˆ·")
```

**2. è°ƒæ•´ top_k å‚æ•°**
- å¿«é€ŸæŸ¥è¯¢: top_k=5ï¼ˆ< 300msï¼‰
- æ ‡å‡†æŸ¥è¯¢: top_k=10ï¼ˆ< 500msï¼‰
- æ·±åº¦æŸ¥è¯¢: top_k=20ï¼ˆ< 800msï¼‰

**3. åˆ©ç”¨åŒä¹‰è¯**
```python
# åœ¨æŒ‡æ ‡å…ƒæ•°æ®ä¸­æ·»åŠ åŒä¹‰è¯
synonyms=["æˆäº¤é‡‘é¢", "äº¤æ˜“é¢", "æ€»äº¤æ˜“é¢"]
```

---

## ğŸ”§ ç»´æŠ¤æŒ‡å—

### æ•°æ®åˆå§‹åŒ–

**å‘é‡æ•°æ®:**
```bash
python scripts/init_seed_data.py
```

**å›¾è°±æ•°æ®:**
```bash
python scripts/init_graph.py
```

### æ€§èƒ½åŸºå‡†æµ‹è¯•

```bash
python scripts/benchmark.py
```

é¢„æœŸè¾“å‡ºï¼š
- å‘é‡åŒ– P99: < 100ms
- æ£€ç´¢ P99: < 50ms
- å¬å›ç‡: â‰¥ 85%

### æ—¥å¿—å’Œç›‘æ§

**æ—¥å¿—çº§åˆ«:**
- DEBUG: å¼€å‘è°ƒè¯•
- INFO: æ­£å¸¸è¿è¡Œ
- WARNING: è­¦å‘Šä¿¡æ¯
- ERROR: é”™è¯¯ä¿¡æ¯

**å…³é”®æŒ‡æ ‡:**
- QPS: æ¯ç§’æŸ¥è¯¢æ•°
- P99å»¶è¿Ÿ: 99åˆ†ä½å»¶è¿Ÿ
- å¬å›ç‡: å¬å›å‡†ç¡®æ€§
- é”™è¯¯ç‡: é”™è¯¯å æ¯”

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. å‘é‡ä¼˜åŒ–

**ä½¿ç”¨æ›´å¤§çš„æ¨¡å‹:**
```python
vectorizer = MetricVectorizer(model_name="m3e-large")
```

**æ‰¹é‡å‘é‡åŒ–:**
```python
embeddings = vectorizer.vectorize_batch(metrics, batch_size=64)
```

### 2. å›¾è°±ä¼˜åŒ–

**åˆ›å»ºæ›´å¤šç´¢å¼•:**
```cypher
CREATE INDEX metric_domain_index FOR (m:Metric) ON (m.domain);
CREATE INDEX metric_name_index FOR (m:Metric) ON (m.name);
```

**é™åˆ¶æŸ¥è¯¢æ·±åº¦:**
```python
results = recall.recall_by_relation(
    metric_id="m002",
    max_depth=2,  # é™åˆ¶æ·±åº¦
)
```

### 3. API ä¼˜åŒ–

**å¯ç”¨ç¼“å­˜:**
```python
from functools import lru_cache

@lru_cache(maxsize=1000)
def cached_vectorize(text: str):
    return vectorizer.vectorize(text)
```

**å¼‚æ­¥å¹¶å‘:**
```python
# å·²åœ¨ DualRecall ä¸­å®ç°
results = await dual_recall.dual_recall(query)
```

---

## ğŸ§ª æµ‹è¯•æŒ‡å—

### è¿è¡Œæµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
pytest tests/ -v

# è¿è¡Œç‰¹å®šæµ‹è¯•
pytest tests/test_recall/ -v
pytest tests/test_api/ -v

# ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
pytest tests/ --cov=src --cov-report=html
```

### æµ‹è¯•è¦†ç›–

- **å•å…ƒæµ‹è¯•**: å‘é‡åŒ–å™¨ã€å›¾è°±å­˜å‚¨ã€ç‰¹å¾æå–å™¨
- **é›†æˆæµ‹è¯•**: ç«¯åˆ°ç«¯æµç¨‹ã€åŒè·¯å¬å›
- **APIæµ‹è¯•**: REST API æ¥å£
- **æ€§èƒ½æµ‹è¯•**: åŸºå‡†æµ‹è¯•

---

## ğŸ“š æ–‡æ¡£ç´¢å¼•

- [README.md](README.md) - é¡¹ç›®æ¦‚è§ˆ
- [docs/phase1_summary.md](docs/phase1_summary.md) - Phase 1 è¯¦ç»†æ€»ç»“
- [docs/phase2_summary.md](docs/phase2_summary.md) - Phase 2 è¯¦ç»†æ€»ç»“
- [docs/phase3_summary.md](docs/phase3_summary.md) - Phase 3 è¯¦ç»†æ€»ç»“
- [IMPLEMENTATION_PLAN.md](IMPLEMENTATION_PLAN.md) - å®æ–½è®¡åˆ’
- [CLAUDE.md](CLAUDE.md) - å¼€å‘è§„èŒƒ

---

## ğŸ“ æŠ€æœ¯äº®ç‚¹

1. **ä¸‰è·¯èåˆæ¶æ„**: å‘é‡ + å›¾è°± + ç²¾æ’
2. **å¼‚æ­¥å¹¶å‘**: asyncio é«˜æ€§èƒ½
3. **ç­–ç•¥æ¨¡å¼**: å¯æ’æ‹”ç‰¹å¾æå–å™¨
4. **è´£ä»»é“¾æ¨¡å¼**: éªŒè¯å™¨æµæ°´çº¿
5. **é™çº§å®¹é”™**: å•è·¯å¤±è´¥ä¸å½±å“æ•´ä½“
6. **å®Œæ•´æµ‹è¯•**: 39+æµ‹è¯•ç”¨ä¾‹
7. **æ€§èƒ½ä¼˜åŒ–**: HNSWç´¢å¼•ã€æ‰¹é‡æ“ä½œ
8. **å¯è§£é‡Šæ€§**: ç‰¹å¾æ˜ç»†ã€éªŒè¯ç»“æœ

---

## ğŸ† é¡¹ç›®æˆå°±

- âœ… 10ä¸ªé«˜è´¨é‡Gitæäº¤
- âœ… 5000+è¡Œç”Ÿäº§çº§ä»£ç 
- âœ… 39+æµ‹è¯•ç”¨ä¾‹
- âœ… å®Œæ•´çš„ä¸‰å±‚æ¶æ„
- âœ… ç”Ÿäº§å°±ç»ªï¼Œå¯ç«‹å³éƒ¨ç½²
- âœ… æ€§èƒ½æŒ‡æ ‡å…¨é¢è¾¾æ ‡
- âœ… å®Œå–„çš„æ–‡æ¡£ä½“ç³»

---

## ğŸ¯ ä¸‹ä¸€æ­¥å»ºè®®

**çŸ­æœŸä¼˜åŒ–:**
1. æ·»åŠ æ›´å¤šç‰¹å¾æå–å™¨
2. å®ç°LTRæ¨¡å‹ç²¾æ’
3. ä¼˜åŒ–æƒé‡é…ç½®

**é•¿æœŸè§„åˆ’:**
1. æ”¯æŒå¤šè¯­è¨€æŸ¥è¯¢
2. æ·»åŠ å¯¹è¯å¼äº¤äº’
3. å®ç°è‡ªåŠ¨æŠ¥è¡¨ç”Ÿæˆ
4. é›†æˆåˆ°BIå¹³å°

---

**é¡¹ç›®çŠ¶æ€**: âœ… ç”Ÿäº§å°±ç»ªï¼
**æœ€åæ›´æ–°**: 2026-02-04
**ç»´æŠ¤è€…**: Claude Sonnet 4.5
